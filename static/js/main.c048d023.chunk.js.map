{"version":3,"sources":["components/Context/DiagramManager.ts","components/Diagram/DiagramCanvas.tsx","hooks/useDrag.ts","components/NodeTypes/NodeTypeHeader.tsx","components/NodeTypes/NodeTypeInput.tsx","components/NodeTypes/NodeTypeSelect.tsx","components/NodeTypes/NodeTypeButton.tsx","components/NodeTypes/config.ts","utils/index.ts","components/Diagram/Port.tsx","components/Diagram/DiagramNodePorts.tsx","components/Diagram/DiagramNodeActionButtons.tsx","utils/onfire.ts","utils/eventBus.ts","components/Diagram/DiagramNode.tsx","components/Diagram/NodesCanvas.tsx","utils/makeSvgPath.ts","components/Diagram/Link.tsx","components/Diagram/LinksCanvas.tsx","components/Diagram/Segment.tsx","hooks/useEventCallback.ts","hooks/useEventBus.ts","components/Diagram/MarkLine.tsx","components/Diagram/SelectModel.tsx","utils/autoLayout.ts","components/Diagram/index.tsx","hooks/useHistory.ts","components/Toolbar/ShortcutsPanel.tsx","static/icon-click.png","static/icon-wheel.png","static/icon-move.png","components/Toolbar/Toolbar.tsx","components/NodeList/NodeListItem.tsx","components/NodeList/NodeList.tsx","hooks/useEventListener.ts","constant/index.ts","utils/creatMockData.ts","DiagramPanel.tsx","constant/hotKeys.ts","reportWebVitals.ts","index.tsx"],"names":["defaultValue","canvasRef","portRefs","nodeRefs","scale","DiagramManagerContext","createContext","DiagramManagerProvider","Provider","useScale","useContext","DiagramCanvas","React","memo","props","children","transform","translateX","translateY","useState","canvasDom","setBoundingBox","useRef","useEffect","current","contextValue","useMemo","id","className","ref","style","value","displayName","DISABLED_DRAG_TAGS","defaultOptions","throttleBy","getEventCoordinates","event","clientX","clientY","CreateCallbackRef","useCallback","callback","useDrag","options","targetRef","dragStartHandlerRef","dragHandlerRef","dragEndHandlerRef","isDragging","start","end","offset","info","onDragStart","targetTagName","target","tagName","contains","includes","onDrag","throttle","onDragEnd","_onDragStart","e","_onDrag","_onDragEnd","addEventListener","document","removeEventListener","NodeTypeHeader","icon","label","createElement","Panel","Collapse","text","NodeTypeInput","onChange","nodesConfig","nodeTypeInput","inputValue","placeholder","defaultActiveKey","header","NodeTypeSelect","nodeTypeSelect","width","selectValue","Option","disabled","NodeTypeButton","nodeTypeButton","buttonList","map","button","index","NodeTypes","component","AppleOutlined","WindowsOutlined","GithubOutlined","nodesList","Object","entries","key","type","createNode","nodeType","coordinate","nodeData","uuidv4","coordinates","inputs","outputs","data","isLinked","buttonData","item","copyNode","originNode","cloneDeep","distance","offsetCoordinates","forEach","output","calculatingCoordinates","referenceDom","referenceDomRect","getBoundingClientRect","x","y","findEventTargetParentNodeId","dom","nodeId","isNodeDom","classList","parentElement","findIndexById","nodes","findIndex","node","getNodeStyle","nodeDom","offsetHeight","height","left","offsetLeft","top","offsetTop","right","bottom","batchUpdateCoordinates","nextCoordinates","activeNodeIds","nextNodes","offsetCoordinate","activeNodeId","some","nextIndex","oneNodeDelete","currentNode","nodeOutputs","port","nodeInputs","splice","links","filter","link","input","checkIsFocusInPanel","panelDom","activeElement","Port","onDragNewSegment","onSegmentFail","onSegmentConnect","onShowSelectModel","onPortMount","startCoordinatesRef","classnames","stopImmediatePropagation","stopPropagation","canvasX","canvasY","to","targetDom","targetNode","getElementById","DiagramNodePorts","DiagramNodeActionButtons","onNodeDelete","onNodeCopy","handleNodeDelete","handleNodeCopy","onClick","CopyOutlined","DeleteOutlined","OnFire","es","eventName","cb","once","this","push","on","listeners","l","length","params","i","apply","undefined","fire","ver","EVENT_NODE_MOVING","EVENT_NODE_MOVE_END","EVENT_AUTO_LAYOUT","EE","DiagramNode","nodeInfo","onNodeValueChange","onNodePositionChange","onNodeMount","onAddHistory","onToggleActiveNodeId","isActive","nodeItemProps","nextNodeData","dragStartPoint","nextCoords","eventBus","emit","isEqual","handleClick","shiftKey","active","Math","floor","NodesCanvas","others","roundPoint","point","getCubicBezierPath","from","points","controlPointForStart","controlPointForEnd","join","getAdvancedCubicBezierPath","midX","midY","makeSvgPath","startPoint","endPoint","roundedStart","roundedEnd","Link","onDelete","svgRef","abs","computedLinkSvgInfo","path","handleDelete","handleMouseOver","add","handleMouseOut","remove","pointerEvents","d","onDoubleClick","onMouseOver","onMouseOut","prev","next","findPortCoordinate","nodeCoordinates","ports","entityId","j","portDom","offsetWidth","computedLinkCoordinate","nodeEl","inputRes","outputRes","LinksCanvas","result","res","startCoordinates","endCoordinates","Segment","segment","r","cx","cy","useEventCallback","fn","useLayoutEffect","useEventBus","dep","off","isNearly","dragValue","targetValue","MarkLine","handleHideLine","childNodes","markLine","line","visibility","handleMove","curNodeDom","curNodeStyle","Array","querySelectorAll","nodeStyle","conditions","lineNode","dragShift","lineShift","keys","condition","newCoordinates","data-mark-line-id","SelectModel","prop","position","handleItemClick","currentTarget","dataset","ReactDOM","createPortal","data-type","body","checkPortIsNodeSon","findPortFatherNodeId","autoLayout","row","extendNodes","column","recursionLookup","linkEndId","baseColumn","catchNodeIds","find","outputHasLinkNum","findLink","linkInput","checkIsStartLink","portFatherNodeId","nextNodeIds","sort","a","b","LAYOUT_BASIC_COORDINATE","groupRowMap","groupBy","groupRows","values","currentTop","aRow","rowIndex","cell","cellIndex","currentAfterPreRowMaxHeightList","preCell","rowMaxHeight","maxBy","newNodes","omit","toFixed2","num","Number","toFixed","autoLayoutAnimation","originNodes","futureNodes","animationFn","stepCount","Promise","resolve","reject","animationCount","nodeWithStep","oldNodes","findNextNode","xStep","yStep","computedAnimationStep","requestAnimationFrame","step","error","Diagram","setSegment","selectModelPosition","setSelectModelPosition","startPortIdRef","isAutoLayoutRef","handleNodePositionChange","handleNodeValueChange","nextNodeValue","handleAddHistory","newNode","nextValue","onPortRegister","portId","portEl","onNodeRegister","nextLinks","onLinkDelete","handleSelectModelChange","setTimeout","handleAutoLayout","then","finally","initialState","past","present","future","reducer","state","action","newPresent","previous","slice","newFuture","initialPresent","CTRL_OR_CMD","test","navigator","userAgent","hotkeyList","hotKeys","ShortcutsPanel","keyItem","keyIndex","Fragment","src","alt","Toolbar","undo","redo","canUndo","canRedo","trigger","placement","content","overlayClassName","NodeListItem","handleDragStart","dataTransfer","setData","draggable","NodeList","useEventListener","handler","element","savedHandler","eventListener","SCALE_STEP","DRAG_STATE","CURSOR_MAP","fill","DiagramPanel","useReducer","dispatch","set","setWithHistory","addAHistory","clear","useHistory","handleUndo","handleRedo","setTransform","selectionArea","setSelectionArea","dragState","setDragState","mouseDownStartPosition","setActiveNodeIds","panelRef","selectionAreaRef","batchCopyNodesRef","batchCopyActiveNodeIdsRef","panelRect","handleThrottleSetTransform","handleChange","newValue","notAddHistory","handleDrop","window","getData","handleDrag","preventDefault","handleWheel","wheelDelta","offsetX","offsetY","handleMouseDown","relativeX","relativeY","firstChild","checkMouseDownTargetIsDrawPanel","handleThrottleSetSelectionArea","min","selectAreaDom","v","dom1","dom2","rect1","rect2","maxX","max","maxY","minX","minY","collideCheck","handleMouseUp","handleMouseMove","handleSpaceHotKey","handleSelectAll","handleBatchDelete","handleBatchCopy","handleBatchPaste","nodeIndex","handleToggleActiveNodeId","nextActiveNodeIds","cursor","hideSelectionArea","selectionAreaStyled","useHotkeys","keyup","keydown","onDrop","onDragEnter","onDragOver","tabIndex","hidden","reportWebVitals","onPerfEntry","Function","getCLS","getFID","getFCP","getLCP","getTTFB","render","StrictMode"],"mappings":"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","file":"static/js/main.c048d023.chunk.js","sourcesContent":["import { createContext, useContext } from 'react'\r\nimport { IPortRefs, INodeRefs } from '../../types'\r\n\r\nexport interface DiagramManager {\r\n  canvasRef: HTMLDivElement | null\r\n  portRefs: IPortRefs\r\n  nodeRefs: INodeRefs\r\n  scale: number\r\n}\r\n\r\nconst defaultValue: DiagramManager = { canvasRef: null, portRefs: {}, nodeRefs: {}, scale: 1 }\r\n\r\nconst DiagramManagerContext = createContext(defaultValue)\r\n\r\nexport const DiagramManagerProvider = DiagramManagerContext.Provider\r\n\r\n// export DiagramManager Context\r\nexport const useDiagramManager = (): DiagramManager => {\r\n  return useContext(DiagramManagerContext)\r\n}\r\n\r\n// export DiagramCanvas Context\r\nexport const useDiagramCanvas = (): HTMLDivElement | null => {\r\n  const { canvasRef } = useContext(DiagramManagerContext)\r\n  return canvasRef\r\n}\r\n\r\n// return  DiagramNod dom 节点\r\nexport const useDiagramNodeRefs = (): INodeRefs => {\r\n  const { nodeRefs } = useContext(DiagramManagerContext)\r\n  return nodeRefs\r\n}\r\n\r\n// return  DiagramNodePorts ports 节点\r\nexport const usePortRefs = (): IPortRefs => {\r\n  const { portRefs } = useContext(DiagramManagerContext)\r\n  return portRefs\r\n}\r\n\r\n// return scale\r\nexport const useScale = (): number => {\r\n  const { scale } = useContext(DiagramManagerContext)\r\n  return scale\r\n}\r\n","import React, { useEffect, useMemo, useRef, useState } from 'react'\r\nimport { DiagramManagerProvider } from '../Context/DiagramManager'\r\nimport { IPortRefs, INodeRefs, ITransform } from '../../types'\r\n\r\ninterface DiagramCanvasProps {\r\n  portRefs: IPortRefs\r\n  nodeRefs: INodeRefs\r\n  transform: ITransform\r\n}\r\n\r\nexport const DiagramCanvas: React.FC<DiagramCanvasProps> = React.memo((props) => {\r\n  const { children, portRefs, nodeRefs, transform } = props\r\n  const { scale, translateX, translateY } = transform\r\n\r\n  const [canvasDom, setBoundingBox] = useState<HTMLDivElement | null>(null)\r\n  const canvasRef = useRef<HTMLDivElement>(null)\r\n\r\n  // 储存 canvas dom\r\n  useEffect(() => {\r\n    setBoundingBox(canvasRef.current)\r\n  }, [])\r\n\r\n  const contextValue = useMemo(\r\n    () => ({\r\n      canvasRef: canvasDom,\r\n      portRefs,\r\n      nodeRefs,\r\n      scale,\r\n    }),\r\n    [canvasDom, portRefs, nodeRefs, scale]\r\n  )\r\n\r\n  return (\r\n    <div\r\n      id=\"diagram-canvas\"\r\n      className=\"diagram-canvas\"\r\n      ref={canvasRef}\r\n      // style={{ transform: `translate(${translate.x}px, ${translate.y}px) scale(${scale})` }}\r\n      style={{ transform: `matrix(${scale},0,0,${scale},${translateX},${translateY})` }}\r\n    >\r\n      <DiagramManagerProvider value={contextValue}>{children}</DiagramManagerProvider>\r\n    </div>\r\n  )\r\n})\r\n\r\nDiagramCanvas.displayName = 'DiagramCanvas'\r\n","import { throttle } from 'lodash-es'\r\nimport { useRef, useCallback, useEffect } from 'react'\r\nimport { ICoordinateType } from '../types'\r\n\r\nconst DISABLED_DRAG_TAGS = ['INPUT', 'TEXTAREA']\r\n\r\ninterface DefaultOptions {\r\n  ref: React.RefObject<any> | null\r\n  throttleBy: number\r\n}\r\n\r\ninterface InfoType {\r\n  isDragging: boolean\r\n  start: ICoordinateType\r\n  end: ICoordinateType\r\n  offset: ICoordinateType\r\n}\r\n\r\nconst defaultOptions: DefaultOptions = {\r\n  ref: null,\r\n  throttleBy: 0,\r\n}\r\n\r\nconst getEventCoordinates = (event: MouseEvent): ICoordinateType => [event.clientX, event.clientY]\r\n\r\n/**\r\n * 创建一个持久回调引用\r\n * @param ref\r\n * @returns {Function}\r\n */\r\nconst CreateCallbackRef = (ref: any) =>\r\n  useCallback(\r\n    (callback) => {\r\n      if (!ref.current || callback !== ref.current) {\r\n        ref.current = callback\r\n      }\r\n    },\r\n    [ref]\r\n  )\r\n\r\nconst useDrag = (options = defaultOptions) => {\r\n  const targetRef = options.ref\r\n  const dragStartHandlerRef = useRef<any>()\r\n  const dragHandlerRef = useRef<any>()\r\n  const dragEndHandlerRef = useRef<any>()\r\n  const { current: info } = useRef<InfoType>({ isDragging: false, start: [0, 0], end: [0, 0], offset: [0, 0] })\r\n\r\n  const onDragStart = useCallback(\r\n    (event) => {\r\n      const targetTagName = event.target.tagName\r\n      if (\r\n        !info.isDragging &&\r\n        targetRef?.current.contains(event.target) &&\r\n        !DISABLED_DRAG_TAGS.includes(targetTagName)\r\n      ) {\r\n        info.isDragging = true\r\n        info.end = [0, 0]\r\n        info.offset = [0, 0]\r\n        info.start = getEventCoordinates(event)\r\n\r\n        if (dragStartHandlerRef.current) {\r\n          dragStartHandlerRef.current(event, { ...info })\r\n        }\r\n      }\r\n    },\r\n    [targetRef, info, dragStartHandlerRef]\r\n  )\r\n\r\n  // eslint-disable-next-line\r\n  const onDrag = useCallback(\r\n    throttle((event) => {\r\n      if (info.isDragging) {\r\n        info.offset = [event.clientX - info.start[0], event.clientY - info.start[1]]\r\n\r\n        if (dragHandlerRef.current) {\r\n          dragHandlerRef.current(event, { ...info })\r\n        }\r\n      }\r\n    }, options.throttleBy),\r\n    [targetRef, info, dragHandlerRef]\r\n  )\r\n\r\n  const onDragEnd = useCallback(\r\n    (event) => {\r\n      if (info.isDragging) {\r\n        info.isDragging = false\r\n        info.end = getEventCoordinates(event)\r\n\r\n        if (dragEndHandlerRef.current) {\r\n          dragEndHandlerRef.current(event, { ...info })\r\n        }\r\n      }\r\n    },\r\n    [info, dragEndHandlerRef]\r\n  )\r\n\r\n  useEffect(() => {\r\n    const _onDragStart = (e: any) => onDragStart(e)\r\n    const _onDrag = (e: any) => onDrag(e)\r\n    const _onDragEnd = (e: any) => onDragEnd(e)\r\n\r\n    if (targetRef?.current) {\r\n      targetRef.current.addEventListener('mousedown', _onDragStart)\r\n      document.addEventListener('mousemove', _onDrag)\r\n      document.addEventListener('mouseup', _onDragEnd)\r\n    }\r\n\r\n    return () => {\r\n      if (targetRef?.current) {\r\n        // eslint-disable-next-line\r\n        targetRef.current.removeEventListener('mousedown', _onDragStart)\r\n        document.removeEventListener('mousemove', _onDrag)\r\n        document.removeEventListener('mouseup', _onDragEnd)\r\n      }\r\n    }\r\n  }, [targetRef, onDragStart, onDrag, onDragEnd])\r\n\r\n  return {\r\n    ref: targetRef,\r\n    onDragStart: CreateCallbackRef(dragStartHandlerRef),\r\n    onDrag: CreateCallbackRef(dragHandlerRef),\r\n    onDragEnd: CreateCallbackRef(dragEndHandlerRef),\r\n  }\r\n}\r\n\r\nexport default useDrag\r\n","import React from 'react'\r\n\r\nimport './style.scss'\r\n\r\n\r\nexport interface NodeTypeHeaderProps {\r\n  icon: React.FC\r\n  label: string;\r\n}\r\n\r\n\r\nexport const NodeTypeHeader: React.FC<NodeTypeHeaderProps> = (props) => {\r\n  const {icon, label} = props\r\n\r\n  return (\r\n    <h4 className='node-header'>\r\n      {icon && <div className='node-header-icon'>\r\n        {React.createElement(icon)}\r\n      </div>}\r\n      <div className='node-header-text'>{label}</div>\r\n    </h4>\r\n  )\r\n}\r\n\r\nNodeTypeHeader.displayName = 'NodeTypeHeader'\r\n","import React from 'react'\r\nimport { Input, Collapse } from 'antd'\r\nimport './style.scss'\r\nimport { INodeItemProps } from '../../types'\r\nimport { NodeTypeHeader } from './NodeTypeHeader'\r\nimport { nodesConfig } from './config'\r\nconst { Panel } = Collapse\r\n\r\nconst text = `A dog is a type`\r\nexport interface NodeTypeInputProps extends INodeItemProps<any> {}\r\n\r\nexport const NodeTypeInput: React.FC<NodeTypeInputProps> = (props) => {\r\n  const { value, onChange } = props\r\n  const handleInputChange = (e: any) => {\r\n    onChange({\r\n      ...value,\r\n      inputValue: e.target.value,\r\n    })\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <NodeTypeHeader icon={nodesConfig.nodeTypeInput.icon} label={nodesConfig.nodeTypeInput.label} />\r\n      <Input value={value.inputValue} onChange={handleInputChange} placeholder=\"Basic usage\" />\r\n      <Collapse defaultActiveKey={['1']}>\r\n        <Panel header=\"This is panel header 1\" key=\"1\">\r\n          <p>{text}</p>\r\n        </Panel>\r\n        <Panel header=\"This is panel header 2\" key=\"2\">\r\n          <p>{text}</p>\r\n        </Panel>\r\n        <Panel header=\"This is panel header 3\" key=\"3\">\r\n          <p>{text}</p>\r\n        </Panel>\r\n      </Collapse>\r\n    </>\r\n  )\r\n}\r\n\r\nNodeTypeInput.displayName = 'NodeTypeInput'\r\n","import React from 'react'\r\nimport { Select } from 'antd'\r\n\r\nimport './style.scss'\r\nimport { INodeItemProps } from '../../types'\r\nimport { NodeTypeHeader } from './NodeTypeHeader'\r\nimport { nodesConfig } from './config'\r\n\r\n\r\nexport interface NodeTypeSelectProps extends INodeItemProps<any> {\r\n\r\n}\r\n\r\n\r\nexport const NodeTypeSelect: React.FC<NodeTypeSelectProps> = ({value, onChange}) => {\r\n\r\n  function handleChange(e: string) {\r\n    onChange({...value, selectValue: e})\r\n  }\r\n\r\n\r\n  return (\r\n    <>\r\n      <NodeTypeHeader icon={nodesConfig.nodeTypeSelect.icon} label={nodesConfig.nodeTypeSelect.label}/>\r\n      <Select style={{width: 120}} value={value.selectValue} onChange={handleChange}>\r\n        <Select.Option value=\"jack\">Jack</Select.Option>\r\n        <Select.Option value=\"lucy\">Lucy</Select.Option>\r\n        <Select.Option value=\"disabled\" disabled>\r\n          Disabled\r\n        </Select.Option>\r\n        <Select.Option value=\"Yiminghe\">yiminghe</Select.Option>\r\n      </Select>\r\n    </>\r\n  )\r\n}\r\n\r\nNodeTypeSelect.displayName = 'NodeTypeSelect'\r\n","import React from 'react'\r\nimport { Button } from 'antd'\r\n\r\nimport './style.scss'\r\nimport { INodeItemProps } from '../../types'\r\nimport { NodeTypeHeader } from './NodeTypeHeader'\r\nimport { nodesConfig } from './config'\r\n\r\nexport interface NodeTypeButtonProps extends INodeItemProps<any> {\r\n}\r\n\r\nexport const NodeTypeButton: React.FC<NodeTypeButtonProps> = (props) => {\r\n  const {value} = props\r\n  // const handleInputChange = (e: any) => {\r\n  //   onChange({\r\n  //     ...value,\r\n  //     inputValue: e.target.value,\r\n  //   })\r\n  // }\r\n\r\n  return (\r\n    <>\r\n      <NodeTypeHeader icon={nodesConfig.nodeTypeButton.icon} label={nodesConfig.nodeTypeButton.label}/>\r\n      {value.buttonList.map((button: any, index: number) => (\r\n        <div key={index}>\r\n          <Button style={{width: '100%'}}>{button.text as string}</Button>\r\n        </div>\r\n      ))}\r\n    </>\r\n  )\r\n}\r\n\r\nNodeTypeButton.displayName = 'NodeTypeButton'\r\n","import { NodeTypeInput } from './NodeTypeInput'\r\nimport { NodeTypeSelect } from './NodeTypeSelect'\r\nimport { NodeTypeButton } from './NodeTypeButton'\r\nimport { AppleOutlined, WindowsOutlined, GithubOutlined } from '@ant-design/icons'\r\nimport { v4 as uuidv4 } from 'uuid'\r\nimport { ICoordinateType, INodeType, NodeTypeEnum } from '../../types'\r\nimport { cloneDeep } from 'lodash-es'\r\n\r\nexport enum NodeTypes {\r\n  nodeTypeInput = 'nodeTypeInput',\r\n  nodeTypeSelect = 'nodeTypeSelect',\r\n  nodeTypeButton = 'nodeTypeButton'\r\n}\r\n\r\nexport const nodesConfig = {\r\n  [NodeTypes.nodeTypeInput]: {\r\n    component: NodeTypeInput,\r\n    label: 'Input 节点',\r\n    icon: AppleOutlined\r\n  },\r\n  [NodeTypes.nodeTypeSelect]: {\r\n    component: NodeTypeSelect,\r\n    label: 'Select 节点',\r\n    icon: WindowsOutlined\r\n  },\r\n  [NodeTypes.nodeTypeButton]: {\r\n    component: NodeTypeButton,\r\n    label: 'Button 节点',\r\n    icon: GithubOutlined\r\n  }\r\n}\r\n\r\nexport const nodesList = Object.entries(nodesConfig).map(([key, value]) => {\r\n  return {\r\n    ...value,\r\n    type: key\r\n  }\r\n})\r\n\r\nexport const createNode = (nodeType: NodeTypeEnum, coordinate: ICoordinateType): INodeType => {\r\n  let nodeData: INodeType = {\r\n    id: uuidv4(),\r\n    coordinates: coordinate,\r\n    type: nodeType,\r\n    inputs: [],\r\n    outputs: [],\r\n    data: {}\r\n  }\r\n  switch (nodeType) {\r\n    case NodeTypes.nodeTypeInput:\r\n      nodeData = {\r\n        ...nodeData,\r\n        outputs: [{id: uuidv4(), isLinked: false}],\r\n        data: {\r\n          inputValue: 'test'\r\n        }\r\n      }\r\n\r\n      break\r\n    case NodeTypes.nodeTypeSelect:\r\n      nodeData = {\r\n        ...nodeData,\r\n        outputs: [{id: uuidv4(), isLinked: false}],\r\n        data: {\r\n          inputValue: ''\r\n        }\r\n      }\r\n      break\r\n    case NodeTypes.nodeTypeButton:\r\n      const buttonData = {\r\n        buttonList: [\r\n          {text: 'button-1', id: uuidv4()},\r\n          {text: 'button-2', id: uuidv4()}\r\n        ]\r\n      }\r\n      const outputs = buttonData.buttonList.map((item: any) => ({\r\n        id: item.id,\r\n        isLinked: false\r\n      }))\r\n      nodeData = {\r\n        ...nodeData,\r\n        outputs: outputs,\r\n        data: buttonData\r\n      }\r\n      break\r\n  }\r\n\r\n  return nodeData\r\n}\r\n\r\nconst offsetCoordinates = (coordinates: ICoordinateType, distance = 0): ICoordinateType => [coordinates[0] + distance, coordinates[1] + distance]\r\n\r\nexport const copyNode = (originNode: INodeType): INodeType => {\r\n  const nodeData = cloneDeep(originNode)\r\n  nodeData.id = uuidv4()\r\n  nodeData.coordinates = offsetCoordinates(nodeData.coordinates, 20)\r\n  switch (nodeData.type) {\r\n    case NodeTypes.nodeTypeInput:\r\n      nodeData.outputs.forEach((output) => {\r\n        output.id = uuidv4()\r\n        output.isLinked = false\r\n      })\r\n      break\r\n    case NodeTypes.nodeTypeSelect:\r\n      nodeData.outputs.forEach((output) => {\r\n        output.id = uuidv4()\r\n        output.isLinked = false\r\n      })\r\n      break\r\n    case NodeTypes.nodeTypeButton:\r\n      nodeData.data.buttonList.forEach((item: any) => {\r\n        item.id = uuidv4()\r\n      })\r\n      nodeData.outputs = nodeData.data.buttonList.map((item: any) => ({\r\n        id: item.id,\r\n        isLinked: false\r\n      }))\r\n\r\n      break\r\n  }\r\n\r\n  return nodeData\r\n}\r\n","import { ICoordinateType, IDiagramType, INodeStyle, INodeType } from '../types'\r\n\r\n// 计算 鼠标事件 相对在 参照物(diagram 画布)内的坐标\r\nexport const calculatingCoordinates = (\r\n  event: MouseEvent,\r\n  referenceDom: HTMLDivElement | HTMLElement | null,\r\n  scale: number\r\n): ICoordinateType => {\r\n  const referenceDomRect = referenceDom?.getBoundingClientRect() || { x: 0, y: 0 }\r\n  return [(event.clientX - referenceDomRect.x) / scale, (event.clientY - referenceDomRect.y) / scale]\r\n}\r\n\r\nexport const findEventTargetParentNodeId = (dom: HTMLElement | null): null | string => {\r\n  if (!dom) {\r\n    return null\r\n  }\r\n  const nodeId = dom.id\r\n  const isNodeDom = dom.classList.contains('diagram-node')\r\n  if (nodeId && isNodeDom) {\r\n    return nodeId\r\n  }\r\n  if (isNodeDom) {\r\n    return null\r\n  }\r\n  return findEventTargetParentNodeId(dom.parentElement)\r\n}\r\n\r\n// 检测鼠标按下的时候是否是点击在画布空白区域\r\nexport const checkMouseDownTargetIsDrawPanel = (event: any, panelDom: HTMLElement | null) =>\r\n  event.target === panelDom || event.target === panelDom?.firstChild\r\n\r\n// 碰撞检测 检测两个div 是否相交\r\nexport const collideCheck = (dom1: HTMLElement | null, dom2: HTMLElement | null) => {\r\n  if (dom1 && dom2) {\r\n    const rect1 = dom1.getBoundingClientRect()\r\n    const rect2 = dom2.getBoundingClientRect()\r\n    const maxX: number = Math.max(rect1.x + rect1.width, rect2.x + rect2.width)\r\n    const maxY: number = Math.max(rect1.y + rect1.height, rect2.y + rect2.height)\r\n    const minX: number = Math.min(rect1.x, rect2.x)\r\n    const minY: number = Math.min(rect1.y, rect2.y)\r\n    return maxX - minX <= rect1.width + rect2.width && maxY - minY <= rect1.height + rect2.height\r\n  }\r\n  return false\r\n}\r\n\r\nexport const findIndexById = (nodeId: string, nodes: INodeType[]) => nodes.findIndex((node) => node.id === nodeId)\r\n\r\nexport const getNodeStyle = (nodeDom: Element): INodeStyle => {\r\n  const dom = nodeDom as HTMLElement\r\n  const width = dom.offsetHeight\r\n  const height = dom.offsetHeight\r\n  return {\r\n    width,\r\n    height,\r\n    left: dom.offsetLeft,\r\n    top: dom.offsetTop,\r\n    right: dom.offsetLeft + width,\r\n    bottom: dom.offsetTop + height,\r\n  }\r\n}\r\n\r\nexport const batchUpdateCoordinates = (\r\n  nodeId: string,\r\n  nextCoordinates: ICoordinateType,\r\n  nodes: INodeType[],\r\n  activeNodeIds: string[]\r\n): INodeType[] => {\r\n  const nextNodes = [...nodes]\r\n\r\n  const index = findIndexById(nodeId, nextNodes)\r\n\r\n  const offsetCoordinate = {\r\n    xOffset: nextCoordinates[0] - nodes[index].coordinates[0],\r\n    yOffset: nextCoordinates[1] - nodes[index].coordinates[1],\r\n  }\r\n  // update activeNodeIds\r\n  activeNodeIds.forEach((activeNodeId) => {\r\n    nextNodes.some((node, nextIndex) => {\r\n      if (node.id === activeNodeId) {\r\n        nextNodes[nextIndex] = {\r\n          ...nextNodes[nextIndex],\r\n          coordinates: [node.coordinates[0] + offsetCoordinate.xOffset, node.coordinates[1] + offsetCoordinate.yOffset],\r\n        }\r\n        return true\r\n      } else {\r\n        return false\r\n      }\r\n    })\r\n  })\r\n  // update self\r\n  nextNodes[index] = { ...nextNodes[index], coordinates: nextCoordinates }\r\n\r\n  return nextNodes\r\n}\r\n\r\nexport const oneNodeDelete = (value: IDiagramType, nodeId: string): IDiagramType => {\r\n  const nextNodes = [...value.nodes]\r\n  const index = findIndexById(nodeId, nextNodes)\r\n  const currentNode = value.nodes[index]\r\n  const nodeOutputs = currentNode.outputs.map((port) => port.id)\r\n  const nodeInputs = currentNode.inputs.map((port) => port.id)\r\n  nextNodes.splice(index, 1)\r\n  // 删除和节点相关的所有线\r\n  let nextLinks = value.links.filter((link) => {\r\n    return (\r\n      !nodeInputs.includes(link.output) &&\r\n      !nodeOutputs.includes(link.input) &&\r\n      link.input !== nodeId &&\r\n      link.output !== nodeId\r\n    )\r\n  })\r\n  return { links: nextLinks, nodes: nextNodes }\r\n}\r\n\r\nexport const checkIsFocusInPanel = (panelDom: HTMLElement | null) => document.activeElement === panelDom\r\n\r\n/*\r\n * 画出 link 的 svg 矩形容器，和位置，并且重新计算在 矩形容器内的起点和终点\r\n * */\r\nexport const computedLinkSvgInfo = (input: ICoordinateType, output: ICoordinateType) => {\r\n  const width = Math.abs(output[0] - input[0])\r\n  const height = Math.abs(output[1] - input[1])\r\n  const MIN_SIZE = 1\r\n  let left = 0\r\n  let top = 0\r\n  const start = { x: 0, y: 0 }\r\n  const end = { x: 0, y: 0 }\r\n\r\n  // x 轴防方向\r\n  if (output[0] > input[0]) {\r\n    left = input[0]\r\n\r\n    start.x = 0\r\n    end.x = width\r\n  } else {\r\n    left = output[0]\r\n\r\n    start.x = width\r\n    end.x = 0\r\n  }\r\n\r\n  // y 轴防方向\r\n  if (output[1] > input[1]) {\r\n    top = input[1]\r\n\r\n    start.y = 0\r\n    end.y = height\r\n  } else {\r\n    top = output[1]\r\n\r\n    start.y = height\r\n    end.y = 0\r\n  }\r\n\r\n  return {\r\n    width: Math.floor(width) || MIN_SIZE,\r\n    height: Math.floor(height) || MIN_SIZE,\r\n    left: Math.floor(left),\r\n    top: Math.floor(top),\r\n    start: [start.x, start.y],\r\n    end: [end.x, end.y],\r\n  }\r\n}\r\n","import React, { useEffect, useRef } from 'react'\r\nimport useDrag from '../../hooks/useDrag'\r\nimport { ICoordinateType, IPointType } from '../../types'\r\nimport { calculatingCoordinates, findEventTargetParentNodeId } from '../../utils'\r\nimport { useDiagramCanvas, useScale } from '../Context/DiagramManager'\r\nimport classnames from 'classnames'\r\n\r\ninterface PortProps extends IPointType {\r\n  nodeId: string\r\n  type: 'input' | 'output'\r\n  index: number\r\n  onDragNewSegment: (id: string, from: ICoordinateType, to: ICoordinateType) => void\r\n  onSegmentFail: (id: string, type: string) => void\r\n  onSegmentConnect: (id: string, targetPort: string) => void\r\n  onShowSelectModel: (event: MouseEvent, input: string) => void\r\n  onPortMount: (id: string, dom: HTMLElement) => void\r\n}\r\n\r\nexport const Port: React.FC<PortProps> = React.memo((props) => {\r\n  const {\r\n    id,\r\n    isLinked,\r\n    index,\r\n    nodeId,\r\n    onDragNewSegment,\r\n    onSegmentFail,\r\n    onSegmentConnect,\r\n    onShowSelectModel,\r\n    onPortMount,\r\n    type,\r\n  } = props\r\n  const canvasRef = useDiagramCanvas()\r\n  const scale = useScale()\r\n  const ref: any = useRef<React.RefObject<HTMLElement>>(null)\r\n  const startCoordinatesRef = useRef<ICoordinateType | undefined>()\r\n\r\n  const className = classnames('diagram-port', {\r\n    'type-input': type === 'input',\r\n    'type-output': type === 'output',\r\n    'is-linked': isLinked,\r\n  })\r\n\r\n  const { onDragStart, onDrag, onDragEnd } = useDrag({ ref, throttleBy: 15 })\r\n\r\n  onDragStart((event: MouseEvent) => {\r\n    event.stopImmediatePropagation()\r\n    event.stopPropagation()\r\n    if (canvasRef && ref.current) {\r\n      const { x: canvasX, y: canvasY } = canvasRef.getBoundingClientRect()\r\n      const { x, y, width, height } = ref.current.getBoundingClientRect()\r\n      startCoordinatesRef.current = [(x - canvasX + width / 2) / scale, (y - canvasY + height / 2) / scale]\r\n    }\r\n  })\r\n\r\n  onDrag((event: MouseEvent) => {\r\n    if (startCoordinatesRef.current) {\r\n      event.stopImmediatePropagation()\r\n      event.stopPropagation()\r\n      const to: ICoordinateType = calculatingCoordinates(event, canvasRef, scale)\r\n\r\n      onDragNewSegment(id, startCoordinatesRef.current, to)\r\n    }\r\n  })\r\n\r\n  onDragEnd((event: MouseEvent) => {\r\n    const targetDom = event.target as HTMLElement\r\n    const targetIsPort = targetDom.classList.contains('diagram-port')\r\n    // 如果目标元素是 port 区域 并且不是起点port\r\n    if (targetIsPort && targetDom.id !== id) {\r\n      onSegmentConnect(id, targetDom.id)\r\n      return\r\n    }\r\n\r\n    // 如果目标元素是 node 区域 并非不是起点node\r\n    const targetNode = findEventTargetParentNodeId(event.target as HTMLElement)\r\n    if (targetNode && targetNode !== nodeId) {\r\n      onSegmentConnect(id, targetNode)\r\n      return\r\n    }\r\n    const panelDom = document.getElementById('diagram-panel')\r\n    if (panelDom && panelDom.contains(event.target as HTMLElement)) {\r\n      onShowSelectModel(event, id)\r\n    }\r\n    // 否则在空白区域松开 释放\r\n    onSegmentFail && onSegmentFail(id, type)\r\n  })\r\n\r\n  useEffect(() => {\r\n    onPortMount(id, ref.current)\r\n  }, [id, onPortMount])\r\n\r\n  return (\r\n    <div className={className} id={id} ref={ref} style={{ top: index === 0 ? '45%' : `calc(45% + ${index * 18}px)` }} />\r\n  )\r\n})\r\n","import React from 'react'\r\nimport { ICoordinateType, IPointType } from '../../types'\r\nimport { Port } from './Port'\r\n\r\nexport interface DiagramNodePortsProps {\r\n  inputs: IPointType[]\r\n  nodeId: string\r\n  type: 'input' | 'output'\r\n  onPortMount: (id: string, dom: HTMLElement) => void\r\n  onDragNewSegment: (id: string, from: ICoordinateType, to: ICoordinateType) => void\r\n  onSegmentFail: (id: string, type: string) => void\r\n  onSegmentConnect: (id: string, targetPort: string) => void\r\n  onShowSelectModel: (event: MouseEvent, input: string) => void\r\n}\r\n\r\nexport const DiagramNodePorts: React.FC<DiagramNodePortsProps> = (props) => {\r\n  const {\r\n    inputs,\r\n    onPortMount,\r\n    onDragNewSegment,\r\n    onSegmentFail,\r\n    onSegmentConnect,\r\n    onShowSelectModel,\r\n    nodeId,\r\n    type,\r\n  } = props\r\n  return (\r\n    <>\r\n      {inputs.map((port, index) => (\r\n        <Port\r\n          onPortMount={onPortMount}\r\n          onDragNewSegment={onDragNewSegment}\r\n          onSegmentFail={onSegmentFail}\r\n          onShowSelectModel={onShowSelectModel}\r\n          onSegmentConnect={onSegmentConnect}\r\n          type={type}\r\n          key={port.id}\r\n          id={port.id}\r\n          index={index}\r\n          isLinked={port.isLinked}\r\n          nodeId={nodeId}\r\n        />\r\n      ))}\r\n    </>\r\n  )\r\n}\r\n\r\nDiagramNodePorts.displayName = 'DiagramNodePorts'\r\n","import React, { useCallback } from 'react'\r\nimport { Button } from 'antd'\r\nimport { DeleteOutlined, CopyOutlined } from '@ant-design/icons'\r\n\r\n\r\n// import { DeleteOutlined } from '@ant-design/icons'\r\n\r\n\r\nexport interface DiagramNodeActionButtonsProps {\r\n  id: string\r\n  onNodeCopy: (nodeId: string) => void\r\n  onNodeDelete: (nodeId: string) => void\r\n}\r\n\r\nexport const DiagramNodeActionButtons: React.FC<DiagramNodeActionButtonsProps> = (props) => {\r\n  const {onNodeDelete, onNodeCopy, id} = props\r\n\r\n  const handleNodeDelete = useCallback(() => {\r\n    onNodeDelete(id)\r\n  }, [id, onNodeDelete])\r\n\r\n  const handleNodeCopy = useCallback(() => {\r\n    onNodeCopy(id)\r\n  }, [id, onNodeCopy])\r\n\r\n  return (\r\n    <div className='diagram-node-action'>\r\n      <Button onClick={handleNodeCopy} icon={<CopyOutlined/>}/>\r\n      <Button onClick={handleNodeDelete} icon={<DeleteOutlined/>}/>\r\n    </div>\r\n  )\r\n}\r\n\r\nDiagramNodeActionButtons.displayName = 'DiagramNodeActionButtons'\r\n","export interface Listener {\r\n  cb: Function\r\n  once: boolean\r\n}\r\n\r\nexport interface EventsType {\r\n  [eventName: string]: Listener[]\r\n}\r\n\r\n/**\r\n * const ee = new OnFire();\r\n *\r\n * ee.on('click', (...values) => {});\r\n *\r\n * ee.on('mouseover', (...values) => {});\r\n *\r\n * ee.emit('click', 1, 2, 3);\r\n * ee.fire('mouseover', {}); // same with emit\r\n *\r\n * ee.off();\r\n */\r\nexport default class OnFire {\r\n  static ver = '__VERSION__'\r\n\r\n  // 所有事件的监听器\r\n  es: EventsType = {}\r\n\r\n  on(eventName: string, cb: Function, once: boolean = false) {\r\n    if (!this.es[eventName]) {\r\n      this.es[eventName] = []\r\n    }\r\n\r\n    this.es[eventName].push({\r\n      cb,\r\n      once,\r\n    })\r\n  }\r\n\r\n  once(eventName: string, cb: Function) {\r\n    this.on(eventName, cb, true)\r\n  }\r\n\r\n  fire(eventName: string, ...params: any[]) {\r\n    const listeners = this.es[eventName] || []\r\n\r\n    let l = listeners.length\r\n\r\n    for (let i = 0; i < l; i++) {\r\n      const { cb, once } = listeners[i]\r\n\r\n      cb.apply(this, params)\r\n\r\n      if (once) {\r\n        listeners.splice(i, 1)\r\n        i--\r\n        l--\r\n      }\r\n    }\r\n  }\r\n\r\n  off(eventName?: string, cb?: Function) {\r\n    // clean all\r\n    if (eventName === undefined) {\r\n      this.es = {}\r\n    } else {\r\n      if (cb === undefined) {\r\n        // clean the eventName's listeners\r\n        delete this.es[eventName]\r\n      } else {\r\n        const listeners = this.es[eventName] || []\r\n        // clean the event and listener\r\n        let l = listeners.length\r\n        for (let i = 0; i < l; i++) {\r\n          if (listeners[i].cb === cb) {\r\n            listeners.splice(i, 1)\r\n            i--\r\n            l--\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // cname of fire\r\n  emit(eventName: string, ...params: any[]) {\r\n    this.fire(eventName, ...params)\r\n  }\r\n}\r\n","import EE from './onfire'\r\n\r\nexport const EVENT_NODE_MOVING = 'NODE_MOVING'\r\nexport const EVENT_NODE_MOVE_END = 'NODE_MOVE_END'\r\n\r\nexport const EVENT_AUTO_LAYOUT = 'AUTO_LAYOUT'\r\n\r\nexport default new EE()\r\n","import React, { useCallback, useEffect, useMemo, useRef } from 'react'\r\nimport useDrag from '../../hooks/useDrag'\r\nimport { INodeType, ICoordinateType } from '../../types'\r\nimport { nodesConfig } from '../NodeTypes/config'\r\nimport { isEqual } from 'lodash-es'\r\nimport { useScale } from '../Context/DiagramManager'\r\nimport { DiagramNodePorts } from './DiagramNodePorts'\r\nimport classnames from 'classnames'\r\nimport { DiagramNodeActionButtons } from './DiagramNodeActionButtons'\r\nimport eventBus, { EVENT_NODE_MOVE_END, EVENT_NODE_MOVING } from '../../utils/eventBus'\r\n\r\ninterface DiagramNodeProps {\r\n  nodeInfo: INodeType\r\n  onNodePositionChange: (id: string, nextCoords: ICoordinateType) => void\r\n  onNodeValueChange: (id: string, nextNodeValue: any) => void\r\n  onAddHistory: (id: string, nextCoords: ICoordinateType) => void\r\n  onNodeMount: (id: string, dom: HTMLDivElement) => void\r\n  onPortMount: (id: string, dom: HTMLElement) => void\r\n  onDragNewSegment: (id: string, from: ICoordinateType, to: ICoordinateType) => void\r\n  onSegmentFail: (id: string, type: string) => void\r\n  onSegmentConnect: (id: string, targetPort: string) => void\r\n  onShowSelectModel: (event: MouseEvent, input: string) => void\r\n  onNodeDelete: (nodeId: string) => void\r\n  onNodeCopy: (nodeId: string) => void\r\n  onToggleActiveNodeId: (nodeId: string) => void\r\n  isActive: boolean\r\n}\r\n\r\nexport const DiagramNode: React.FC<DiagramNodeProps> = React.memo((props) => {\r\n  const {\r\n    nodeInfo,\r\n    onNodeValueChange,\r\n    onNodePositionChange,\r\n    onPortMount,\r\n    onDragNewSegment,\r\n    onNodeMount,\r\n    onSegmentFail,\r\n    onSegmentConnect,\r\n    onShowSelectModel,\r\n    onAddHistory,\r\n    onToggleActiveNodeId,\r\n    isActive,\r\n    onNodeDelete,\r\n    onNodeCopy,\r\n  } = props\r\n\r\n  const { id, coordinates, type, inputs, data, outputs } = nodeInfo\r\n\r\n  const scale = useScale()\r\n\r\n  // nodeType\r\n  const component = nodesConfig[type]?.component\r\n\r\n  const handleNodeDataChange = (nextNodeData: any) => {\r\n    onNodeValueChange(id, nextNodeData)\r\n  }\r\n\r\n  // 传给子组件点 Props\r\n  const nodeItemProps = {\r\n    value: data,\r\n    onChange: handleNodeDataChange,\r\n  }\r\n\r\n  const ref: any = useRef(null)\r\n\r\n  const { onDragStart, onDrag, onDragEnd } = useDrag({ throttleBy: 14, ref }) // get the drag n drop methods\r\n  const dragStartPoint = useRef(coordinates) // keeps the drag start point in a persistent reference\r\n\r\n  // when drag starts, save the starting coordinates into the `dragStartPoint` ref\r\n  onDragStart(() => {\r\n    dragStartPoint.current = coordinates\r\n  })\r\n\r\n  // whilst dragging calculates the next coordinates and perform the `onNodePositionChange` callback\r\n  onDrag((event: MouseEvent, info: any) => {\r\n    event.stopImmediatePropagation()\r\n    event.stopPropagation()\r\n    const nextCoords: ICoordinateType = [\r\n      dragStartPoint.current[0] + info.offset[0] / scale,\r\n      dragStartPoint.current[1] + info.offset[1] / scale,\r\n    ]\r\n\r\n    onNodePositionChange(id, nextCoords)\r\n    eventBus.emit(EVENT_NODE_MOVING, id, nextCoords)\r\n  })\r\n\r\n  onDragEnd((event: MouseEvent) => {\r\n    if (!isEqual(dragStartPoint.current, coordinates)) {\r\n      onAddHistory(id, dragStartPoint.current)\r\n    }\r\n    eventBus.emit(EVENT_NODE_MOVE_END)\r\n  })\r\n\r\n  const handleClick = useCallback(\r\n    (event: React.MouseEvent<HTMLDivElement, MouseEvent>) => {\r\n      if (event.shiftKey) {\r\n        onToggleActiveNodeId(id)\r\n      }\r\n    },\r\n    [id, onToggleActiveNodeId]\r\n  )\r\n\r\n  const options = { nodeId: id, onPortMount, onDragNewSegment, onSegmentFail, onSegmentConnect, onShowSelectModel }\r\n\r\n  useEffect(() => {\r\n    onNodeMount(id, ref.current)\r\n  }, [id, onNodeMount])\r\n\r\n  const className = useMemo(() => {\r\n    return classnames('diagram-node', {\r\n      active: isActive,\r\n    })\r\n  }, [isActive])\r\n\r\n  return (\r\n    <div\r\n      id={id}\r\n      className={className}\r\n      ref={ref}\r\n      style={{ left: Math.floor(coordinates[0]), top: Math.floor(coordinates[1]) }}\r\n      onClick={handleClick}\r\n    >\r\n      {component && React.createElement(component, nodeItemProps)}\r\n      <DiagramNodePorts inputs={inputs} {...options} type=\"input\" />\r\n      <DiagramNodePorts inputs={outputs} {...options} type=\"output\" />\r\n      <DiagramNodeActionButtons id={id} onNodeDelete={onNodeDelete} onNodeCopy={onNodeCopy} />\r\n    </div>\r\n  )\r\n})\r\n\r\nDiagramNode.displayName = 'DiagramNode'\r\n","import React from 'react'\r\nimport { DiagramNode } from './DiagramNode'\r\nimport { ICoordinateType, INodeType } from '../../types'\r\n\r\ninterface NodesCanvasProps {\r\n  nodes: INodeType[]\r\n  onNodeMount: (id: string, dom: HTMLDivElement) => void\r\n  onPortMount: (id: string, dom: HTMLElement) => void\r\n  onDragNewSegment: (id: string, from: ICoordinateType, to: ICoordinateType) => void\r\n  onSegmentFail: (id: string, type: string) => void\r\n  onSegmentConnect: (id: string, targetPort: string) => void\r\n  onShowSelectModel: (event: MouseEvent, input: string) => void\r\n  activeNodeIds: string[]\r\n  onNodePositionChange: (id: string, nextCoords: ICoordinateType) => void\r\n  onNodeValueChange: (id: string, nextNodeValue: any) => void\r\n  onAddHistory: (id: string, nextCoords: ICoordinateType) => void\r\n  onNodeDelete: (nodeId: string) => void\r\n  onNodeCopy: (nodeId: string) => void\r\n  onToggleActiveNodeId: (nodeId: string) => void\r\n}\r\n\r\nexport const NodesCanvas: React.FC<NodesCanvasProps> = React.memo((props) => {\r\n  const {nodes, activeNodeIds, ...others} = props\r\n\r\n  return (\r\n    <>\r\n      {nodes.map((node) => (\r\n        <DiagramNode isActive={activeNodeIds.includes(node.id)} nodeInfo={node} key={node.id} {...others} />\r\n      ))}\r\n    </>\r\n  )\r\n})\r\n\r\nNodesCanvas.displayName = 'NodesCanvas'\r\n","import { ICoordinateType } from '../types'\r\n\r\nconst roundPoint = (point: ICoordinateType): ICoordinateType => [Math.floor(point[0]), Math.floor(point[1])]\r\n\r\n// 贝塞尔曲线算法\r\nconst makeBezierCurve = (from: ICoordinateType, to: ICoordinateType) => {\r\n  if (to[0] >= from[0]) {\r\n    return getCubicBezierPath(from, to)\r\n  } else {\r\n    return getAdvancedCubicBezierPath(from, to)\r\n  }\r\n}\r\n\r\nconst getPointsString = (points: ICoordinateType[]) => {\r\n  return points.map((item) => `${item[0]},${item[1]}`).join(' ')\r\n}\r\n\r\n// 正向 贝塞尔曲线\r\nconst getCubicBezierPath = (from: ICoordinateType, to: ICoordinateType) => {\r\n  const controlPointForStart: ICoordinateType = [(to[0] + from[0]) / 2, from[1]]\r\n  const controlPointForEnd: ICoordinateType = [(to[0] + from[0]) / 2, to[1]]\r\n\r\n  return `M ${from[0]},${from[1]} C ${getPointsString([controlPointForStart, controlPointForEnd])} ${to[0]},${to[1]}`\r\n}\r\n\r\n// 反向 贝塞尔曲线\r\nconst getAdvancedCubicBezierPath = (from: ICoordinateType, to: ICoordinateType) => {\r\n  const midX = (from[0] + to[0]) / 2\r\n  const midY = (from[1] + to[1]) / 2\r\n\r\n  return `M${from[0]},${from[1]} ${from[0] + 20},${from[1]} C ${from[0] + 100},${from[1]} ${from[0] + 130},${\r\n    (midY + from[1]) / 2\r\n  }  ${midX},${midY} C ${midX},${midY} ${to[0] - 130},${(midY + to[1]) / 2} ${to[0] - 2},${to[1]} M ${to[0] - 2},${\r\n    to[1]\r\n  } ${to[0]},${to[1]}`\r\n}\r\n\r\n/**\r\n * 生成连点之间的贝塞尔曲线\r\n */\r\nconst makeSvgPath = (startPoint?: ICoordinateType, endPoint?: ICoordinateType) => {\r\n  if (!startPoint || !endPoint) return ''\r\n  const roundedStart = roundPoint(startPoint)\r\n  const roundedEnd = roundPoint(endPoint)\r\n\r\n  // const start = `${roundedStart[0]}, ${roundedStart[1]}`\r\n  // const end = `${roundedEnd[0]}, ${roundedEnd[1]}`\r\n\r\n  // 生成 直线\r\n  // return `M ${start}, ${end}`\r\n\r\n  // 生成 曲线\r\n  return makeBezierCurve(roundedStart, roundedEnd)\r\n}\r\n\r\nexport default makeSvgPath\r\n","import React, { useCallback, useMemo, useRef } from 'react'\r\nimport makeSvgPath from '../../utils/makeSvgPath'\r\nimport { ICoordinateType, ILinkType } from '../../types'\r\nimport { isEqual } from 'lodash-es'\r\nimport { computedLinkSvgInfo } from '../../utils'\r\n\r\ninterface LinkProps {\r\n  input: ICoordinateType\r\n  output: ICoordinateType\r\n  link: ILinkType\r\n  onDelete: (link: ILinkType) => void\r\n}\r\n\r\nexport const Link: React.FC<LinkProps> = React.memo(\r\n  (props) => {\r\n    const { input, output, link, onDelete } = props\r\n    const svgRef = useRef<SVGSVGElement>(null)\r\n\r\n    /*\r\n     * 画出 link 的 svg 矩形容器，和位置，并且重新计算在 矩形容器内的起点和终点\r\n     * */\r\n    const { width, height, left, top, start, end } = useMemo(() => computedLinkSvgInfo(input, output), [input, output])\r\n\r\n    /*\r\n     * 根据两点坐标生成 svg path 路径\r\n     * */\r\n    const path = useMemo(() => makeSvgPath(start as ICoordinateType, end as ICoordinateType), [start, end])\r\n\r\n    const handleDelete = useCallback(() => {\r\n      onDelete(link)\r\n    }, [onDelete, link])\r\n\r\n    const handleMouseOver = useCallback(() => {\r\n      svgRef.current?.classList.add('hover')\r\n    }, [])\r\n\r\n    const handleMouseOut = useCallback(() => {\r\n      svgRef.current?.classList.remove('hover')\r\n    }, [])\r\n\r\n    return (\r\n      <svg\r\n        ref={svgRef}\r\n        className={'diagram-link'}\r\n        style={{ left, top }}\r\n        width={width}\r\n        height={height}\r\n        pointerEvents=\"none\"\r\n      >\r\n        <path d={path} className=\"bi-link-path\" />\r\n        <path\r\n          d={path}\r\n          className=\"bi-link-ghost\"\r\n          onDoubleClick={handleDelete}\r\n          onMouseOver={handleMouseOver}\r\n          onMouseOut={handleMouseOut}\r\n        />\r\n      </svg>\r\n    )\r\n  },\r\n  (prev, next) => {\r\n    /*\r\n     *  memo 默认是浅比较 只比较 props 第一层\r\n     *  由于 props 上面 的 input output 等属性在外层每次会重新创建 导致浅层 比较地址 永远等于 false ，使得组件每次都会render 导致memo无效\r\n     * 所以使用 isEqual 进行值的比较 进行优化\r\n     */\r\n    return isEqual(prev, next)\r\n  }\r\n)\r\n\r\nLink.displayName = 'Link'\r\n","import React, { useMemo } from 'react'\r\nimport { Link } from './Link'\r\nimport { ILinkType, INodeType, ICoordinateType, IPortRefs, INodeRefs, IPointType } from '../../types'\r\nimport { useDiagramManager } from '../Context/DiagramManager'\r\n\r\ninterface LinkCanvasProps {\r\n  nodes: INodeType[]\r\n  links: ILinkType[]\r\n  onDelete: (link: ILinkType) => void\r\n}\r\n\r\n/*\r\n * link 起点终点 数据类型\r\n * */\r\nexport interface EntityPutType {\r\n  startCoordinates: ICoordinateType\r\n  endCoordinates: ICoordinateType\r\n  link: ILinkType\r\n}\r\n\r\nconst findPortCoordinate = (\r\n  nodeCoordinates: ICoordinateType,\r\n  ports: IPointType[],\r\n  entityId: string,\r\n  portRefs: IPortRefs\r\n): ICoordinateType | null => {\r\n  for (let j = 0; j < ports.length; j++) {\r\n    const input = ports[j]\r\n    if (input.id === entityId) {\r\n      const portDom = portRefs[entityId]\r\n      if (!portDom) return null\r\n      return [\r\n        nodeCoordinates[0] + portDom.offsetLeft + portDom.offsetWidth,\r\n        nodeCoordinates[1] + portDom.offsetTop + portDom.offsetHeight / 2,\r\n      ]\r\n    }\r\n  }\r\n  return null\r\n}\r\n\r\n/*\r\n * 计算 link 起点终点坐标\r\n * 1. 如果找到 id 是 node 类型线，实际坐标为 x 为该 node 的 left 值，y坐标为该node 的 top + node高度的一半\r\n * 2. 如果找到 id 是 port 类型线，实际坐标为 x 为该 port 的 父元素 node 的 left + 点相对 node 的偏移量 +点的宽度的一半，y 轴坐标同理\r\n * */\r\nconst computedLinkCoordinate = (\r\n  nodes: INodeType[],\r\n  entityId: string,\r\n  nodeRefs: INodeRefs,\r\n  portRefs: IPortRefs,\r\n  canvasRef: HTMLDivElement | null\r\n): ICoordinateType | null => {\r\n  for (let i = 0; i < nodes.length; i++) {\r\n    const node = nodes[i]\r\n    // 如果 id 是 nodeId\r\n    if (node.id === entityId) {\r\n      const nodeEl = nodeRefs[entityId]\r\n      if (!nodeEl) return null\r\n      return [node.coordinates[0], node.coordinates[1] + nodeEl.offsetHeight / 2]\r\n    } else {\r\n      const inputRes = findPortCoordinate(node.coordinates, node.inputs, entityId, portRefs)\r\n      if (inputRes) return inputRes\r\n\r\n      const outputRes = findPortCoordinate(node.coordinates, node.outputs, entityId, portRefs)\r\n      if (outputRes) return outputRes\r\n    }\r\n  }\r\n  return null\r\n}\r\n\r\nexport const LinksCanvas: React.FC<LinkCanvasProps> = React.memo((props) => {\r\n  const { nodes, onDelete, links } = props\r\n\r\n  const { canvasRef, portRefs, nodeRefs } = useDiagramManager()\r\n\r\n  const result = useMemo(() => {\r\n    const res: EntityPutType[] = []\r\n\r\n    links.forEach((link) => {\r\n      const { input, output } = link\r\n      const startCoordinates = computedLinkCoordinate(nodes, input, nodeRefs, portRefs, canvasRef)\r\n      const endCoordinates = computedLinkCoordinate(nodes, output, nodeRefs, portRefs, canvasRef)\r\n      if (startCoordinates && endCoordinates) {\r\n        res.push({\r\n          link,\r\n          startCoordinates,\r\n          endCoordinates,\r\n        })\r\n      }\r\n    })\r\n    return res\r\n  }, [nodes, links, nodeRefs, portRefs, canvasRef])\r\n\r\n  return (\r\n    <>\r\n      {result.map((item) => (\r\n        <Link\r\n          link={item.link}\r\n          input={item.startCoordinates}\r\n          output={item.endCoordinates}\r\n          onDelete={onDelete}\r\n          key={`${item.link.input}-${item.link.output}`}\r\n        />\r\n      ))}\r\n    </>\r\n  )\r\n})\r\nLinksCanvas.displayName = 'LinksCanvas'\r\n","import React, { useMemo } from 'react'\r\nimport makeSvgPath from '../../utils/makeSvgPath'\r\nimport { ISegmentType } from '../../types'\r\n\r\nexport interface SegmentProps {\r\n  segment: ISegmentType\r\n}\r\n\r\nexport const Segment: React.FC<SegmentProps> = React.memo(({segment}) => {\r\n  const {from, to, id} = segment\r\n  const path = useMemo(() => makeSvgPath(from, to), [from, to])\r\n\r\n  return (\r\n    <svg className=\"diagram-segment-canvas\">\r\n      <g className=\"diagram-segment-link\" id={id}>\r\n        <path d={path}/>\r\n        <circle r=\"5\" cx={to[0]} cy={to[1]}/>\r\n      </g>\r\n    </svg>\r\n  )\r\n})\r\n\r\nSegment.displayName = 'Segment'\r\n\r\n\r\n","import { useLayoutEffect, useMemo, useRef } from 'react'\r\n\r\ntype Fn<ARGS extends any[], R> = (...args: ARGS) => R\r\nconst useEventCallback = <A extends any[], R>(fn: Fn<A, R>): Fn<A, R> => {\r\n  let ref = useRef(fn)\r\n  useLayoutEffect(() => {\r\n    ref.current = fn\r\n  })\r\n  return useMemo(\r\n    () => (...args) => {\r\n      const { current } = ref\r\n      return current(...args)\r\n    },\r\n    []\r\n  )\r\n}\r\nexport default useEventCallback\r\n","import { useEffect } from 'react'\r\nimport eventBus from '../utils/eventBus'\r\n\r\ninterface UseEventType {\r\n  type: string\r\n  onChange: any\r\n}\r\nconst useEventBus = ({ type, onChange }: UseEventType, dep = []) => {\r\n  useEffect(() => {\r\n    eventBus.on(type, onChange)\r\n    return () => {\r\n      eventBus.off(type, onChange)\r\n    }\r\n  }, [type, onChange, dep])\r\n}\r\nexport default useEventBus\r\n","import { isEqual } from 'lodash-es'\r\nimport React, { useCallback, useRef } from 'react'\r\nimport useEventBus from '../../hooks/useEventBus'\r\nimport { ICoordinateType } from '../../types'\r\nimport { EVENT_NODE_MOVE_END, EVENT_NODE_MOVING } from '../../utils/eventBus'\r\n\r\nexport interface MarkLineProps {\r\n  onNodePositionChange: (id: string, nextCoords: ICoordinateType) => void\r\n}\r\n\r\nconst getNodeStyle = (nodeDom: any) => {\r\n  const dom = nodeDom as HTMLElement\r\n  const width = dom.offsetWidth\r\n  const height = dom.offsetHeight\r\n  return {\r\n    width,\r\n    height,\r\n    left: dom.offsetLeft,\r\n    top: dom.offsetTop,\r\n    right: dom.offsetLeft + width,\r\n    bottom: dom.offsetTop + height,\r\n  }\r\n}\r\n\r\nconst DIFF = 3\r\nconst isNearly = (dragValue: number, targetValue: number) => Math.abs(dragValue - targetValue) <= DIFF\r\n\r\nexport const MarkLine: React.FC<MarkLineProps> = React.memo(({ onNodePositionChange }) => {\r\n  const ref = useRef<HTMLDivElement>(null)\r\n\r\n  const handleHideLine = useCallback(() => {\r\n    if (ref.current) {\r\n      ref.current.childNodes.forEach((markLine) => {\r\n        const line = markLine as HTMLElement\r\n        if (line.style.visibility === 'visible') {\r\n          line.style.visibility = 'hidden'\r\n        }\r\n      })\r\n    }\r\n  }, [ref])\r\n\r\n  const handleMove = useCallback(\r\n    (nodeId: string, coordinates: ICoordinateType) => {\r\n      handleHideLine()\r\n\r\n      const curNodeDom = document.getElementById(nodeId)\r\n      if (!curNodeDom) return\r\n\r\n      const curNodeStyle = getNodeStyle(curNodeDom)\r\n\r\n      const nodes = Array.from(document.querySelectorAll('.diagram-node'))\r\n      nodes.forEach((node) => {\r\n        if (nodeId !== node.id) {\r\n          const nodeStyle = getNodeStyle(node)\r\n          const { top, left, bottom, right } = nodeStyle\r\n          const conditions: any = {\r\n            top: [\r\n              {\r\n                isNearly: isNearly(curNodeStyle.top, top),\r\n                lineNode: ref.current?.childNodes[0],\r\n                line: 'x-top',\r\n                dragShift: top,\r\n                lineShift: top,\r\n              },\r\n              {\r\n                isNearly: isNearly(curNodeStyle.bottom, top),\r\n                lineNode: ref.current?.childNodes[0],\r\n                line: 'x-top',\r\n                dragShift: top - curNodeStyle.height,\r\n                lineShift: top,\r\n              },\r\n              {\r\n                isNearly: isNearly(curNodeStyle.top, bottom),\r\n                lineNode: ref.current?.childNodes[1],\r\n                line: 'x-bottom',\r\n                dragShift: bottom,\r\n                lineShift: bottom,\r\n              },\r\n              {\r\n                isNearly: isNearly(curNodeStyle.bottom, bottom),\r\n                lineNode: ref.current?.childNodes[1],\r\n                line: 'x-bottom',\r\n                dragShift: bottom - curNodeStyle.height,\r\n                lineShift: bottom,\r\n              },\r\n            ],\r\n            left: [\r\n              {\r\n                isNearly: isNearly(curNodeStyle.left, left),\r\n                lineNode: ref.current?.childNodes[2],\r\n                line: 'y-left',\r\n                dragShift: left,\r\n                lineShift: left,\r\n              },\r\n              {\r\n                isNearly: isNearly(curNodeStyle.right, left),\r\n                lineNode: ref.current?.childNodes[2],\r\n                line: 'y-left',\r\n                dragShift: left - curNodeStyle.width,\r\n                lineShift: left,\r\n              },\r\n              {\r\n                isNearly: isNearly(curNodeStyle.left, right),\r\n                lineNode: ref.current?.childNodes[3],\r\n                line: 'y-right',\r\n                dragShift: right,\r\n                lineShift: right,\r\n              },\r\n              {\r\n                isNearly: isNearly(curNodeStyle.right, right),\r\n                lineNode: ref.current?.childNodes[3],\r\n                line: 'y-right',\r\n                dragShift: right - curNodeStyle.width,\r\n                lineShift: right,\r\n              },\r\n            ],\r\n          }\r\n\r\n          Object.keys(conditions).forEach((key: string) => {\r\n            conditions[key].forEach((condition: any) => {\r\n              if (condition.isNearly) {\r\n                if (condition.lineNode) {\r\n                  condition.lineNode.style[key] = `${condition.lineShift}px`\r\n                  condition.lineNode.style.visibility = 'visible'\r\n                }\r\n                let newCoordinates: ICoordinateType = [...coordinates]\r\n                if (key === 'top') {\r\n                  newCoordinates = [coordinates[0], condition.dragShift]\r\n                } else {\r\n                  newCoordinates = [condition.dragShift, coordinates[1]]\r\n                }\r\n\r\n                if (!isEqual(newCoordinates, coordinates)) {\r\n                  onNodePositionChange(nodeId, newCoordinates)\r\n                }\r\n              }\r\n            })\r\n          })\r\n        }\r\n      })\r\n    },\r\n    [handleHideLine, onNodePositionChange]\r\n  )\r\n\r\n  useEventBus({ type: EVENT_NODE_MOVING, onChange: handleMove })\r\n  useEventBus({ type: EVENT_NODE_MOVE_END, onChange: handleHideLine })\r\n\r\n  return (\r\n    <div className=\"mark-line\" ref={ref}>\r\n      <div className=\"mark-line-item x-direction\" data-mark-line-id=\"x-top\" />\r\n      <div className=\"mark-line-item x-direction\" data-mark-line-id=\"x-bottom\" />\r\n      <div className=\"mark-line-item y-direction\" data-mark-line-id=\"y-left\" />\r\n      <div className=\"mark-line-item y-direction\" data-mark-line-id=\"y-right\" />\r\n    </div>\r\n  )\r\n})\r\n\r\nMarkLine.displayName = 'MarkLine'\r\n","import React from 'react'\r\nimport ReactDOM from 'react-dom'\r\nimport { ICoordinateType, NodeTypeEnum } from '../../types'\r\nimport { nodesList } from '../NodeTypes/config'\r\n\r\nexport interface SelectModelProps {\r\n  position?: ICoordinateType\r\n  onChange: (nodeType?: NodeTypeEnum) => void\r\n}\r\n\r\nexport const SelectModel: React.FC<SelectModelProps> = React.memo((prop) => {\r\n  const { position, onChange } = prop\r\n\r\n  if (!position) {\r\n    return null\r\n  }\r\n\r\n  const handleClose = () => {\r\n    onChange()\r\n  }\r\n\r\n  const handleItemClick = (event: React.MouseEvent<HTMLLIElement, MouseEvent>) => {\r\n    onChange(event.currentTarget.dataset.type as NodeTypeEnum)\r\n  }\r\n  const stopEvent = (event: React.MouseEvent<HTMLUListElement, MouseEvent>) => {\r\n    event.stopPropagation()\r\n  }\r\n\r\n  return ReactDOM.createPortal(\r\n    <div className=\"select-model\" onClick={handleClose}>\r\n      <ul\r\n        className=\"select-model-content\"\r\n        style={{ left: position[0], top: position[1], position: 'absolute' }}\r\n        onClick={stopEvent}\r\n      >\r\n        {nodesList.map((node) => (\r\n          <li key={node.type} className=\"select-model-item\" onClick={handleItemClick} data-type={node.type}>\r\n            {node.icon && React.createElement(node.icon)}\r\n            <div className=\"select-model-text\">{node.label}</div>\r\n          </li>\r\n        ))}\r\n      </ul>\r\n    </div>,\r\n    document.body\r\n  )\r\n})\r\n\r\nSelectModel.displayName = 'SelectModel'\r\n","import { groupBy, isEqual, maxBy, omit } from 'lodash-es'\r\nimport { getNodeStyle } from '.'\r\nimport { IDiagramType, ILinkType, INodeRefs, INodeStyle, INodeType, IPointType } from '../types'\r\n\r\nconst checkPortIsNodeSon = (ports: IPointType[], entityId: string) => {\r\n  for (let j = 0; j < ports.length; j++) {\r\n    const input = ports[j]\r\n    if (input.id === entityId) {\r\n      return true\r\n    }\r\n  }\r\n  return false\r\n}\r\n\r\nconst findPortFatherNodeId = (entityId: string, nodes: INodeType[]) => {\r\n  for (let i = 0; i < nodes.length; i++) {\r\n    const node = nodes[i]\r\n    // 如果 id 是 nodeId\r\n    if (node.id === entityId) {\r\n      return node.id\r\n    } else {\r\n      if (checkPortIsNodeSon(node.inputs, entityId)) return node.id\r\n      if (checkPortIsNodeSon(node.outputs, entityId)) return node.id\r\n    }\r\n  }\r\n  return entityId\r\n}\r\n\r\nconst checkIsStartLink = (linkInput: string, links: ILinkType[], nodes: INodeType[]) =>\r\n  !links.find((link) => link.output === findPortFatherNodeId(linkInput, nodes))\r\n\r\ninterface ExtendActionDto extends INodeType {\r\n  row: number\r\n  column: number\r\n  style: INodeStyle\r\n}\r\n\r\n/*\r\n * 自动排列 需要根据实际的点和线 连接放松排列 这里的自动排列涵盖情况有限 重新排列效果仅供参考\r\n */\r\nexport default function autoLayout(value: IDiagramType, nodeRefs: INodeRefs) {\r\n  const { links = [], nodes = [] } = value\r\n  let row = 1\r\n  const extendNodes = nodes.map((node) => {\r\n    return {\r\n      ...node,\r\n      row: 0,\r\n      column: 0,\r\n      style: getNodeStyle(nodeRefs[node.id]),\r\n    }\r\n  })\r\n\r\n  const recursionLookup = (\r\n    linkEndId: string,\r\n    baseColumn: number,\r\n    extendNodes: ExtendActionDto[],\r\n    links: ILinkType[],\r\n    catchNodeIds: string[]\r\n  ) => {\r\n    if (catchNodeIds.includes(linkEndId)) return\r\n    catchNodeIds.push(linkEndId)\r\n    const currentNode = extendNodes.find((node) => node.id === findPortFatherNodeId(linkEndId, extendNodes))\r\n    if (!currentNode) return\r\n    currentNode.row = currentNode.row || row\r\n    currentNode.column = currentNode.column || baseColumn\r\n    baseColumn++\r\n    let outputHasLinkNum = 0\r\n\r\n    currentNode.outputs.forEach((port) => {\r\n      const findLink = links.find((link) => link.input === port.id)\r\n      if (findLink) {\r\n        outputHasLinkNum++\r\n        if (outputHasLinkNum > 1) {\r\n          row++\r\n        }\r\n        recursionLookup(findLink.output, baseColumn, extendNodes, links, catchNodeIds)\r\n      }\r\n    })\r\n  }\r\n\r\n  links.forEach((link) => {\r\n    if (checkIsStartLink(link.input, links, extendNodes)) {\r\n      const portFatherNodeId = findPortFatherNodeId(link.input, extendNodes)\r\n      const catchNodeIds = [portFatherNodeId]\r\n      const currentNode = extendNodes.find((node) => node.id === portFatherNodeId)\r\n      if (!currentNode) return\r\n      currentNode.row = currentNode.row || row\r\n      currentNode.column = 1\r\n      recursionLookup(link.output, 2, extendNodes, links, catchNodeIds)\r\n      row++\r\n    }\r\n  })\r\n\r\n  // if is init data update row and column\r\n  extendNodes.forEach((node) => {\r\n    if (node.row === 0) {\r\n      node.row = row\r\n      node.column = 1\r\n      row++\r\n    }\r\n  })\r\n\r\n  const extendNodesCopy = [...extendNodes]\r\n  extendNodesCopy.forEach(({ outputs }) => {\r\n    const nextNodeIds: string[] = []\r\n    outputs.forEach((port) => {\r\n      if (port.isLinked) {\r\n        const findLink = links.find((link) => link.input === port.id)\r\n        if (findLink) {\r\n          nextNodeIds.push(findLink.output)\r\n        }\r\n      }\r\n    })\r\n    extendNodes.sort((a, b) => {\r\n      return nextNodeIds.findIndex((nodeId) => a.id === nodeId) - nextNodeIds.findIndex((nodeId) => b.id === nodeId)\r\n    })\r\n  })\r\n\r\n  const SPACING = 50\r\n  const LAYOUT_BASIC_COORDINATE = {\r\n    LEFT: 100,\r\n    TOP: 100,\r\n  }\r\n\r\n  const COLUMN_STEP_WIDTH = 200 + SPACING\r\n  const groupRowMap = groupBy(extendNodes, (item) => item.row)\r\n  const groupRows = Object.values(groupRowMap)\r\n\r\n  // row start top\r\n  let currentTop = LAYOUT_BASIC_COORDINATE.TOP\r\n\r\n  groupRows.forEach((aRow, rowIndex) => {\r\n    // sort by column\r\n    aRow.sort((a, b) => a.column - b.column)\r\n\r\n    aRow.forEach((cell, cellIndex) => {\r\n      if (cellIndex === 0 && rowIndex > 0) {\r\n        const preRow = groupRows[rowIndex - 1]\r\n\r\n        const currentAfterPreRow = preRow.filter((preCell) => preCell.column >= cell.column)\r\n\r\n        const currentAfterPreRowMaxHeightList = currentAfterPreRow.map((cell) => cell.style.height)\r\n\r\n        const rowMaxHeight = maxBy(currentAfterPreRowMaxHeightList) || 0\r\n        currentTop += rowMaxHeight + SPACING\r\n      }\r\n      if (cell.column) {\r\n        cell.coordinates = [(cell.column - 1) * COLUMN_STEP_WIDTH + LAYOUT_BASIC_COORDINATE.LEFT, currentTop]\r\n      }\r\n    })\r\n  })\r\n\r\n  const newNodes = extendNodes.map((node) => {\r\n    return {\r\n      ...omit(node, 'column', 'row', 'style'),\r\n    }\r\n  })\r\n  return { links: links, nodes: newNodes }\r\n}\r\n\r\nexport const diffNodesCoordinates = (oldNodes: INodeType[], newNodes: INodeType[]) => {\r\n  return newNodes.some(({ id, coordinates }) => {\r\n    const find = oldNodes.find((item) => item.id === id)\r\n    if (!find) {\r\n      return true\r\n    } else if (!isEqual(find.coordinates, coordinates)) {\r\n      return true\r\n    } else {\r\n      return false\r\n    }\r\n  })\r\n}\r\n\r\nconst toFixed2 = (num: number) => Number(num.toFixed(2))\r\n\r\nexport const computedAnimationStep = (\r\n  oldNodes: INodeType[],\r\n  newNodes: INodeType[],\r\n  stepCount: number\r\n): INodeTypeWithStep[] => {\r\n  return oldNodes.map((node) => {\r\n    const findNextNode = newNodes.find((item) => item.id === node.id)\r\n    const xStep = findNextNode ? toFixed2((findNextNode.coordinates[0] - node.coordinates[0]) / stepCount) : 0\r\n    const yStep = findNextNode ? toFixed2((findNextNode.coordinates[1] - node.coordinates[1]) / stepCount) : 0\r\n    return {\r\n      ...node,\r\n      xStep,\r\n      yStep,\r\n    }\r\n  })\r\n}\r\n\r\ninterface INodeTypeWithStep extends INodeType {\r\n  xStep: number\r\n  yStep: number\r\n}\r\n\r\ninterface IAutoLayoutAnimation {\r\n  originNodes: INodeType[]\r\n  futureNodes: INodeType[]\r\n  animationFn: (nodes: INodeType[]) => void\r\n  stepCount: number\r\n}\r\n\r\nexport const autoLayoutAnimation = ({ originNodes, futureNodes, animationFn, stepCount }: IAutoLayoutAnimation) => {\r\n  return new Promise((resolve, reject) => {\r\n    try {\r\n      let animationCount = 0\r\n      let nodeWithStep: INodeTypeWithStep[] = computedAnimationStep(originNodes, futureNodes, stepCount)\r\n      const step = () => {\r\n        animationCount = animationCount + 1\r\n        nodeWithStep = nodeWithStep.map((item) => {\r\n          return {\r\n            ...item,\r\n            coordinates: [item.coordinates[0] + item.xStep, item.coordinates[1] + item.yStep],\r\n          }\r\n        })\r\n        const nextNodes: INodeType[] = nodeWithStep.map((item) => ({ ...omit(item, ['xStep', 'yStep']) }))\r\n\r\n        animationFn(nextNodes)\r\n\r\n        if (animationCount < stepCount) {\r\n          requestAnimationFrame(step)\r\n        } else {\r\n          animationFn(futureNodes) // 最后多执行一次保证位置正确\r\n          resolve(futureNodes)\r\n        }\r\n      }\r\n      requestAnimationFrame(step)\r\n    } catch (error) {\r\n      reject(error)\r\n    }\r\n  })\r\n}\r\n","import React, { useCallback, useState, useRef } from 'react'\r\nimport { DiagramCanvas } from './DiagramCanvas'\r\nimport { NodesCanvas } from './NodesCanvas'\r\nimport { LinksCanvas } from './LinksCanvas'\r\nimport { Segment } from './Segment'\r\nimport './style.scss'\r\nimport {\r\n  IDiagramType,\r\n  ILinkType,\r\n  ISegmentType,\r\n  IPortRefs,\r\n  INodeRefs,\r\n  ITransform,\r\n  ICoordinateType,\r\n  NodeTypeEnum,\r\n  INodeType,\r\n} from '../../types'\r\nimport { isEqual } from 'lodash-es'\r\nimport useEventCallback from '../../hooks/useEventCallback'\r\nimport { batchUpdateCoordinates, calculatingCoordinates, findIndexById, oneNodeDelete } from '../../utils'\r\nimport { copyNode, createNode } from '../NodeTypes/config'\r\nimport { MarkLine } from './MarkLine'\r\nimport { SelectModel } from './SelectModel'\r\nimport autoLayout, { autoLayoutAnimation, diffNodesCoordinates } from '../../utils/autoLayout'\r\nimport { EVENT_AUTO_LAYOUT } from '../../utils/eventBus'\r\nimport useEventBus from '../../hooks/useEventBus'\r\ninterface DiagramProps {\r\n  value: IDiagramType\r\n  onChange: (value: IDiagramType, notAddHistory?: boolean) => void\r\n  onAddHistory: (value: IDiagramType) => void\r\n  transform: ITransform\r\n  activeNodeIds: string[]\r\n  onToggleActiveNodeId: (nodeId: string) => void\r\n}\r\nconst STEP_COUNT = 60 // auto layout 动画执行总次数\r\n\r\nexport const Diagram: React.FC<DiagramProps> = React.memo((props) => {\r\n  const { value, onChange, onAddHistory, transform, activeNodeIds, onToggleActiveNodeId } = props\r\n  const [segment, setSegment] = useState<ISegmentType | undefined>()\r\n  const [selectModelPosition, setSelectModelPosition] = useState<ICoordinateType>()\r\n  const { current: portRefs } = useRef<IPortRefs>({}) // 保存所有 Port 的 Dom 节点\r\n  const { current: nodeRefs } = useRef<INodeRefs>({}) // 保存所有 Node 的 Dom 节点\r\n  const startPortIdRef = useRef<string>() // 保存所有 Node 的 Dom 节点\r\n  const isAutoLayoutRef = useRef<boolean>(false) // 保存所有 Node 的 Dom 节点\r\n\r\n  const handleNodePositionChange = useEventCallback((nodeId: string, nextCoordinates: ICoordinateType) => {\r\n    const nextNodes = batchUpdateCoordinates(nodeId, nextCoordinates, value.nodes, activeNodeIds)\r\n    onChange({ ...value, nodes: nextNodes }, true)\r\n  })\r\n\r\n  const handleNodeValueChange = useEventCallback((nodeId: string, nextNodeValue: any) => {\r\n    const nextNodes = [...value.nodes]\r\n    const index = findIndexById(nodeId, nextNodes)\r\n    nextNodes[index] = { ...nextNodes[index], data: nextNodeValue }\r\n    onChange({ ...value, nodes: nextNodes })\r\n  })\r\n\r\n  const handleAddHistory = useEventCallback((nodeId: string, nextCoordinates: ICoordinateType) => {\r\n    const nextNodes = batchUpdateCoordinates(nodeId, nextCoordinates, value.nodes, activeNodeIds)\r\n    onAddHistory({ ...value, nodes: nextNodes })\r\n  })\r\n\r\n  const handleNodeCopy = useEventCallback((nodeId: string) => {\r\n    const index = findIndexById(nodeId, value.nodes)\r\n    const newNode = copyNode(value.nodes[index])\r\n    onChange({ ...value, nodes: [...value.nodes, newNode] })\r\n  })\r\n\r\n  const handleNodeDelete = useEventCallback((nodeId: string) => {\r\n    const nextValue = oneNodeDelete(value, nodeId)\r\n    onChange(nextValue)\r\n  })\r\n\r\n  // when a port is registered, save it to the local reference\r\n  const onPortRegister = useEventCallback((portId: string, portEl: HTMLElement) => {\r\n    portRefs[portId] = portEl\r\n  })\r\n\r\n  // when a node is registered, save it to the local reference\r\n  const onNodeRegister = useEventCallback((nodeId: string, nodeEl: HTMLDivElement) => {\r\n    // const rect = nodeEl.getBoundingClientRect()\r\n    nodeRefs[nodeId] = nodeEl\r\n  })\r\n\r\n  // when a new segment is dragged, save it to the local state\r\n  const onDragNewSegment = useCallback((portId, from, to) => {\r\n    setSegment({ id: `segment-${portId}`, from, to })\r\n  }, [])\r\n\r\n  // when a segment fails to connect, reset the segment state\r\n  const onSegmentFail = useCallback(() => {\r\n    setSegment(undefined)\r\n  }, [])\r\n\r\n  const onShowSelectModel = useEventCallback((event: MouseEvent, input: string) => {\r\n    startPortIdRef.current = input\r\n    setSelectModelPosition([event.clientX, event.clientY])\r\n    setSegment(undefined)\r\n  })\r\n\r\n  // when a segment connects, update the links schema, perform the onChange callback\r\n  // with the new data, then reset the segment state\r\n  const onSegmentConnect = useEventCallback((input: string, output: string) => {\r\n    const linkIsExists = value.links.findIndex((link) => link.input === input && link.output === output) > -1\r\n    if (!linkIsExists) {\r\n      const nextLinks = [...value.links, { input, output }]\r\n\r\n      onChange({ ...value, links: nextLinks })\r\n    }\r\n    setSegment(undefined)\r\n  })\r\n\r\n  // when links change, performs the onChange callback with the new incoming data\r\n  const onLinkDelete = useEventCallback((link: ILinkType) => {\r\n    const nextLinks = value.links.filter((item) => !isEqual(item, link))\r\n    onChange({ ...value, links: nextLinks })\r\n  })\r\n\r\n  const handleSelectModelChange = useEventCallback((nodeType?: NodeTypeEnum) => {\r\n    if (nodeType && selectModelPosition) {\r\n      const coordinates: ICoordinateType = calculatingCoordinates(\r\n        { clientX: selectModelPosition[0], clientY: selectModelPosition[1] } as MouseEvent,\r\n        document.getElementById('diagram-canvas'),\r\n        transform.scale\r\n      )\r\n      const newNode = createNode(nodeType, coordinates)\r\n      onChange({ ...value, nodes: [...value.nodes, newNode] })\r\n      // nodes 更新后 渲染 link\r\n      setTimeout(() => {\r\n        onSegmentConnect(startPortIdRef.current || '', newNode.id)\r\n      }, 20)\r\n    }\r\n    setSelectModelPosition(undefined)\r\n  })\r\n\r\n  const handleAutoLayout = useCallback(() => {\r\n    const nextValue = autoLayout(value, nodeRefs)\r\n    if (diffNodesCoordinates(value.nodes, nextValue.nodes) && !isAutoLayoutRef.current) {\r\n      const params = {\r\n        originNodes: value.nodes,\r\n        futureNodes: nextValue.nodes,\r\n        animationFn: (nodes: INodeType[]) => onChange({ ...nextValue, nodes: nodes }, true),\r\n        stepCount: STEP_COUNT,\r\n      }\r\n      isAutoLayoutRef.current = true\r\n\r\n      autoLayoutAnimation(params)\r\n        .then(() => {\r\n          onAddHistory(value) // 成功后把原始位置追加到历史记录\r\n        })\r\n        .finally(() => (isAutoLayoutRef.current = false))\r\n    }\r\n  }, [value, nodeRefs, onChange, onAddHistory, isAutoLayoutRef])\r\n\r\n  useEventBus({ type: EVENT_AUTO_LAYOUT, onChange: handleAutoLayout })\r\n\r\n  return (\r\n    <DiagramCanvas portRefs={portRefs} nodeRefs={nodeRefs} transform={transform}>\r\n      <NodesCanvas\r\n        nodes={value.nodes}\r\n        onNodeMount={onNodeRegister}\r\n        onPortMount={onPortRegister}\r\n        onDragNewSegment={onDragNewSegment}\r\n        onSegmentFail={onSegmentFail}\r\n        onShowSelectModel={onShowSelectModel}\r\n        onNodePositionChange={handleNodePositionChange}\r\n        onNodeValueChange={handleNodeValueChange}\r\n        onNodeDelete={handleNodeDelete}\r\n        onNodeCopy={handleNodeCopy}\r\n        onSegmentConnect={onSegmentConnect}\r\n        onAddHistory={handleAddHistory}\r\n        onToggleActiveNodeId={onToggleActiveNodeId}\r\n        activeNodeIds={activeNodeIds}\r\n      />\r\n      {value.links.length > 0 && <LinksCanvas nodes={value.nodes} links={value.links} onDelete={onLinkDelete} />}\r\n      {segment && <Segment segment={segment} />}\r\n      <MarkLine onNodePositionChange={handleNodePositionChange} />\r\n      <SelectModel position={selectModelPosition} onChange={handleSelectModelChange} />\r\n    </DiagramCanvas>\r\n  )\r\n})\r\n\r\nDiagram.displayName = 'Diagram'\r\n","import { useReducer, useCallback } from 'react'\r\nimport { IDiagramType } from '../types'\r\n\r\n// 初始化useReducer中的state\r\nconst initialState = {\r\n  // 当我们每次添加新state时，用来储存更新前状态的数组\r\n  past: [],\r\n  // 当前的state值\r\n  present: null,\r\n  // 让我们可以用使用重做功能的，future数组\r\n  future: [],\r\n}\r\n\r\n// 根据action处理state的改变\r\nconst reducer = (state: any, action: any) => {\r\n  const { past, present, future } = state\r\n  const { newPresent } = action\r\n\r\n  switch (action.type) {\r\n    case 'UNDO':\r\n      const previous = past[past.length - 1]\r\n      const newPast = past.slice(0, past.length - 1)\r\n\r\n      return {\r\n        past: newPast,\r\n        present: previous,\r\n        future: [present, ...future],\r\n      }\r\n    case 'REDO':\r\n      const next = future[0]\r\n      const newFuture = future.slice(1)\r\n\r\n      return {\r\n        past: [...past, present],\r\n        present: next,\r\n        future: newFuture,\r\n      }\r\n    case 'SET':\r\n      return {\r\n        past: [...past],\r\n        present: newPresent,\r\n        future: [],\r\n      }\r\n\r\n    case 'SET_WIDTH_HISTORY':\r\n      if (newPresent === present) {\r\n        return state\r\n      }\r\n      return {\r\n        past: [...past, present],\r\n        present: newPresent,\r\n        future: [],\r\n      }\r\n\r\n    case 'ADD_A_HISTORY':\r\n      if (newPresent === present) {\r\n        return state\r\n      }\r\n      return {\r\n        past: [...past, newPresent],\r\n        present: present,\r\n        future: [],\r\n      }\r\n\r\n    case 'CLEAR':\r\n      const { initialPresent } = action\r\n\r\n      return {\r\n        ...initialState,\r\n        present: initialPresent,\r\n      }\r\n  }\r\n}\r\n\r\n// Hook\r\nexport const useHistory = (initialPresent: IDiagramType) => {\r\n  const [state, dispatch] = useReducer(reducer, {\r\n    ...initialState,\r\n    present: initialPresent,\r\n  })\r\n\r\n  const canUndo = state.past.length !== 0\r\n  const canRedo = state.future.length !== 0\r\n\r\n  const undo = useCallback(() => {\r\n    if (canUndo) {\r\n      dispatch({ type: 'UNDO' })\r\n    }\r\n  }, [canUndo, dispatch])\r\n\r\n  const redo = useCallback(() => {\r\n    if (canRedo) {\r\n      dispatch({ type: 'REDO' })\r\n    }\r\n  }, [canRedo, dispatch])\r\n\r\n  // 只设置值 不追加历史记录 例如 移动 node的过程不需要记录\r\n  const set = useCallback((newPresent) => dispatch({ type: 'SET', newPresent }), [dispatch])\r\n\r\n  // 设置值 并且追加历史记录 例如 增加删除节点，修改节点data数据等\r\n  const setWithHistory = useCallback((newPresent) => dispatch({ type: 'SET_WIDTH_HISTORY', newPresent }), [dispatch])\r\n\r\n  // 仅追加一条历史记录不设置值 例如 节点移动后，把节点拖拽的起始位置 追加进入历史栈\r\n  const addAHistory = useCallback((newPresent) => dispatch({ type: 'ADD_A_HISTORY', newPresent }), [dispatch])\r\n\r\n  const clear = useCallback(() => dispatch({ type: 'CLEAR', initialPresent }), [dispatch, initialPresent])\r\n\r\n  return { present: state.present, set, setWithHistory, addAHistory, undo, redo, clear, canUndo, canRedo }\r\n}\r\n","import React from 'react'\r\n\r\nimport './style.scss'\r\nimport IconClick from '../../static/icon-click.png'\r\nimport IconMove from '../../static/icon-move.png'\r\nimport IconWheel from '../../static/icon-wheel.png'\r\n\r\nexport interface ShortcutsPanelProps {}\r\n\r\nconst isMac = (() => /macintosh|mac os x/i.test(navigator.userAgent))()\r\n\r\nconst CTRL_OR_CMD = isMac ? 'CMD' : 'Ctrl'\r\n// const ALT_OR_OPT = isMac ? 'OPT' : 'Alt'\r\n\r\nconst hotkeyList = [\r\n  { text: '撤销', hotKeys: [{ key: CTRL_OR_CMD }, { key: 'Z' }] },\r\n  { text: '多选', hotKeys: [{ key: 'Shift' }, { icon: IconClick }] },\r\n  { text: '重做', hotKeys: [{ key: CTRL_OR_CMD }, { key: 'Shift' }, { key: 'Z' }] },\r\n  { text: '全选', hotKeys: [{ key: CTRL_OR_CMD }, { key: 'A' }] },\r\n  { text: '复制', hotKeys: [{ key: CTRL_OR_CMD }, { key: 'C' }] },\r\n  { text: '缩放', hotKeys: [{ icon: IconWheel }] },\r\n  { text: '粘贴', hotKeys: [{ key: CTRL_OR_CMD }, { key: 'V' }] },\r\n  { text: '移动画布', hotKeys: [{ key: 'Space' }, { icon: IconMove }] },\r\n  { text: '删除', hotKeys: [{ key: 'Del' }] },\r\n  // { text: '自动排列', hotKeys: [{ key: CTRL_OR_CMD }, { key: 'Shift' }, { key: 'A' }] },\r\n]\r\n\r\nexport const ShortcutsPanel: React.FC<ShortcutsPanelProps> = React.memo(() => {\r\n  return (\r\n    <ul className=\"shortcuts-panel\">\r\n      {hotkeyList.map((item, index) => (\r\n        <li key={index} className=\"shortcuts-panel-item\">\r\n          <div className=\"shortcuts-panel-title\">{item.text} :</div>\r\n          <div className=\"shortcuts-panel-list\">\r\n            {item.hotKeys.map((keyItem, keyIndex) => (\r\n              <React.Fragment key={keyIndex}>\r\n                {keyIndex > 0 && <span className=\"shortcuts-panel-plus\">+</span>}\r\n                <div className=\"shortcuts-panel-key\">\r\n                  {keyItem.key}\r\n                  {keyItem.icon && <img className=\"shortcuts-panel-icon\" src={keyItem.icon} alt={item.text} />}\r\n                </div>\r\n              </React.Fragment>\r\n            ))}\r\n          </div>\r\n        </li>\r\n      ))}\r\n    </ul>\r\n  )\r\n})\r\n","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAE8ElEQVRoQ+2ZbWibVRTH/+c+6YugTKjMTVaoTBRBcFBRHCpVvw3FJmkc7sv8IO1sm3RTaZNqWdyHPunswCVrXQu6itjh0jRxU/ZpWFEYsk0niqK2UFDsVrYxcYy+5LlHbmpqDGlznydFWmy/tfe8/H/3nHse7i1hjf9QKfobAqHzyn8kaj5USpxSfIsC+Hw+Ix6PW4WSrHoAd0voGSHYOzd7reXU4ODNfIhVDeALh8v56kwKRBsl0zfzs1fa8iFWNYDa7fo9wRqjjAaIUCUZ56/9ObV3bGhoJluJVQ+QD8GSzonL5W3xeHhOra0JgByIo0S4QzKPjcYiry01Odx7Oh8QLmxj4hoibGCGC8zXSdAkW/SdMf3Lt0sNBSfTqOgUygZ9rvn16jIXH5YkzdHDkXO5ydSkkpu2Pg/gBSK6azkhDFwH4yNhVRyP94dvOBGd66MNoJwKjVR3c/v9hss4AODuQmKYuR+SbzCJGiKuI6KNyo4ZVyRgJmPm56VA2ALIT+RuDT4lBHUT4FpKRBrclIpGLmTX3c0djwlD+ImwdQGE+xOxyHtOIQoCZA9nftDcL25GiEv0Lide+ecDZCspN9/TRsCujA3zoVQsctwJhCMAz97OzWTJYSK6rVjSQgBZH28gtJsAPysGi5pH+7q/LhYvf91RC3kCoR4BPK2TbDkA5e8JdB4Q4B0MnhRTEzvtTijbAO6W0L2GgWEd8Uu10L8mWHP4VmnMnFLVTEvZlTrSc1o3trKzDeBtDQVJoEE3SbEKqDje1mAjCWpk4GIiar6kG9sZQCD0KQF36ibRAfD427cIMlIZQemKOjvfB1sV8DV2bOBKcUZXvE4LLR5ofyhJhGrLgj/ZZ57VzWELwO3veNAg8a5ucDsAnkAoKoDtsBAe6TM/0c1hC6A+EKx1gQZ0g9sCaA3uF4KeZSCWiJrv6+ZYhQA8mIhGBtcBCu1AtoXUR4csGtLZJQs4m+wzrxaz9Sy20H9QAQZfSEQjTcVE2VlfB9DZrZwWWq9A/oatt9D/q4UYE4mYuVMHWtdmsYUkm4kjkYSun60v8d8X+A+YcTMRM5/QTaJj520NDpCgWkjZNWLjTmALwLdv3y1sVX6hBFlz8zuSR3undcTp2Hj9wc/UpcYCvZiMdn+v4+P0PvAhAfcx86GEw4t4vrj6l4O1rjIaYNCsmCp/MvvypwNhqwIq4OLtifGruDTeYPcOW0iUxx/sFUR1EjgzGjU7dIRnbWwDuFtCVcKgkwSuWIkq5N4x0vPclHrnnzckHRDbAJkqBEKvqDcddZilZTUl+w/+qJMs32ZhM/gYQT1H0lcj0e4Wu3EcAajDLNOVw+oKmHkilAgk+8yf7STPiBfoVy90aiMY1q7R2MHf7MRwdIizCRb+d4BjanJkKgG87bo0/rHOmaj3tz9skLE/8zjAsCxLvprs7/nSrviSAJSzeiMSgmNEVKV+Z+AnCXnCNYOx+GDPH7mCfL5weXrT7KPE8AqB7Rn7BfCuUh54HbVQrjDVCobAGyA8nvt3Bi4T6HcQWyxxO4irCVSRtWHGDxbSb6Zib0042XnHU2ipZGqWizLaLRiPgGAsZaeEk8QJmh4/rdNuxeBKrkChycKwtgkyagDekulTommL5aSYMy6ODnZPFRNlZ33FAewkXwnbdYCV2MVSYqxXoJTdWwnfNV+BvwALEYtPTIIeoAAAAABJRU5ErkJggg==\"","export default \"data:image/png;base64,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\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAFiUlEQVRoQ+2Zf2hbVRTHzzkvbVNxWFEclQ4L/kJRLEwGGwjCZLAxMT8WpkNh+8N2tEnbqbRJEFfYTLLZuZH0hwuoFXQiaX6IIuyPgsoUNiwIE8fKKsrAlTFBmbq2y7tH7mtfeE1/vNs0td1o/0pz3zvnfO75nnPfO0G4xf/wFo8flAHcgc6nUDj+zPS+/dtqglYCkMETUAIA/mVBTasJwhbADB4R7pA7zwzXVhPEggDultA9SPAmIm9AwHoDAOAiM/yqOcYPp44fv7HScrLNgAxwV0toJ2jQJT/ngZty8djwSgdu+r/9AKTmWfC9ud6jQyalq6Vjq0bUJv8XSOFsPPKTueb1B73M2g8rVdgzMlDoNiySPKkZAJqj8nqqr+tvq2R8jZ136aAZRY1OfgkYtq1UYRcAiruNGTADJ9PxWNIK4PEHDxLh89bv7LqThE4lj/xV7topAOzyh+JAsKXYgSqA0aEEJ9M9saSnMVyLVbqLATchQD0iritsCMM1QDgvQJxx5KuHirO7WMACgO/AgWqhOxMI0MAAP7Lgy0ZQiF9nE9FvrIbdLZ0vIGKDISHCRxDgUcH8KWh0CnVoQ+TnZm8ETiBw1cys8XUAPEVjVR+lUl2Tiw3e8D9D2yaEDrnB3uiX5ppxHlTgA0ZNTFaOWHfN2xpsZIZ1LPAiEXSYB95cmaQrzoGbd/+zQaukzUC0XYJPH46XWFBnKY1gVhuVmchPOjdke6MjZhALnQOu/cF6qIDNDsTXF9rBuaToag5u0xzYhgDrmfm6QApYO5xKRpZ8DrhbQju16UNusQDyepldIu5GxCeNRqDhvsyJyBWV4GdJqPgm9/437kNnZR3qYgsi7p1ax25BMKLhjQs6V9egzp/NJ5sZep+jm5nrRv3lnQOI8CAzn08nYvvKAmAtbKtBWbCZROyYpzV0hAC2qjibS0LW+zzt4VoUMCgLXdehK2upwYXs20qoGKIQfKCjjlDLqQRvFOoCGTBteP3BRiSUTeFSOhF9UcW2LYA0YkIw8wW58/I7byD0KiI0qThRBXDtba9xrKs+DQiarsMeayOZz48SgAHh66q09mpvIPihLLxyAkhbnkCojxA2scAT6Z7Ix3b2lQGKDXkDoW9Vite8T0VCRmZbg40I2CgAv8rEI28tC4DMBtdOfG9nXLULWa8zzxwGHk7HY7YSLSkD8lmHnPzFcgC4WoMbHYAn1wAW2t3bKgOD8ejTi5GS3bX/u4TWAIpSspYBO40ap6Wlja5JaE1CKpopusb6KIHa+DPlnJHu8nduB6JDy3oSTz10hb+TLx/58fzuXPKd0RL2Yc5bvP7wy0jcLgQMZXqinXZ2S3oWmgIIfSKnCjqIQ9n4kc/tHKmuewLBbkJ8lhn70onIB3b3lQ7gD7ch8SuC4VwmEW22c6Sy7mvuulM4xk8jYFX+Jjfl+u2n4CUDuFvDT2jAAzIw1bcnOwjzLY+Z/6Cx0R2pVEq3u6dkAKuM5CSPrlxqUnE4X0ByAkIVFYPyJckcUdoFL9eXBCAHwhrS+9IQA5xKx6PvqjgtvmZ6rHISER5n4N9Jm9it2tmWBDCdhdcQYI8BwTxAY6P9i8mE1L3umDhBAA3AoOdBD+QSR8+pbsSSAXw+n6avfyhCZM6H8CzfFMfS/bFf7IJwt4Q2k8YhBLzfqCWGSDYRzdjdZ11fMoA0ZkDUPnyQgHdMyynPzGcE8xDm9eHse91XTaeeQEcdI24kRpc51WDACaFzVHWYVXYA06B8IWcN2hGgxuqEjd8G+Sri1E7PWGP4WQg4rDIDmiszZcmA1bDRy2nSBcSF8fksxwy6QDjLDOni3x4WI58ldyE7Z3LyDJp4TNOphpGrkHFCJ3HZ4ZgcUe0ydj7KngE7h+Vev+UB/gN5EApeyCXHVgAAAABJRU5ErkJggg==\"","import React, { useCallback } from 'react'\r\nimport { Button, Popover } from 'antd'\r\n\r\nimport './style.scss'\r\nimport eventBus, { EVENT_AUTO_LAYOUT } from '../../utils/eventBus'\r\nimport { ShortcutsPanel } from './ShortcutsPanel'\r\n\r\nexport interface ToolbarProps {\r\n  undo: () => void\r\n  redo: () => void\r\n  canUndo: boolean\r\n  canRedo: boolean\r\n  scale: number\r\n}\r\n\r\nexport const Toolbar: React.FC<ToolbarProps> = React.memo(({ undo, redo, canUndo, canRedo, scale }) => {\r\n  const handleAutoLayout = useCallback(() => {\r\n    eventBus.emit(EVENT_AUTO_LAYOUT)\r\n  }, [])\r\n\r\n  return (\r\n    <div className=\"toolbar\">\r\n      <Button disabled>{scale * 100}%</Button>\r\n      <Button disabled={!canUndo} onClick={undo}>\r\n        撤销\r\n      </Button>\r\n      <Button disabled={!canRedo} onClick={redo}>\r\n        重做\r\n      </Button>\r\n      <Popover trigger=\"click\" placement=\"right\" content={<ShortcutsPanel />} overlayClassName=\"scale-popover\">\r\n        <Button>快捷键</Button>\r\n      </Popover>\r\n      <Button onClick={handleAutoLayout}>自动排列</Button>\r\n    </div>\r\n  )\r\n})\r\n","import React, { useCallback } from 'react'\r\n\r\nimport './style.scss'\r\n\r\nexport interface NodeListItemProps {\r\n  icon: React.FC\r\n  label: string\r\n  type: string\r\n}\r\n\r\nexport const NodeListItem: React.FC<NodeListItemProps> = React.memo(({ icon, label, type }) => {\r\n  const handleDragStart = useCallback(\r\n    (event: any) => {\r\n      event.dataTransfer?.setData('nodeType', type)\r\n    },\r\n    [type]\r\n  )\r\n  return (\r\n    <div className=\"node-list-item\" draggable onDragStart={handleDragStart}>\r\n      {icon && React.createElement(icon)}\r\n      <div className=\"node-list-text\">{label}</div>\r\n    </div>\r\n  )\r\n})\r\n\r\nNodeListItem.displayName = 'NodeListItem'\r\n","import React, { memo } from 'react'\r\nimport './style.scss'\r\nimport { NodeListItem } from './NodeListItem'\r\nimport { nodesList } from '../NodeTypes/config'\r\n\r\nexport interface NodeListProps {}\r\n\r\nexport const NodeList: React.FC<NodeListProps> = memo(() => {\r\n  return (\r\n    <div className=\"node-list\">\r\n      {nodesList.map((node) => (\r\n        <NodeListItem key={node.type} icon={node.icon} type={node.type} label={node.label} />\r\n      ))}\r\n    </div>\r\n  )\r\n})\r\n\r\nNodeList.displayName = 'NodeList'\r\n","import { useEffect, useRef } from 'react'\r\n\r\nfunction useEventListener(eventName: string, handler: (event?: any) => void, element = document, options?: any) {\r\n  // 创建一个储存处理方法的ref\r\n  const savedHandler = useRef<any>()\r\n\r\n  // 当处理函数改变的时候更新ref.current的方法\r\n  // 这样可以使我们的总是获取到最新的处理函数\r\n  // 并且不需要在它的effect依赖数组中传递\r\n  // 并且避免有可能每次渲染重新引起effect方法\r\n  useEffect(() => {\r\n    savedHandler.current = handler\r\n  }, [handler])\r\n\r\n  useEffect(\r\n    () => {\r\n      // 确认是否支持addEventListener\r\n      const isSupported = element && element.addEventListener\r\n      if (!isSupported) return\r\n\r\n      // 创建一个调用储存在ref中函数的事件监听\r\n      const eventListener = (event: any) => savedHandler.current(event)\r\n\r\n      // 添加事件监听\r\n      element.addEventListener(eventName, eventListener, options)\r\n\r\n      // 在cleanup的回调中，清除事件监听\r\n      return () => {\r\n        element.removeEventListener(eventName, eventListener)\r\n      }\r\n    },\r\n    [eventName, element, options] // 当元素或者绑定事件改变时，重新运行\r\n  )\r\n}\r\nexport default useEventListener\r\n","export const SCALE_STEP = 0.1\r\n\r\n\r\nexport const DRAG_STATE = {\r\n  DEFAULT: 'DEFAULT',\r\n  START: 'START',\r\n  MOVE: 'MOVE',\r\n  END: 'END',\r\n  SELECTION: 'SELECTION'\r\n}\r\n\r\nexport const CURSOR_MAP = {\r\n  [DRAG_STATE.DEFAULT]: 'default',\r\n  [DRAG_STATE.SELECTION]: 'default',\r\n  [DRAG_STATE.START]: 'grab',\r\n  [DRAG_STATE.MOVE]: 'grabbing'\r\n}\r\n","import { IDiagramType } from '../types'\r\n\r\nexport const defaultValue: IDiagramType = {\r\n  'links': [{'input': 'port-1', 'output': 'node-2'}, {\r\n    'input': 'port-5',\r\n    'output': '841e9704-c295-4915-8ba9-1d8ab4e6b172'\r\n  }, {\r\n    'input': 'd0ce404a-d95c-4210-be5d-106cb707ecda',\r\n    'output': '0d8dcb00-7c54-488a-9e85-0f92cb463cc3'\r\n  }, {'input': '1751249f-fb2c-44ed-b324-e99cf1d8a5fd', 'output': '1a5f12bc-9d9c-48e2-905d-97e865845e87'}],\r\n  'nodes': [{\r\n    'id': 'node-1',\r\n    'coordinates': [100, 100],\r\n    'inputs': [],\r\n    'outputs': [{'id': 'port-1', 'isLinked': true}],\r\n    'type': 'nodeTypeInput',\r\n    'data': {'inputValue': 'defaultValue'}\r\n  }, {\r\n    'id': '841e9704-c295-4915-8ba9-1d8ab4e6b172',\r\n    'coordinates': [600, 100],\r\n    'type': 'nodeTypeInput',\r\n    'inputs': [],\r\n    'outputs': [{'id': '62852bf6-4cb8-4437-8cb9-d1edce72de1b', 'isLinked': false}],\r\n    'data': {'inputValue': 'test'}\r\n  }, {\r\n    'id': 'ebac3f07-598e-4e2f-9e81-e67e542322d8',\r\n    'coordinates': [364, 353],\r\n    'type': 'nodeTypeButton',\r\n    'inputs': [],\r\n    'outputs': [{\r\n      'id': 'd0ce404a-d95c-4210-be5d-106cb707ecda',\r\n      'isLinked': false\r\n    }, {'id': '1751249f-fb2c-44ed-b324-e99cf1d8a5fd', 'isLinked': false}],\r\n    'data': {\r\n      'buttonList': [{'text': 'button-1', 'id': 'd0ce404a-d95c-4210-be5d-106cb707ecda'}, {\r\n        'text': 'button-2',\r\n        'id': '1751249f-fb2c-44ed-b324-e99cf1d8a5fd'\r\n      }]\r\n    }\r\n  }, {\r\n    'id': '0d8dcb00-7c54-488a-9e85-0f92cb463cc3',\r\n    'coordinates': [604, 353],\r\n    'type': 'nodeTypeInput',\r\n    'inputs': [],\r\n    'outputs': [{'id': 'f854d9bc-0b0e-481c-acfe-786a20483726', 'isLinked': false}],\r\n    'data': {'inputValue': 'input'}\r\n  }, {\r\n    'id': 'f57ee82a-2f1e-45e8-905a-187d36a45dbb',\r\n    'coordinates': [100, 370],\r\n    'type': 'nodeTypeSelect',\r\n    'inputs': [],\r\n    'outputs': [{'id': '459c4240-26f7-4351-857d-ba856ca755cb', 'isLinked': false}],\r\n    'data': {'inputValue': '', 'selectValue': 'lucy'}\r\n  }, {\r\n    'id': 'node-2',\r\n    'type': 'nodeTypeSelect',\r\n    'coordinates': [367, 226],\r\n    'inputs': [{'id': 'input-1', 'isLinked': false}],\r\n    'outputs': [{'id': 'port-5', 'isLinked': false}],\r\n    'data': {'selectValue': ''}\r\n  }, {\r\n    'id': '1a5f12bc-9d9c-48e2-905d-97e865845e87',\r\n    'coordinates': [597, 478],\r\n    'type': 'nodeTypeSelect',\r\n    'inputs': [],\r\n    'outputs': [{'id': '2d16159f-3f1c-4370-b3fc-28bd8e51c388', 'isLinked': false}],\r\n    'data': {'inputValue': ''}\r\n  }]\r\n}\r\n\r\n\r\nconst manyNode: any = new Array(500).fill({}).map((item, index) => {\r\n  return {\r\n    id: 'node-' + index,\r\n    coordinates: [index * 40 + 200, index * 50],\r\n    inputs: [],\r\n    outputs: [{id: 'port-' + index, isLinked: false}],\r\n    type: 'nodeTypeInput',\r\n    data: {\r\n      inputValue: 'defaultValue'\r\n    }\r\n  }\r\n})\r\n\r\nconst manyLink = new Array(400).fill({}).map((item, index) => {\r\n  return {input: 'port-' + index, output: 'node-' + (index + 1)}\r\n})\r\n\r\nexport const bigDataValue = {\r\n  nodes: manyNode,\r\n  links: manyLink\r\n}\r\n","import React, { useCallback, useMemo, useRef, useState, memo } from 'react'\r\nimport { Diagram } from './components/Diagram'\r\nimport { useHistory } from './hooks/useHistory'\r\nimport { Toolbar } from './components/Toolbar/Toolbar'\r\nimport { NodeList } from './components/NodeList/NodeList'\r\nimport { IDiagramType, ICoordinateType, IMousePosition, ITransform, ISelectionArea, INodeType } from './types'\r\nimport { copyNode, createNode } from './components/NodeTypes/config'\r\nimport { throttle } from 'lodash-es'\r\nimport {\r\n  calculatingCoordinates,\r\n  checkIsFocusInPanel,\r\n  checkMouseDownTargetIsDrawPanel,\r\n  collideCheck,\r\n  oneNodeDelete\r\n} from './utils'\r\nimport { useHotkeys } from 'react-hotkeys-hook'\r\nimport useEventCallback from './hooks/useEventCallback'\r\nimport useEventListener from './hooks/useEventListener'\r\nimport {\r\n  HOT_KEY_COPY,\r\n  HOT_KEY_DEL, HOT_KEY_PASTE,\r\n  HOT_KEY_REDO,\r\n  HOT_KEY_SELECT_ALL,\r\n  HOT_KEY_SPACE,\r\n  HOT_KEY_UNDO\r\n} from './constant/hotKeys'\r\nimport { CURSOR_MAP, DRAG_STATE, SCALE_STEP } from './constant'\r\nimport { defaultValue } from './utils/creatMockData'\r\n// import { useThrottleFn } from 'react-use'\r\n\r\n\r\n\r\n\r\nfunction DiagramPanel() {\r\n  const {\r\n    present,\r\n    set,\r\n    setWithHistory,\r\n    addAHistory,\r\n    undo: handleUndo,\r\n    redo: handleRedo,\r\n    canUndo,\r\n    canRedo\r\n  } = useHistory(defaultValue)\r\n\r\n  const value = present as IDiagramType\r\n  const [transform, setTransform] = useState<ITransform>({\r\n    scale: 1,\r\n    translateX: 0,\r\n    translateY: 0\r\n  })\r\n  const [selectionArea, setSelectionArea] = useState<ISelectionArea | undefined>()\r\n  const [dragState, setDragState] = useState<string>(DRAG_STATE.DEFAULT)\r\n  const mouseDownStartPosition = useRef<IMousePosition | undefined>()\r\n  const [activeNodeIds, setActiveNodeIds] = useState<string[]>([])\r\n\r\n  const panelRef = useRef<HTMLDivElement>(null)\r\n  const selectionAreaRef = useRef<HTMLDivElement>(null)\r\n  const batchCopyNodesRef = useRef<INodeType[]>([])\r\n  const batchCopyActiveNodeIdsRef = useRef<string[]>([])\r\n\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  const panelRect = useMemo(() => panelRef.current?.getBoundingClientRect() || {x: 0, y: 0}, [panelRef.current])\r\n\r\n  // eslint-disable-next-line\r\n  const handleThrottleSetTransform = useCallback(\r\n    throttle((transform) => {\r\n      setTransform(transform)\r\n    }, 20),\r\n    [setTransform]\r\n  )\r\n\r\n  const handleChange = useCallback(\r\n    (newValue: IDiagramType, notAddHistory?: boolean) => {\r\n      if (notAddHistory) {\r\n        set(newValue)\r\n      } else {\r\n        setWithHistory(newValue)\r\n      }\r\n    },\r\n    [set, setWithHistory]\r\n  )\r\n\r\n  const handleAddHistory = useCallback(\r\n    (newValue: IDiagramType) => {\r\n      addAHistory(newValue)\r\n    },\r\n    [addAHistory]\r\n  )\r\n\r\n  const handleDrop = useCallback(\r\n    (event: any) => {\r\n      if (event) {\r\n        event = window.event\r\n      }\r\n      const nodeType = event.dataTransfer.getData('nodeType')\r\n\r\n      const coordinates: ICoordinateType = calculatingCoordinates(\r\n        event,\r\n        document.getElementById('diagram-canvas'),\r\n        transform.scale\r\n      )\r\n\r\n      const newNode = createNode(nodeType, coordinates)\r\n      handleChange({...value, nodes: [...value.nodes, newNode]})\r\n    },\r\n    [handleChange, transform, value]\r\n  )\r\n\r\n  const handleDrag = useCallback((e: any) => {\r\n    e.preventDefault()\r\n  }, [])\r\n\r\n  const handleWheel = useEventCallback((event: any) => {\r\n    if (!panelRef.current?.contains(event.target)) return\r\n\r\n    const wheelDelta = event.wheelDelta\r\n\r\n    let {scale, translateX, translateY} = transform\r\n\r\n    const offsetX = ((event.clientX - panelRect.x - translateX) * SCALE_STEP) / scale\r\n    const offsetY = ((event.clientY - panelRect.y - translateY) * SCALE_STEP) / scale\r\n\r\n    if (wheelDelta < 0) {\r\n      scale = scale - SCALE_STEP\r\n      translateX = translateX + offsetX\r\n      translateY = translateY + offsetY\r\n    }\r\n    if (wheelDelta > 0) {\r\n      scale = scale + SCALE_STEP\r\n      translateX = translateX - offsetX\r\n      translateY = translateY - offsetY\r\n    }\r\n\r\n    if (scale > 1 || scale < 0.1) return\r\n\r\n    handleThrottleSetTransform({\r\n      scale: Number(scale.toFixed(2)),\r\n      translateX,\r\n      translateY\r\n    })\r\n  })\r\n\r\n  const handleMouseDown = useEventCallback((event) => {\r\n    mouseDownStartPosition.current = {\r\n      x: event.clientX,\r\n      y: event.clientY,\r\n      relativeX: event.clientX - transform.translateX,\r\n      relativeY: event.clientY - transform.translateY\r\n    }\r\n    if (checkMouseDownTargetIsDrawPanel(event, panelRef.current)) {\r\n      if (dragState === DRAG_STATE.START) {\r\n        setDragState(DRAG_STATE.MOVE)\r\n      } else {\r\n        setDragState(DRAG_STATE.SELECTION)\r\n        setActiveNodeIds([])\r\n      }\r\n    }\r\n  })\r\n\r\n  // eslint-disable-next-line\r\n  const handleThrottleSetSelectionArea = useCallback(\r\n    throttle((e) => {\r\n      if (mouseDownStartPosition.current && panelRef.current) {\r\n        // const panelRect = panelRef.current.getBoundingClientRect()\r\n        setSelectionArea({\r\n          left: Math.min(e.clientX, mouseDownStartPosition.current.x) - panelRect.x,\r\n          top: Math.min(e.clientY, mouseDownStartPosition.current.y) - panelRect.y,\r\n          width: Math.abs(e.clientX - mouseDownStartPosition.current.x),\r\n          height: Math.abs(e.clientY - mouseDownStartPosition.current.y)\r\n        })\r\n        const selectAreaDom = selectionAreaRef.current\r\n        const activeNodeIds = value.nodes\r\n          .map((v) => v.id)\r\n          .filter((id) => {\r\n            return collideCheck(selectAreaDom, document.getElementById(id))\r\n          })\r\n\r\n        setActiveNodeIds(activeNodeIds)\r\n      }\r\n    }, 20),\r\n    [transform, value]\r\n  )\r\n\r\n  const handleMouseUp = useEventCallback((event) => {\r\n    if (dragState === DRAG_STATE.MOVE) {\r\n      setDragState(DRAG_STATE.START)\r\n    } else {\r\n      setDragState(DRAG_STATE.DEFAULT)\r\n    }\r\n    setSelectionArea(undefined)\r\n    mouseDownStartPosition.current = undefined\r\n  })\r\n\r\n  const handleMouseMove = useEventCallback((event) => {\r\n    if (dragState === DRAG_STATE.MOVE && mouseDownStartPosition.current) {\r\n      handleThrottleSetTransform({\r\n        ...transform,\r\n        translateX: event.clientX - mouseDownStartPosition.current.relativeX,\r\n        translateY: event.clientY - mouseDownStartPosition.current.relativeY\r\n      })\r\n    }\r\n\r\n    if (dragState === DRAG_STATE.SELECTION) {\r\n      handleThrottleSetSelectionArea(event)\r\n    }\r\n  })\r\n\r\n  const handleSpaceHotKey = useEventCallback((event: KeyboardEvent) => {\r\n    if (event.type === 'keydown' && dragState === DRAG_STATE.DEFAULT) {\r\n      setDragState(DRAG_STATE.START)\r\n    }\r\n    if (event.type === 'keyup') {\r\n      setDragState(DRAG_STATE.DEFAULT)\r\n    }\r\n  })\r\n\r\n  const handleSelectAll = useEventCallback((event: KeyboardEvent) => {\r\n    if (checkIsFocusInPanel(panelRef.current)) {\r\n      event.preventDefault()\r\n      setActiveNodeIds(value.nodes.map((node) => node.id))\r\n    }\r\n  })\r\n\r\n  const handleBatchDelete = useEventCallback(() => {\r\n    if (checkIsFocusInPanel(panelRef.current) && activeNodeIds.length) {\r\n      let nextValue = {...value}\r\n      activeNodeIds.forEach(nodeId => {\r\n        nextValue = oneNodeDelete(nextValue, nodeId)\r\n      })\r\n      handleChange(nextValue)\r\n    }\r\n  })\r\n\r\n  const handleBatchCopy = useEventCallback((event: KeyboardEvent) => {\r\n    if (checkIsFocusInPanel(panelRef.current) && activeNodeIds.length) {\r\n      event.preventDefault()\r\n      batchCopyNodesRef.current = value.nodes\r\n      batchCopyActiveNodeIdsRef.current = activeNodeIds\r\n    }\r\n  })\r\n\r\n  const handleBatchPaste = useEventCallback((event: KeyboardEvent) => {\r\n    if (checkIsFocusInPanel(panelRef.current)) {\r\n      event.preventDefault()\r\n      const nextValue = batchCopyActiveNodeIdsRef.current.map((nodeId: string) => {\r\n        const nodeIndex = batchCopyNodesRef.current.findIndex(node => node.id === nodeId)\r\n        return copyNode(batchCopyNodesRef.current[nodeIndex])\r\n      })\r\n      handleChange({...value, nodes: [...value.nodes, ...nextValue]})\r\n    }\r\n  })\r\n\r\n  const handleToggleActiveNodeId = useEventCallback((nodeId: string) => {\r\n    let nextActiveNodeIds = [...activeNodeIds]\r\n    const findIndex = nextActiveNodeIds.findIndex(activeNodeId => activeNodeId === nodeId)\r\n    if (findIndex > -1) {\r\n      nextActiveNodeIds.splice(findIndex, 1)\r\n    } else {\r\n      nextActiveNodeIds = [...nextActiveNodeIds, nodeId]\r\n    }\r\n    setActiveNodeIds(nextActiveNodeIds)\r\n  })\r\n\r\n  const cursor = useMemo(() => {\r\n    return CURSOR_MAP[dragState]\r\n  }, [dragState])\r\n\r\n  const hideSelectionArea = useMemo(() => dragState !== DRAG_STATE.SELECTION, [dragState])\r\n\r\n  const selectionAreaStyled = useMemo(\r\n    () => ({\r\n      left: selectionArea?.left,\r\n      top: selectionArea?.top,\r\n      width: selectionArea?.width,\r\n      height: selectionArea?.height\r\n    }),\r\n    [selectionArea]\r\n  )\r\n\r\n  /*\r\n   * bind some hotkeys\r\n   */\r\n  useHotkeys(HOT_KEY_UNDO, handleUndo, {}, [handleUndo])\r\n  useHotkeys(HOT_KEY_REDO, handleRedo, {}, [handleRedo])\r\n  useHotkeys(HOT_KEY_COPY, handleBatchCopy, {}, [handleBatchCopy])\r\n  useHotkeys(HOT_KEY_PASTE, handleBatchPaste, {}, [handleBatchPaste])\r\n  useHotkeys(HOT_KEY_SELECT_ALL, handleSelectAll, {}, [handleSelectAll])\r\n  useHotkeys(HOT_KEY_DEL, handleBatchDelete, {}, [handleBatchDelete])\r\n  useHotkeys(HOT_KEY_SPACE, handleSpaceHotKey, {keyup: true, keydown: true}, [handleSpaceHotKey])\r\n\r\n  useEventListener('wheel', handleWheel)\r\n\r\n  useEventListener('mouseup', handleMouseUp)\r\n  useEventListener('mousemove', handleMouseMove)\r\n  useEventListener('mousedown', handleMouseDown)\r\n\r\n  return (\r\n    <>\r\n      <div\r\n        id=\"diagram-panel\"\r\n        ref={panelRef}\r\n        className=\"diagram-panel\"\r\n        onDrop={handleDrop}\r\n        onDragEnter={handleDrag}\r\n        onDragOver={handleDrag}\r\n        tabIndex={1}\r\n        style={{cursor}}\r\n      >\r\n        <Diagram\r\n          value={value}\r\n          transform={transform}\r\n          onChange={handleChange}\r\n          onAddHistory={handleAddHistory}\r\n          activeNodeIds={activeNodeIds}\r\n          onToggleActiveNodeId={handleToggleActiveNodeId}\r\n        />\r\n        <div\r\n          ref={selectionAreaRef}\r\n          className=\"diagram-selection-area\"\r\n          hidden={hideSelectionArea}\r\n          style={selectionAreaStyled}\r\n        />\r\n      </div>\r\n      <Toolbar undo={handleUndo} redo={handleRedo} canUndo={canUndo} scale={transform.scale} canRedo={canRedo}/>\r\n      <NodeList/>\r\n    </>\r\n  )\r\n}\r\n\r\nexport default memo(DiagramPanel)\r\n","export const HOT_KEY_COPY = 'ctrl+c, cmd+c'\r\nexport const HOT_KEY_PASTE = 'ctrl+v, cmd+v'\r\nexport const HOT_KEY_UNDO = 'ctrl+z, cmd+z'\r\nexport const HOT_KEY_REDO = 'ctrl+shift+z, cmd+shift+z'\r\nexport const HOT_KEY_SELECT_ALL = 'ctrl+a, cmd+a'\r\nexport const HOT_KEY_DEL = 'del'\r\nexport const HOT_KEY_AUTO_LAYOUT = 'ctrl+shift+a, cmd+shift+a'\r\nexport const HOT_KEY_SPACE = 'space'\r\n","import { ReportHandler } from 'web-vitals';\r\n\r\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\r\n  if (onPerfEntry && onPerfEntry instanceof Function) {\r\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\r\n      getCLS(onPerfEntry);\r\n      getFID(onPerfEntry);\r\n      getFCP(onPerfEntry);\r\n      getLCP(onPerfEntry);\r\n      getTTFB(onPerfEntry);\r\n    });\r\n  }\r\n};\r\n\r\nexport default reportWebVitals;\r\n","import React from 'react'\r\nimport ReactDOM from 'react-dom'\r\nimport './index.css'\r\nimport DiagramPanel from './DiagramPanel'\r\nimport reportWebVitals from './reportWebVitals'\r\n\r\nReactDOM.render(\r\n  <React.StrictMode>\r\n    <DiagramPanel />\r\n  </React.StrictMode>,\r\n  document.getElementById('root')\r\n)\r\n\r\n// If you want to start measuring performance in your app, pass a function\r\n// to log results (for example: reportWebVitals(console.log))\r\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\r\nreportWebVitals()\r\n"],"sourceRoot":""}