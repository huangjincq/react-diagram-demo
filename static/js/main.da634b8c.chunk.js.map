{"version":3,"sources":["components/Context/DiagramManager.ts","components/Context/PortManager.ts","components/Diagram/DiagramCanvas.tsx","hooks/useDrag.ts","components/NodeTypes/NodeTypeHeader.tsx","components/NodeTypes/NodeTypeSingleOutputs.tsx","components/NodeTypes/NodeTypeSingleInputs.tsx","utils/index.ts","components/Diagram/Port.tsx","components/NodeTypes/NodeTypeCustomRenderPort.tsx","components/NodeTypes/NodeTypeNoInputOutput.tsx","components/NodeTypes/config.ts","components/NodeTypes/NodeTypeMultipleInputsOutputs.tsx","components/Diagram/DiagramNodePorts.tsx","components/Diagram/DiagramNodeActionButtons.tsx","utils/onfire.ts","utils/eventBus.ts","components/Diagram/DiagramNode.tsx","components/Diagram/NodesCanvas.tsx","utils/makeSvgPath.ts","components/Diagram/Link.tsx","components/Diagram/LinksCanvas.tsx","components/Diagram/Segment.tsx","hooks/useEventCallback.ts","components/Diagram/SelectModel.tsx","utils/autoLayout.ts","hooks/useEventBus.ts","utils/copyPaste.ts","components/Diagram/index.tsx","hooks/useHistory.ts","components/Toolbar/ShortcutsPanel.tsx","static/icon-click.png","static/icon-wheel.png","static/icon-move.png","components/Toolbar/Toolbar.tsx","components/NodeList/NodeListItem.tsx","components/NodeList/NodeList.tsx","hooks/useEventListener.ts","constant/index.ts","utils/creatMockData.ts","DiagramPanel.tsx","constant/hotKeys.ts","reportWebVitals.ts","index.tsx"],"names":["defaultValue","canvasRef","portRefs","nodeRefs","scale","DiagramManagerContext","createContext","DiagramManagerProvider","Provider","useDiagramManager","useContext","onDragNewSegment","id","from","to","onSegmentFail","onSegmentConnect","targetPort","onShowSelectModel","event","input","onPortMount","dom","PortManagerContext","PortManagerContextProvider","DiagramCanvas","React","memo","props","children","transform","translateX","translateY","useState","canvasDom","setBoundingBox","useRef","useEffect","current","contextValue","useMemo","portContextValue","className","ref","style","value","displayName","DISABLED_DRAG_TAGS","defaultOptions","throttleBy","getEventCoordinates","clientX","clientY","CreateCallbackRef","useCallback","callback","useDrag","options","targetRef","dragStartHandlerRef","dragHandlerRef","dragEndHandlerRef","isDragging","start","end","offset","info","onDragStart","targetTagName","target","tagName","contains","includes","onDrag","throttle","onDragEnd","_onDragStart","e","_onDrag","_onDragEnd","addEventListener","document","removeEventListener","NodeTypeHeader","icon","label","createElement","TextArea","Input","NodeTypeSingleOutputs","onChange","nodesConfig","nodeTypeSingleOutputs","placeholder","rows","inputValue","NodeTypeSingleInputs","nodeTypeSingleInputs","marginTop","width","selectValue","Option","calculatingCoordinates","referenceDom","referenceDomRect","getBoundingClientRect","x","y","getInteger","findEventTargetParentNodeId","nodeId","isNodeDom","classList","parentElement","findIndexById","nodes","findIndex","node","getNodeStyle","nodeDom","offsetWidth","height","offsetHeight","left","offsetLeft","top","offsetTop","right","bottom","batchUpdateCoordinates","nextCoordinates","activeNodeIds","nextNodes","index","offsetCoordinate","coordinates","forEach","activeNodeId","some","nextIndex","oneNodeDelete","currentNode","nodeOutputs","outputs","map","port","nodeInputs","inputs","splice","links","filter","link","output","checkIsFocusInPanel","panelDom","activeElement","checkWheelDirection","wheelDown","wheelUp","deltaY","wheelDelta","deltaX","deltaZ","num","remainder","Math","floor","BASE_NUM","isMac","test","navigator","userAgent","isCtrlOrCommandPress","hotkeys","ctrl","Port","isLinked","startCoordinatesRef","classnames","stopImmediatePropagation","stopPropagation","canvasX","canvasY","targetDom","targetNode","getElementById","NodeTypeCustomRenderPort","handleInputChange","dataset","newBranchList","branchList","text","nodeTypeCustomRenderPort","item","data-index","NodeTypeNoInputOutput","nodeTypeNoInputOutput","NodeTypes","NodeTypeMultipleInputsOutputs","nodeTypeMultipleInputsOutputs","component","AppleOutlined","customRenderPort","uuidv4","type","data","WindowsOutlined","GithubOutlined","nodesList","Object","entries","key","createNode","nodeType","coordinate","DiagramNodePorts","ports","DiagramNodeActionButtons","onNodeDelete","onNodeCopy","handleNodeDelete","handleNodeCopy","onClick","CopyOutlined","DeleteOutlined","OnFire","es","eventName","cb","once","this","push","on","listeners","l","length","params","i","apply","undefined","fire","ver","EVENT_AUTO_LAYOUT","EE","DiagramNode","nodeInfo","onNodeValueChange","onNodePositionChange","onNodeMount","onAddHistory","onToggleActiveNodeId","isActive","nodeConfig","nodeItemProps","nextNodeData","dragStartPoint","nextCoords","eventBus","emit","isEqual","handleClick","shiftKey","active","console","warn","NodesCanvas","others","roundPoint","point","getCubicBezierPath","points","controlPointForStart","controlPointForEnd","join","getAdvancedCubicBezierPath","midX","midY","makeSvgPath","startPoint","endPoint","roundedStart","roundedEnd","Link","onDelete","svgRef","abs","computedLinkSvgInfo","path","handleDelete","handleMouseOver","add","handleMouseOut","remove","pointerEvents","d","onDoubleClick","onMouseOver","onMouseOut","prev","next","LinksCanvas","result","res","startCoordinates","computedLinkCoordinate","entityId","endCoordinates","calculatingPortRelativeNode","portDom","nodeRect","portRect","findPortCoordinate","nodeCoordinates","j","nodeEl","inputRes","outputRes","Segment","segment","r","cx","cy","useEventCallback","fn","useLayoutEffect","SelectModel","prop","position","handleItemClick","currentTarget","ReactDOM","createPortal","data-type","body","checkPortIsNodeSon","findPortFatherNodeId","autoLayout","row","extendNodes","column","recursionLookup","linkEndId","baseColumn","catchNodeIds","find","outputHasLinkNum","findLink","linkInput","checkIsStartLink","portFatherNodeId","nextNodeIds","sort","a","b","LAYOUT_BASIC_COORDINATE","groupRowMap","groupBy","groupRows","values","currentTop","aRow","rowIndex","cell","cellIndex","currentAfterPreRowMaxHeightList","preCell","rowMaxHeight","maxBy","newNodes","omit","toFixed2","Number","toFixed","autoLayoutAnimation","originNodes","futureNodes","animationFn","stepCount","Promise","resolve","reject","animationCount","nodeWithStep","oldNodes","findNextNode","xStep","yStep","computedAnimationStep","requestAnimationFrame","step","error","useEventBus","dep","off","updatePasteLink","oldId","newId","inputUpdated","outputUpdated","Diagram","setSegment","selectModelPosition","setSelectModelPosition","startPortIdRef","isAutoLayoutRef","handleNodePositionChange","handleNodeValueChange","nextNodeValue","handleAddHistory","newNode","originNode","nodeData","cloneDeep","createSinglePasteValue","nextValue","onPortRegister","portId","portEl","onNodeRegister","nextLinks","onLinkDelete","handleSelectModelChange","setTimeout","handleAutoLayout","then","finally","initialState","past","present","future","reducer","state","action","newPresent","previous","slice","newFuture","initialPresent","CTRL_OR_CMD","hotkeyList","hotKeys","ShortcutsPanel","keyItem","keyIndex","Fragment","src","alt","Toolbar","undo","redo","canUndo","canRedo","disabled","trigger","placement","content","overlayClassName","NodeListItem","handleDragStart","dataTransfer","setData","draggable","NodeList","useEventListener","handler","element","savedHandler","eventListener","SCALE_STEP","DRAG_STATE","CURSOR_MAP","Array","fill","DiagramPanel","useReducer","dispatch","set","setWithHistory","addAHistory","clear","useHistory","handleUndo","handleRedo","setTransform","selectionArea","setSelectionArea","dragState","setDragState","mouseDownStartPosition","setActiveNodeIds","panelRef","selectionAreaRef","panelRect","handleThrottleSetTransform","handleChange","newValue","notAddHistory","handleDrop","window","getData","handleDrag","preventDefault","handlePanelScale","offsetX","offsetY","handlePanelTranslate","shift","handleWheel","log","returnValue","handleMouseDown","relativeX","relativeY","firstChild","checkMouseDownTargetIsDrawPanel","handleThrottleSetSelectionArea","min","selectAreaDom","v","dom1","dom2","rect1","rect2","maxX","max","maxY","minX","minY","collideCheck","handleMouseUp","handleMouseMove","handleSpaceHotKey","handleSelectAll","handleBatchDelete","handleBatchCopy","originCopyData","minBy","createCopyValue","clipboardData","JSON","stringify","handleBatchPaste","pasteOffset","calculatePasteOriginCoordination","pasteString","newLinks","newNodeId","newCoordinates","newPortId","createPasteValue","parse","handleToggleActiveNodeId","nextActiveNodeIds","cursor","hideSelectionArea","selectionAreaStyled","useHotkeys","keyup","keydown","passive","onDrop","onDragEnter","onDragOver","tabIndex","hidden","reportWebVitals","onPerfEntry","Function","getCLS","getFID","getFCP","getLCP","getTTFB","render","StrictMode"],"mappings":"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","file":"static/js/main.da634b8c.chunk.js","sourcesContent":["import { createContext, useContext } from 'react'\r\nimport { IPortRefs, INodeRefs } from '../../types'\r\n\r\nexport interface IDiagramManager {\r\n  canvasRef: HTMLDivElement | null\r\n  portRefs: IPortRefs\r\n  nodeRefs: INodeRefs\r\n  scale: number\r\n}\r\n\r\nconst defaultValue: IDiagramManager = { canvasRef: null, portRefs: {}, nodeRefs: {}, scale: 1 }\r\n\r\nconst DiagramManagerContext = createContext(defaultValue)\r\n\r\nexport const DiagramManagerProvider = DiagramManagerContext.Provider\r\n\r\n// export DiagramManager Context\r\nexport const useDiagramManager = (): IDiagramManager => {\r\n  return useContext(DiagramManagerContext)\r\n}\r\n\r\n// export DiagramCanvas Context\r\nexport const useDiagramCanvas = (): HTMLDivElement | null => {\r\n  const { canvasRef } = useContext(DiagramManagerContext)\r\n  return canvasRef\r\n}\r\n\r\n// return  DiagramNod dom 节点\r\nexport const useDiagramNodeRefs = (): INodeRefs => {\r\n  const { nodeRefs } = useContext(DiagramManagerContext)\r\n  return nodeRefs\r\n}\r\n\r\n// return  DiagramNodePorts ports 节点\r\nexport const usePortRefs = (): IPortRefs => {\r\n  const { portRefs } = useContext(DiagramManagerContext)\r\n  return portRefs\r\n}\r\n\r\n// return scale\r\nexport const useScale = (): number => {\r\n  const { scale } = useContext(DiagramManagerContext)\r\n  return scale\r\n}\r\n","import { createContext, useContext } from 'react'\r\nimport { ICoordinateType } from '../../types'\r\n\r\nexport interface IPortManager {\r\n  onDragNewSegment: (id: string, from: ICoordinateType, to: ICoordinateType) => void\r\n  onSegmentFail: (id: string) => void\r\n  onSegmentConnect: (id: string, targetPort: string) => void\r\n  onShowSelectModel: (event: MouseEvent, input: string) => void\r\n  onPortMount: (id: string, dom: HTMLElement) => void\r\n}\r\n\r\nconst defaultValue: IPortManager = {\r\n  onDragNewSegment: (id, from, to) => {},\r\n  onSegmentFail: (id) => {},\r\n  onSegmentConnect: (id, targetPort) => {},\r\n  onShowSelectModel: (event, input) => {},\r\n  onPortMount: (id, dom) => {},\r\n}\r\n\r\nconst PortManagerContext = createContext(defaultValue)\r\n\r\nexport const PortManagerContextProvider = PortManagerContext.Provider\r\n\r\nexport const usePortManager = (): IPortManager => {\r\n  return useContext(PortManagerContext)\r\n}\r\n","import React, { useEffect, useMemo, useRef, useState } from 'react'\r\nimport { DiagramManagerProvider } from '../Context/DiagramManager'\r\nimport { IPortRefs, INodeRefs, ITransform } from '../../types'\r\nimport { IPortManager, PortManagerContextProvider } from '../Context/PortManager'\r\n\r\ninterface DiagramCanvasProps extends IPortManager {\r\n  portRefs: IPortRefs\r\n  nodeRefs: INodeRefs\r\n  transform: ITransform\r\n}\r\n\r\nexport const DiagramCanvas: React.FC<DiagramCanvasProps> = React.memo((props) => {\r\n  const {\r\n    children,\r\n    portRefs,\r\n    nodeRefs,\r\n    transform,\r\n    onDragNewSegment,\r\n    onSegmentFail,\r\n    onSegmentConnect,\r\n    onShowSelectModel,\r\n    onPortMount,\r\n  } = props\r\n  const { scale, translateX, translateY } = transform\r\n\r\n  const [canvasDom, setBoundingBox] = useState<HTMLDivElement | null>(null)\r\n  const canvasRef = useRef<HTMLDivElement>(null)\r\n\r\n  // 储存 canvas dom\r\n  useEffect(() => {\r\n    setBoundingBox(canvasRef.current)\r\n  }, [])\r\n\r\n  const contextValue = useMemo(\r\n    () => ({\r\n      canvasRef: canvasDom,\r\n      portRefs,\r\n      nodeRefs,\r\n      scale,\r\n    }),\r\n    [canvasDom, portRefs, nodeRefs, scale]\r\n  )\r\n  const portContextValue = useMemo(\r\n    () => ({\r\n      onDragNewSegment,\r\n      onSegmentFail,\r\n      onSegmentConnect,\r\n      onShowSelectModel,\r\n      onPortMount,\r\n    }),\r\n    [onDragNewSegment, onSegmentFail, onSegmentConnect, onShowSelectModel, onPortMount]\r\n  )\r\n\r\n  return (\r\n    <div\r\n      id=\"diagram-canvas\"\r\n      className=\"diagram-canvas\"\r\n      ref={canvasRef}\r\n      // style={{ transform: `translate(${translate.x}px, ${translate.y}px) scale(${scale})` }}\r\n      style={{ transform: `matrix(${scale},0,0,${scale},${translateX},${translateY})` }}\r\n    >\r\n      <DiagramManagerProvider value={contextValue}>\r\n        <PortManagerContextProvider value={portContextValue}>{children}</PortManagerContextProvider>\r\n      </DiagramManagerProvider>\r\n    </div>\r\n  )\r\n})\r\n\r\nDiagramCanvas.displayName = 'DiagramCanvas'\r\n","import { throttle } from 'lodash-es'\r\nimport { useRef, useCallback, useEffect } from 'react'\r\nimport { ICoordinateType } from '../types'\r\n\r\nconst DISABLED_DRAG_TAGS = ['INPUT', 'TEXTAREA']\r\n\r\ninterface DefaultOptions {\r\n  ref: React.RefObject<any> | null\r\n  throttleBy: number\r\n}\r\n\r\ninterface InfoType {\r\n  isDragging: boolean\r\n  start: ICoordinateType\r\n  end: ICoordinateType\r\n  offset: ICoordinateType\r\n}\r\n\r\nconst defaultOptions: DefaultOptions = {\r\n  ref: null,\r\n  throttleBy: 16,\r\n}\r\n\r\nconst getEventCoordinates = (event: MouseEvent): ICoordinateType => [event.clientX, event.clientY]\r\n\r\n/**\r\n * 创建一个持久回调引用\r\n * @param ref\r\n * @returns {Function}\r\n */\r\nconst CreateCallbackRef = (ref: any) =>\r\n  useCallback(\r\n    (callback) => {\r\n      if (!ref.current || callback !== ref.current) {\r\n        ref.current = callback\r\n      }\r\n    },\r\n    [ref]\r\n  )\r\n\r\nconst useDrag = (options = defaultOptions) => {\r\n  const targetRef = options.ref\r\n  const dragStartHandlerRef = useRef<any>()\r\n  const dragHandlerRef = useRef<any>()\r\n  const dragEndHandlerRef = useRef<any>()\r\n  const { current: info } = useRef<InfoType>({ isDragging: false, start: [0, 0], end: [0, 0], offset: [0, 0] })\r\n\r\n  const onDragStart = useCallback(\r\n    (event) => {\r\n      const targetTagName = event.target.tagName\r\n      if (\r\n        !info.isDragging &&\r\n        targetRef?.current.contains(event.target) &&\r\n        !DISABLED_DRAG_TAGS.includes(targetTagName)\r\n      ) {\r\n        info.isDragging = true\r\n        info.end = [0, 0]\r\n        info.offset = [0, 0]\r\n        info.start = getEventCoordinates(event)\r\n\r\n        if (dragStartHandlerRef.current) {\r\n          dragStartHandlerRef.current(event, { ...info })\r\n        }\r\n      }\r\n    },\r\n    [targetRef, info, dragStartHandlerRef]\r\n  )\r\n\r\n  // eslint-disable-next-line\r\n  const onDrag = useCallback(\r\n    throttle((event) => {\r\n      if (info.isDragging) {\r\n        info.offset = [event.clientX - info.start[0], event.clientY - info.start[1]]\r\n\r\n        if (dragHandlerRef.current) {\r\n          dragHandlerRef.current(event, { ...info })\r\n        }\r\n      }\r\n    }, options.throttleBy),\r\n    [targetRef, info, dragHandlerRef]\r\n  )\r\n\r\n  const onDragEnd = useCallback(\r\n    (event) => {\r\n      if (info.isDragging) {\r\n        info.isDragging = false\r\n        info.end = getEventCoordinates(event)\r\n\r\n        if (dragEndHandlerRef.current) {\r\n          dragEndHandlerRef.current(event, { ...info })\r\n        }\r\n      }\r\n    },\r\n    [info, dragEndHandlerRef]\r\n  )\r\n\r\n  useEffect(() => {\r\n    const _onDragStart = (e: any) => onDragStart(e)\r\n    const _onDrag = (e: any) => onDrag(e)\r\n    const _onDragEnd = (e: any) => onDragEnd(e)\r\n\r\n    if (targetRef?.current) {\r\n      targetRef.current.addEventListener('mousedown', _onDragStart)\r\n      document.addEventListener('mousemove', _onDrag)\r\n      document.addEventListener('mouseup', _onDragEnd)\r\n    }\r\n\r\n    return () => {\r\n      if (targetRef?.current) {\r\n        // eslint-disable-next-line\r\n        targetRef.current.removeEventListener('mousedown', _onDragStart)\r\n        document.removeEventListener('mousemove', _onDrag)\r\n        document.removeEventListener('mouseup', _onDragEnd)\r\n      }\r\n    }\r\n  }, [targetRef, onDragStart, onDrag, onDragEnd])\r\n\r\n  return {\r\n    ref: targetRef,\r\n    onDragStart: CreateCallbackRef(dragStartHandlerRef),\r\n    onDrag: CreateCallbackRef(dragHandlerRef),\r\n    onDragEnd: CreateCallbackRef(dragEndHandlerRef),\r\n  }\r\n}\r\n\r\nexport default useDrag\r\n","import React from 'react'\r\n\r\nimport './style.scss'\r\n\r\n\r\nexport interface NodeTypeHeaderProps {\r\n  icon: React.FC\r\n  label: string;\r\n}\r\n\r\n\r\nexport const NodeTypeHeader: React.FC<NodeTypeHeaderProps> = (props) => {\r\n  const {icon, label} = props\r\n\r\n  return (\r\n    <h4 className='node-header'>\r\n      {icon && <div className='node-header-icon'>\r\n        {React.createElement(icon)}\r\n      </div>}\r\n      <div className='node-header-text'>{label}</div>\r\n    </h4>\r\n  )\r\n}\r\n\r\nNodeTypeHeader.displayName = 'NodeTypeHeader'\r\n","import React from 'react'\r\nimport { Input } from 'antd'\r\nimport './style.scss'\r\nimport { INodeItemProps } from '../../types'\r\nimport { NodeTypeHeader } from './NodeTypeHeader'\r\nimport { nodesConfig } from './config'\r\nconst { TextArea } = Input\r\n\r\nexport interface NodeTypeSingleOutputsProps extends INodeItemProps<any> {}\r\n\r\nexport const NodeTypeSingleOutputs: React.FC<NodeTypeSingleOutputsProps> = (props) => {\r\n  const { value, onChange } = props\r\n  const handleInputChange = (e: any) => {\r\n    onChange({\r\n      ...value,\r\n      inputValue: e.target.value,\r\n    })\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <NodeTypeHeader icon={nodesConfig.nodeTypeSingleOutputs.icon} label={nodesConfig.nodeTypeSingleOutputs.label} />\r\n      <div className=\"node-content\">\r\n        <TextArea placeholder=\"Input message here\" rows={2} value={value.inputValue} onChange={handleInputChange} />\r\n      </div>\r\n    </>\r\n  )\r\n}\r\n\r\nNodeTypeSingleOutputs.displayName = 'NodeTypeSingleOutputs'\r\n","import React from 'react'\r\nimport { Select } from 'antd'\r\nimport { Input } from 'antd'\r\nimport './style.scss'\r\nimport { INodeItemProps } from '../../types'\r\nimport { NodeTypeHeader } from './NodeTypeHeader'\r\nimport { nodesConfig } from './config'\r\nconst { TextArea } = Input\r\n\r\nexport interface NodeTypeSingleInputsProps extends INodeItemProps<any> {}\r\n\r\nexport const NodeTypeSingleInputs: React.FC<NodeTypeSingleInputsProps> = ({ value, onChange }) => {\r\n  const handleInputChange = (e: any) => {\r\n    onChange({\r\n      ...value,\r\n      inputValue: e.target.value,\r\n    })\r\n  }\r\n\r\n  const handleSelectChange = (e: any) => {\r\n    onChange({\r\n      ...value,\r\n      selectValue: e,\r\n    })\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <NodeTypeHeader icon={nodesConfig.nodeTypeSingleInputs.icon} label={nodesConfig.nodeTypeSingleInputs.label} />\r\n      <div className=\"node-content\">\r\n        <TextArea placeholder=\"Input message here\" rows={2} value={value.inputValue} onChange={handleInputChange} />\r\n        <div style={{ marginTop: 8 }}>\r\n          <Select style={{ width: '100%' }} value={value.selectValue} onChange={handleSelectChange}>\r\n            <Select.Option value=\"jack\">Jack</Select.Option>\r\n            <Select.Option value=\"lucy\">Lucy</Select.Option>\r\n            <Select.Option value=\"disabled\">Disabled</Select.Option>\r\n            <Select.Option value=\"Yiminghe\">yiminghe</Select.Option>\r\n          </Select>\r\n        </div>\r\n      </div>\r\n    </>\r\n  )\r\n}\r\n\r\nNodeTypeSingleInputs.displayName = 'NodeTypeSingleInputs'\r\n","import { ICoordinateType, IDiagramType, INodeStyle, INodeType } from '../types'\r\nimport hotkeys from 'hotkeys-js'\r\n\r\n// 计算 鼠标事件 相对在 参照物(diagram 画布)内的坐标\r\nexport const calculatingCoordinates = (\r\n  event: MouseEvent,\r\n  referenceDom: HTMLDivElement | HTMLElement | null,\r\n  scale: number\r\n): ICoordinateType => {\r\n  const referenceDomRect = referenceDom?.getBoundingClientRect() || { x: 0, y: 0 }\r\n  return [\r\n    getInteger((event.clientX - referenceDomRect.x) / scale),\r\n    getInteger((event.clientY - referenceDomRect.y) / scale),\r\n  ]\r\n}\r\n\r\nexport const findEventTargetParentNodeId = (dom: HTMLElement | null): null | string => {\r\n  if (!dom) {\r\n    return null\r\n  }\r\n  const nodeId = dom.id\r\n  const isNodeDom = dom.classList.contains('diagram-node')\r\n  if (nodeId && isNodeDom) {\r\n    return nodeId\r\n  }\r\n  if (isNodeDom) {\r\n    return null\r\n  }\r\n  return findEventTargetParentNodeId(dom.parentElement)\r\n}\r\n\r\n// 检测鼠标按下的时候是否是点击在画布空白区域\r\nexport const checkMouseDownTargetIsDrawPanel = (event: any, panelDom: HTMLElement | null) =>\r\n  event.target === panelDom || event.target === panelDom?.firstChild\r\n\r\n// 碰撞检测 检测两个div 是否相交\r\nexport const collideCheck = (dom1: HTMLElement | null, dom2: HTMLElement | null) => {\r\n  if (dom1 && dom2) {\r\n    const rect1 = dom1.getBoundingClientRect()\r\n    const rect2 = dom2.getBoundingClientRect()\r\n    const maxX: number = Math.max(rect1.x + rect1.width, rect2.x + rect2.width)\r\n    const maxY: number = Math.max(rect1.y + rect1.height, rect2.y + rect2.height)\r\n    const minX: number = Math.min(rect1.x, rect2.x)\r\n    const minY: number = Math.min(rect1.y, rect2.y)\r\n    return maxX - minX <= rect1.width + rect2.width && maxY - minY <= rect1.height + rect2.height\r\n  }\r\n  return false\r\n}\r\n\r\nexport const findIndexById = (nodeId: string, nodes: INodeType[]) => nodes.findIndex((node) => node.id === nodeId)\r\n\r\nexport const getNodeStyle = (nodeDom: Element): INodeStyle => {\r\n  const dom = nodeDom as HTMLElement\r\n  const width = dom.offsetWidth\r\n  const height = dom.offsetHeight\r\n  return {\r\n    width,\r\n    height,\r\n    left: dom.offsetLeft,\r\n    top: dom.offsetTop,\r\n    right: dom.offsetLeft + width,\r\n    bottom: dom.offsetTop + height,\r\n  }\r\n}\r\n\r\nexport const batchUpdateCoordinates = (\r\n  nodeId: string,\r\n  nextCoordinates: ICoordinateType,\r\n  nodes: INodeType[],\r\n  activeNodeIds: string[]\r\n): INodeType[] => {\r\n  const nextNodes = [...nodes]\r\n\r\n  const index = findIndexById(nodeId, nextNodes)\r\n\r\n  const offsetCoordinate = {\r\n    xOffset: nextCoordinates[0] - nodes[index].coordinates[0],\r\n    yOffset: nextCoordinates[1] - nodes[index].coordinates[1],\r\n  }\r\n  // update activeNodeIds\r\n  activeNodeIds.forEach((activeNodeId) => {\r\n    nextNodes.some((node, nextIndex) => {\r\n      if (node.id === activeNodeId) {\r\n        nextNodes[nextIndex] = {\r\n          ...nextNodes[nextIndex],\r\n          coordinates: [\r\n            getInteger(node.coordinates[0] + offsetCoordinate.xOffset),\r\n            getInteger(node.coordinates[1] + offsetCoordinate.yOffset),\r\n          ],\r\n        }\r\n        return true\r\n      } else {\r\n        return false\r\n      }\r\n    })\r\n  })\r\n  // update self\r\n  nextNodes[index] = {\r\n    ...nextNodes[index],\r\n    coordinates: [getInteger(nextCoordinates[0]), getInteger(nextCoordinates[1])],\r\n  }\r\n\r\n  return nextNodes\r\n}\r\n\r\nexport const oneNodeDelete = (value: IDiagramType, nodeId: string): IDiagramType => {\r\n  const nextNodes = [...value.nodes]\r\n  const index = findIndexById(nodeId, nextNodes)\r\n  const currentNode = value.nodes[index]\r\n  const nodeOutputs = currentNode.outputs.map((port) => port.id)\r\n  const nodeInputs = currentNode.inputs.map((port) => port.id)\r\n  nextNodes.splice(index, 1)\r\n  // 删除和节点相关的所有线\r\n  let nextLinks = value.links.filter((link) => {\r\n    return (\r\n      !nodeInputs.includes(link.output) &&\r\n      !nodeOutputs.includes(link.input) &&\r\n      link.input !== nodeId &&\r\n      link.output !== nodeId\r\n    )\r\n  })\r\n  return { links: nextLinks, nodes: nextNodes }\r\n}\r\n\r\nexport const checkIsFocusInPanel = (panelDom: HTMLElement | null) => document.activeElement === panelDom\r\n\r\n/*\r\n * 画出 link 的 svg 矩形容器，和位置，并且重新计算在 矩形容器内的起点和终点\r\n * */\r\nexport const computedLinkSvgInfo = (input: ICoordinateType, output: ICoordinateType) => {\r\n  const width = Math.abs(output[0] - input[0])\r\n  const height = Math.abs(output[1] - input[1])\r\n  const MIN_SIZE = 1\r\n  let left = 0\r\n  let top = 0\r\n  const start = { x: 0, y: 0 }\r\n  const end = { x: 0, y: 0 }\r\n\r\n  // x 轴防方向\r\n  if (output[0] > input[0]) {\r\n    left = input[0]\r\n\r\n    start.x = 0\r\n    end.x = width\r\n  } else {\r\n    left = output[0]\r\n\r\n    start.x = width\r\n    end.x = 0\r\n  }\r\n\r\n  // y 轴防方向\r\n  if (output[1] > input[1]) {\r\n    top = input[1]\r\n\r\n    start.y = 0\r\n    end.y = height\r\n  } else {\r\n    top = output[1]\r\n\r\n    start.y = height\r\n    end.y = 0\r\n  }\r\n\r\n  return {\r\n    width: Math.floor(width) || MIN_SIZE,\r\n    height: Math.floor(height) || MIN_SIZE,\r\n    left: Math.floor(left),\r\n    top: Math.floor(top),\r\n    start: [start.x, start.y],\r\n    end: [end.x, end.y],\r\n  }\r\n}\r\n\r\n/*\r\n * 检测鼠标滚轮方向\r\n */\r\nexport const checkWheelDirection = (event: any) => {\r\n  let wheelDown = false\r\n  let wheelUp = false\r\n  let deltaY = 0\r\n\r\n  // in chrome\r\n  if (event.wheelDelta) {\r\n    deltaY = -event.wheelDelta\r\n    wheelDown = event.wheelDelta < 0\r\n    wheelUp = event.wheelDelta > 0\r\n    // in firefox\r\n  } else {\r\n    deltaY = event.deltaY\r\n    wheelDown = event.deltaX > 0 || event.deltaY > 0 || event.deltaZ > 0\r\n    wheelUp = event.deltaX < 0 || event.deltaY < 0 || event.deltaZ < 0\r\n  }\r\n  return {\r\n    wheelDown,\r\n    wheelUp,\r\n    deltaY,\r\n  }\r\n}\r\n\r\nconst BASE_NUM = 2\r\nexport const getInteger = (num: number) => {\r\n  const integer = Math.floor(num / BASE_NUM)\r\n  let remainder = num % BASE_NUM\r\n\r\n  remainder = remainder > BASE_NUM / 2 ? BASE_NUM : 0\r\n\r\n  const res = integer * BASE_NUM + remainder\r\n  return res\r\n}\r\n\r\nexport const isMac = (() => /macintosh|mac os x/i.test(navigator.userAgent))()\r\n\r\nexport const isCtrlOrCommandPress = () => isMac || hotkeys.ctrl\r\n","import React, { useEffect, useRef } from 'react'\r\nimport useDrag from '../../hooks/useDrag'\r\nimport { ICoordinateType, IPointType } from '../../types'\r\nimport { calculatingCoordinates, findEventTargetParentNodeId } from '../../utils'\r\nimport { useDiagramManager } from '../Context/DiagramManager'\r\nimport classnames from 'classnames'\r\nimport { usePortManager } from '../Context/PortManager'\r\n\r\ninterface PortProps extends IPointType {\r\n  nodeId: string\r\n}\r\n\r\nexport const Port: React.FC<PortProps> = React.memo((props) => {\r\n  const { id, isLinked, nodeId } = props\r\n  const { scale, canvasRef } = useDiagramManager()\r\n  const { onDragNewSegment, onSegmentFail, onSegmentConnect, onShowSelectModel, onPortMount } = usePortManager()\r\n  const ref: any = useRef<React.RefObject<HTMLElement>>(null)\r\n  const startCoordinatesRef = useRef<ICoordinateType | undefined>()\r\n\r\n  const className = classnames('diagram-port', {\r\n    'is-linked': isLinked,\r\n  })\r\n\r\n  const { onDragStart, onDrag, onDragEnd } = useDrag({ ref, throttleBy: 16 })\r\n\r\n  onDragStart((event: MouseEvent) => {\r\n    event.stopImmediatePropagation()\r\n    event.stopPropagation()\r\n    if (canvasRef && ref.current) {\r\n      const { x: canvasX, y: canvasY } = canvasRef.getBoundingClientRect()\r\n      const { x, y, width, height } = ref.current.getBoundingClientRect()\r\n      startCoordinatesRef.current = [(x - canvasX + width / 2) / scale, (y - canvasY + height / 2) / scale]\r\n    }\r\n  })\r\n\r\n  onDrag((event: MouseEvent) => {\r\n    if (startCoordinatesRef.current) {\r\n      event.stopImmediatePropagation()\r\n      event.stopPropagation()\r\n      const to: ICoordinateType = calculatingCoordinates(event, canvasRef, scale)\r\n\r\n      onDragNewSegment(id, startCoordinatesRef.current, to)\r\n    }\r\n  })\r\n\r\n  onDragEnd((event: MouseEvent) => {\r\n    const targetDom = event.target as HTMLElement\r\n    const targetIsPort = targetDom.classList.contains('diagram-port')\r\n    // 如果目标元素是 port 区域 并且不是起点port\r\n    if (targetIsPort && targetDom.id !== id) {\r\n      onSegmentConnect(id, targetDom.id)\r\n      return\r\n    }\r\n\r\n    // 如果目标元素是 node 区域 并非不是起点node\r\n    const targetNode = findEventTargetParentNodeId(event.target as HTMLElement)\r\n    if (targetNode && targetNode !== nodeId) {\r\n      onSegmentConnect(id, targetNode)\r\n      return\r\n    }\r\n    const panelDom = document.getElementById('diagram-panel')\r\n    if (panelDom && panelDom.contains(event.target as HTMLElement)) {\r\n      onShowSelectModel(event, id)\r\n    }\r\n    // 否则在空白区域松开 释放\r\n    onSegmentFail && onSegmentFail(id)\r\n  })\r\n\r\n  useEffect(() => {\r\n    onPortMount(id, ref.current)\r\n  }, [id, onPortMount])\r\n\r\n  return <b className={className} id={id} ref={ref} />\r\n})\r\n","import React from 'react'\r\nimport { Input } from 'antd'\r\nimport './style.scss'\r\nimport { INodeItemProps } from '../../types'\r\nimport { NodeTypeHeader } from './NodeTypeHeader'\r\nimport { nodesConfig } from './config'\r\nimport { Port } from '../Diagram/Port'\r\n\r\nexport interface NodeTypeCustomRenderPortProps extends INodeItemProps<any> {}\r\n\r\nexport const NodeTypeCustomRenderPort: React.FC<NodeTypeCustomRenderPortProps> = (props) => {\r\n  const { value, onChange, outputs, nodeId } = props\r\n\r\n  const handleInputChange = (e: any) => {\r\n    const index = e.target.dataset.index\r\n    const newBranchList = [...value.branchList]\r\n    newBranchList[index].text = e.target.value\r\n    onChange({\r\n      ...value,\r\n      branchList: newBranchList,\r\n    })\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <NodeTypeHeader\r\n        icon={nodesConfig.nodeTypeCustomRenderPort.icon}\r\n        label={nodesConfig.nodeTypeCustomRenderPort.label}\r\n      />\r\n      <div className=\"node-content\">\r\n        {value.branchList.map((item: any, index: number) => (\r\n          <div className=\"branch-input\" key={index}>\r\n            <Input placeholder=\"Input message here\" value={item.text} data-index={index} onChange={handleInputChange} />\r\n            {outputs && <Port id={outputs[index].id} isLinked={outputs[index].isLinked} nodeId={nodeId} />}\r\n          </div>\r\n        ))}\r\n      </div>\r\n    </>\r\n  )\r\n}\r\n\r\nNodeTypeCustomRenderPort.displayName = 'NodeTypeCustomRenderPort'\r\n","import React from 'react'\r\nimport { Input } from 'antd'\r\nimport './style.scss'\r\nimport { INodeItemProps } from '../../types'\r\nimport { NodeTypeHeader } from './NodeTypeHeader'\r\nimport { nodesConfig } from './config'\r\nconst { TextArea } = Input\r\n\r\nexport interface NodeTypeNoInputOutputProps extends INodeItemProps<any> {}\r\n\r\nexport const NodeTypeNoInputOutput: React.FC<NodeTypeNoInputOutputProps> = (props) => {\r\n  const { value, onChange } = props\r\n  const handleInputChange = (e: any) => {\r\n    onChange({\r\n      ...value,\r\n      inputValue: e.target.value,\r\n    })\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <NodeTypeHeader icon={nodesConfig.nodeTypeNoInputOutput.icon} label={nodesConfig.nodeTypeNoInputOutput.label} />\r\n      <div className=\"node-content\">\r\n        <TextArea placeholder=\"Input message here\" rows={2} value={value.inputValue} onChange={handleInputChange} />\r\n      </div>\r\n    </>\r\n  )\r\n}\r\n\r\nNodeTypeNoInputOutput.displayName = 'NodeTypeNoInputOutput'\r\n","import { NodeTypeSingleOutputs } from './NodeTypeSingleOutputs'\r\nimport { NodeTypeSingleInputs } from './NodeTypeSingleInputs'\r\nimport { NodeTypeCustomRenderPort } from './NodeTypeCustomRenderPort'\r\nimport { NodeTypeNoInputOutput } from './NodeTypeNoInputOutput'\r\nimport { AppleOutlined, WindowsOutlined, GithubOutlined } from '@ant-design/icons'\r\nimport { v4 as uuidv4 } from 'uuid'\r\nimport { ICoordinateType, INodeType, NodeTypeEnum } from '../../types'\r\nimport { NodeTypeMultipleInputsOutputs } from './NodeTypeMultipleInputsOutputs'\r\n/*\r\n * 1. 单出口节点\r\n * 2. 单入口节点\r\n * 3. 无出入口节点\r\n * 4. 多出口 多入口节点\r\n * 5. 自定义渲染节点\r\n */\r\nexport enum NodeTypes {\r\n  nodeTypeSingleOutputs = 'nodeTypeSingleOutputs', // 单出口节点\r\n  nodeTypeSingleInputs = 'nodeTypeSingleInputs', // 单入口节点\r\n  nodeTypeNoInputOutput = 'nodeTypeNoInputOutput', // 无出入口节点\r\n  nodeTypeMultipleInputsOutputs = 'nodeTypeMultipleInputsOutputs', // 多出口 多入口节点\r\n  nodeTypeCustomRenderPort = 'nodeTypeCustomRenderPort', // 自定义渲染节点\r\n}\r\n\r\nexport const nodesConfig = {\r\n  [NodeTypes.nodeTypeSingleOutputs]: {\r\n    component: NodeTypeSingleOutputs,\r\n    label: '单出口 节点',\r\n    icon: AppleOutlined,\r\n    customRenderPort: false,\r\n    defaultValue: () => {\r\n      return {\r\n        id: uuidv4(),\r\n        coordinates: [0, 0],\r\n        type: NodeTypes.nodeTypeSingleOutputs,\r\n        inputs: [],\r\n        outputs: [{ id: uuidv4(), isLinked: false }],\r\n        data: {\r\n          inputValue: '',\r\n        },\r\n      }\r\n    },\r\n  },\r\n  [NodeTypes.nodeTypeSingleInputs]: {\r\n    component: NodeTypeSingleInputs,\r\n    label: '单入口 节点',\r\n    icon: WindowsOutlined,\r\n    customRenderPort: false,\r\n    defaultValue: () => {\r\n      return {\r\n        id: uuidv4(),\r\n        coordinates: [0, 0],\r\n        type: NodeTypes.nodeTypeSingleInputs,\r\n        inputs: [{ id: uuidv4(), isLinked: false }],\r\n        outputs: [],\r\n        data: {\r\n          inputValue: '',\r\n          selectValue: '',\r\n        },\r\n      }\r\n    },\r\n  },\r\n  [NodeTypes.nodeTypeNoInputOutput]: {\r\n    component: NodeTypeNoInputOutput,\r\n    label: '无出入口 节点',\r\n    icon: WindowsOutlined,\r\n    customRenderPort: false,\r\n    defaultValue: () => {\r\n      return {\r\n        id: uuidv4(),\r\n        coordinates: [0, 0],\r\n        type: NodeTypes.nodeTypeNoInputOutput,\r\n        inputs: [],\r\n        outputs: [],\r\n        data: {\r\n          inputValue: '',\r\n          selectValue: '',\r\n        },\r\n      }\r\n    },\r\n  },\r\n  [NodeTypes.nodeTypeMultipleInputsOutputs]: {\r\n    component: NodeTypeMultipleInputsOutputs,\r\n    label: '多出口 多入口 节点',\r\n    icon: WindowsOutlined,\r\n    customRenderPort: false,\r\n    defaultValue: () => {\r\n      return {\r\n        id: uuidv4(),\r\n        coordinates: [0, 0],\r\n        type: NodeTypes.nodeTypeNoInputOutput,\r\n        inputs: [\r\n          { id: uuidv4(), isLinked: false },\r\n          { id: uuidv4(), isLinked: false },\r\n        ],\r\n        outputs: [\r\n          { id: uuidv4(), isLinked: false },\r\n          { id: uuidv4(), isLinked: false },\r\n          { id: uuidv4(), isLinked: false },\r\n        ],\r\n        data: {\r\n          inputValue: '',\r\n          selectValue: '',\r\n        },\r\n      }\r\n    },\r\n  },\r\n  [NodeTypes.nodeTypeCustomRenderPort]: {\r\n    component: NodeTypeCustomRenderPort,\r\n    label: '自定义渲染 点 节点',\r\n    icon: GithubOutlined,\r\n    customRenderPort: true,\r\n    defaultValue: () => {\r\n      const branchList = [\r\n        { id: uuidv4(), text: '' },\r\n        { id: uuidv4(), text: '' },\r\n      ]\r\n      // 由数据映射输出点\r\n      const outputs = branchList.map((item) => ({ id: item.id, isLinked: false }))\r\n      return {\r\n        id: uuidv4(),\r\n        coordinates: [0, 0],\r\n        type: NodeTypes.nodeTypeCustomRenderPort,\r\n        inputs: [],\r\n        outputs,\r\n        data: {\r\n          inputValue: '',\r\n          branchList,\r\n        },\r\n      }\r\n    },\r\n  },\r\n}\r\n\r\nexport const nodesList = Object.entries(nodesConfig).map(([key, value]) => {\r\n  return {\r\n    ...value,\r\n    type: key,\r\n  }\r\n})\r\n\r\nexport const createNode = (nodeType: NodeTypeEnum, coordinate: ICoordinateType): INodeType => {\r\n  const { defaultValue } = nodesConfig[nodeType]\r\n\r\n  return { ...defaultValue(), coordinates: coordinate }\r\n}\r\n","import React from 'react'\r\nimport { Input } from 'antd'\r\nimport './style.scss'\r\nimport { INodeItemProps } from '../../types'\r\nimport { NodeTypeHeader } from './NodeTypeHeader'\r\nimport { nodesConfig } from './config'\r\nconst { TextArea } = Input\r\n\r\nexport interface NodeTypeMultipleInputsOutputsProps extends INodeItemProps<any> {}\r\n\r\nexport const NodeTypeMultipleInputsOutputs: React.FC<NodeTypeMultipleInputsOutputsProps> = (props) => {\r\n  const { value, onChange } = props\r\n  const handleInputChange = (e: any) => {\r\n    onChange({\r\n      ...value,\r\n      inputValue: e.target.value,\r\n    })\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <NodeTypeHeader\r\n        icon={nodesConfig.nodeTypeMultipleInputsOutputs.icon}\r\n        label={nodesConfig.nodeTypeMultipleInputsOutputs.label}\r\n      />\r\n      <div className=\"node-content\">\r\n        <TextArea placeholder=\"Input message here\" rows={2} value={value.inputValue} onChange={handleInputChange} />\r\n      </div>\r\n    </>\r\n  )\r\n}\r\n\r\nNodeTypeMultipleInputsOutputs.displayName = 'NodeTypeMultipleInputsOutputs'\r\n","import classnames from 'classnames'\r\nimport React from 'react'\r\nimport { IPointType } from '../../types'\r\nimport { Port } from './Port'\r\n\r\nexport interface DiagramNodePortsProps {\r\n  ports: IPointType[]\r\n  nodeId: string\r\n  type: 'input' | 'output'\r\n}\r\n\r\nexport const DiagramNodePorts: React.FC<DiagramNodePortsProps> = (props) => {\r\n  const { ports: inputs, nodeId, type } = props\r\n\r\n  const className = classnames('diagram-port-wrapper', {\r\n    'type-input': type === 'input',\r\n    'type-output': type === 'output',\r\n  })\r\n  return (\r\n    <>\r\n      <div className={className}>\r\n        {inputs.map((port) => (\r\n          <Port key={port.id} id={port.id} isLinked={port.isLinked} nodeId={nodeId} />\r\n        ))}\r\n      </div>\r\n    </>\r\n  )\r\n}\r\n\r\nDiagramNodePorts.displayName = 'DiagramNodePorts'\r\n","import React, { useCallback } from 'react'\r\nimport { Button } from 'antd'\r\nimport { DeleteOutlined, CopyOutlined } from '@ant-design/icons'\r\n\r\n\r\n// import { DeleteOutlined } from '@ant-design/icons'\r\n\r\n\r\nexport interface DiagramNodeActionButtonsProps {\r\n  id: string\r\n  onNodeCopy: (nodeId: string) => void\r\n  onNodeDelete: (nodeId: string) => void\r\n}\r\n\r\nexport const DiagramNodeActionButtons: React.FC<DiagramNodeActionButtonsProps> = (props) => {\r\n  const {onNodeDelete, onNodeCopy, id} = props\r\n\r\n  const handleNodeDelete = useCallback(() => {\r\n    onNodeDelete(id)\r\n  }, [id, onNodeDelete])\r\n\r\n  const handleNodeCopy = useCallback(() => {\r\n    onNodeCopy(id)\r\n  }, [id, onNodeCopy])\r\n\r\n  return (\r\n    <div className='diagram-node-action'>\r\n      <Button onClick={handleNodeCopy} icon={<CopyOutlined/>}/>\r\n      <Button onClick={handleNodeDelete} icon={<DeleteOutlined/>}/>\r\n    </div>\r\n  )\r\n}\r\n\r\nDiagramNodeActionButtons.displayName = 'DiagramNodeActionButtons'\r\n","export interface Listener {\r\n  cb: Function\r\n  once: boolean\r\n}\r\n\r\nexport interface EventsType {\r\n  [eventName: string]: Listener[]\r\n}\r\n\r\n/**\r\n * const ee = new OnFire();\r\n *\r\n * ee.on('click', (...values) => {});\r\n *\r\n * ee.on('mouseover', (...values) => {});\r\n *\r\n * ee.emit('click', 1, 2, 3);\r\n * ee.fire('mouseover', {}); // same with emit\r\n *\r\n * ee.off();\r\n */\r\nexport default class OnFire {\r\n  static ver = '__VERSION__'\r\n\r\n  // 所有事件的监听器\r\n  es: EventsType = {}\r\n\r\n  on(eventName: string, cb: Function, once: boolean = false) {\r\n    if (!this.es[eventName]) {\r\n      this.es[eventName] = []\r\n    }\r\n\r\n    this.es[eventName].push({\r\n      cb,\r\n      once,\r\n    })\r\n  }\r\n\r\n  once(eventName: string, cb: Function) {\r\n    this.on(eventName, cb, true)\r\n  }\r\n\r\n  fire(eventName: string, ...params: any[]) {\r\n    const listeners = this.es[eventName] || []\r\n\r\n    let l = listeners.length\r\n\r\n    for (let i = 0; i < l; i++) {\r\n      const { cb, once } = listeners[i]\r\n\r\n      cb.apply(this, params)\r\n\r\n      if (once) {\r\n        listeners.splice(i, 1)\r\n        i--\r\n        l--\r\n      }\r\n    }\r\n  }\r\n\r\n  off(eventName?: string, cb?: Function) {\r\n    // clean all\r\n    if (eventName === undefined) {\r\n      this.es = {}\r\n    } else {\r\n      if (cb === undefined) {\r\n        // clean the eventName's listeners\r\n        delete this.es[eventName]\r\n      } else {\r\n        const listeners = this.es[eventName] || []\r\n        // clean the event and listener\r\n        let l = listeners.length\r\n        for (let i = 0; i < l; i++) {\r\n          if (listeners[i].cb === cb) {\r\n            listeners.splice(i, 1)\r\n            i--\r\n            l--\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // cname of fire\r\n  emit(eventName: string, ...params: any[]) {\r\n    this.fire(eventName, ...params)\r\n  }\r\n}\r\n","import EE from './onfire'\r\n\r\nexport const EVENT_NODE_MOVING = 'NODE_MOVING'\r\nexport const EVENT_NODE_MOVE_END = 'NODE_MOVE_END'\r\n\r\nexport const EVENT_AUTO_LAYOUT = 'AUTO_LAYOUT'\r\n\r\nexport default new EE()\r\n","import React, { useCallback, useEffect, useMemo, useRef } from 'react'\r\nimport useDrag from '../../hooks/useDrag'\r\nimport { INodeType, ICoordinateType } from '../../types'\r\nimport { nodesConfig } from '../NodeTypes/config'\r\nimport { isEqual } from 'lodash-es'\r\nimport { useScale } from '../Context/DiagramManager'\r\nimport { DiagramNodePorts } from './DiagramNodePorts'\r\nimport classnames from 'classnames'\r\nimport { DiagramNodeActionButtons } from './DiagramNodeActionButtons'\r\nimport eventBus, { EVENT_NODE_MOVE_END, EVENT_NODE_MOVING } from '../../utils/eventBus'\r\n\r\ninterface DiagramNodeProps {\r\n  nodeInfo: INodeType\r\n  onNodePositionChange: (id: string, nextCoords: ICoordinateType) => void\r\n  onNodeValueChange: (id: string, nextNodeValue: any) => void\r\n  onAddHistory: (id: string, nextCoords: ICoordinateType) => void\r\n  onNodeMount: (id: string, dom: HTMLDivElement) => void\r\n  onNodeDelete: (nodeId: string) => void\r\n  onNodeCopy: (nodeId: string) => void\r\n  onToggleActiveNodeId: (nodeId: string) => void\r\n  isActive: boolean\r\n}\r\n\r\nexport const DiagramNode: React.FC<DiagramNodeProps> = React.memo((props) => {\r\n  const {\r\n    nodeInfo,\r\n    onNodeValueChange,\r\n    onNodePositionChange,\r\n    onNodeMount,\r\n    onAddHistory,\r\n    onToggleActiveNodeId,\r\n    isActive,\r\n    onNodeDelete,\r\n    onNodeCopy,\r\n  } = props\r\n\r\n  const { id, coordinates, type, inputs, data, outputs } = nodeInfo\r\n\r\n  const scale = useScale()\r\n\r\n  // nodeType\r\n  const nodeConfig = nodesConfig[type]\r\n\r\n  const handleNodeDataChange = (nextNodeData: any) => {\r\n    onNodeValueChange(id, nextNodeData)\r\n  }\r\n\r\n  // 传给子组件点 Props\r\n  const nodeItemProps = {\r\n    value: data,\r\n    onChange: handleNodeDataChange,\r\n    nodeId: id,\r\n    inputs: nodeConfig?.customRenderPort ? inputs : undefined,\r\n    outputs: nodeConfig?.customRenderPort ? outputs : undefined,\r\n  }\r\n\r\n  const ref: any = useRef(null)\r\n\r\n  const { onDragStart, onDrag, onDragEnd } = useDrag({ throttleBy: 16, ref }) // get the drag n drop methods\r\n  const dragStartPoint = useRef(coordinates) // keeps the drag start point in a persistent reference\r\n\r\n  // when drag starts, save the starting coordinates into the `dragStartPoint` ref\r\n  onDragStart(() => {\r\n    dragStartPoint.current = coordinates\r\n  })\r\n\r\n  // whilst dragging calculates the next coordinates and perform the `onNodePositionChange` callback\r\n  onDrag((event: MouseEvent, info: any) => {\r\n    event.stopImmediatePropagation()\r\n    event.stopPropagation()\r\n    const nextCoords: ICoordinateType = [\r\n      dragStartPoint.current[0] + info.offset[0] / scale,\r\n      dragStartPoint.current[1] + info.offset[1] / scale,\r\n    ]\r\n\r\n    onNodePositionChange(id, nextCoords)\r\n    eventBus.emit(EVENT_NODE_MOVING, id, nextCoords)\r\n  })\r\n\r\n  onDragEnd((event: MouseEvent) => {\r\n    if (!isEqual(dragStartPoint.current, coordinates)) {\r\n      onAddHistory(id, dragStartPoint.current)\r\n    }\r\n    eventBus.emit(EVENT_NODE_MOVE_END)\r\n  })\r\n\r\n  const handleClick = useCallback(\r\n    (event: React.MouseEvent<HTMLDivElement, MouseEvent>) => {\r\n      if (event.shiftKey) {\r\n        onToggleActiveNodeId(id)\r\n      }\r\n    },\r\n    [id, onToggleActiveNodeId]\r\n  )\r\n\r\n  useEffect(() => {\r\n    onNodeMount(id, ref.current)\r\n  }, [id, onNodeMount])\r\n\r\n  const className = useMemo(() => {\r\n    return classnames('diagram-node', {\r\n      active: isActive,\r\n    })\r\n  }, [isActive])\r\n\r\n  if (!nodeConfig.component) {\r\n    console.warn(`NodeType \"${type}\" does not exist`)\r\n\r\n    return null\r\n  }\r\n\r\n  return (\r\n    <div\r\n      id={id}\r\n      className={className}\r\n      ref={ref}\r\n      style={{ left: coordinates[0], top: coordinates[1] }}\r\n      onClick={handleClick}\r\n    >\r\n      {nodeConfig.component && React.createElement(nodeConfig.component, nodeItemProps)}\r\n      {!nodeConfig.customRenderPort && (\r\n        <>\r\n          <DiagramNodePorts ports={inputs} nodeId={id} type=\"input\" />\r\n          <DiagramNodePorts ports={outputs} nodeId={id} type=\"output\" />\r\n        </>\r\n      )}\r\n      <DiagramNodeActionButtons id={id} onNodeDelete={onNodeDelete} onNodeCopy={onNodeCopy} />\r\n    </div>\r\n  )\r\n})\r\n\r\nDiagramNode.displayName = 'DiagramNode'\r\n","import React from 'react'\r\nimport { DiagramNode } from './DiagramNode'\r\nimport { ICoordinateType, INodeType } from '../../types'\r\n\r\ninterface NodesCanvasProps {\r\n  nodes: INodeType[]\r\n  onNodeMount: (id: string, dom: HTMLDivElement) => void\r\n  activeNodeIds: string[]\r\n  onNodePositionChange: (id: string, nextCoords: ICoordinateType) => void\r\n  onNodeValueChange: (id: string, nextNodeValue: any) => void\r\n  onAddHistory: (id: string, nextCoords: ICoordinateType) => void\r\n  onNodeDelete: (nodeId: string) => void\r\n  onNodeCopy: (nodeId: string) => void\r\n  onToggleActiveNodeId: (nodeId: string) => void\r\n}\r\n\r\nexport const NodesCanvas: React.FC<NodesCanvasProps> = React.memo((props) => {\r\n  const { nodes, activeNodeIds, ...others } = props\r\n\r\n  return (\r\n    <>\r\n      {nodes.map((node) => (\r\n        <DiagramNode isActive={activeNodeIds.includes(node.id)} nodeInfo={node} key={node.id} {...others} />\r\n      ))}\r\n    </>\r\n  )\r\n})\r\n\r\nNodesCanvas.displayName = 'NodesCanvas'\r\n","import { ICoordinateType } from '../types'\r\n\r\nconst roundPoint = (point: ICoordinateType): ICoordinateType => [Math.floor(point[0]), Math.floor(point[1])]\r\n\r\n// 贝塞尔曲线算法\r\nconst makeBezierCurve = (from: ICoordinateType, to: ICoordinateType) => {\r\n  if (to[0] >= from[0]) {\r\n    return getCubicBezierPath(from, to)\r\n  } else {\r\n    return getAdvancedCubicBezierPath(from, to)\r\n  }\r\n}\r\n\r\nconst getPointsString = (points: ICoordinateType[]) => {\r\n  return points.map((item) => `${item[0]},${item[1]}`).join(' ')\r\n}\r\n\r\n// 正向 贝塞尔曲线\r\nconst getCubicBezierPath = (from: ICoordinateType, to: ICoordinateType) => {\r\n  const controlPointForStart: ICoordinateType = [(to[0] + from[0]) / 2, from[1]]\r\n  const controlPointForEnd: ICoordinateType = [(to[0] + from[0]) / 2, to[1]]\r\n\r\n  return `M ${from[0]},${from[1]} C ${getPointsString([controlPointForStart, controlPointForEnd])} ${to[0]},${to[1]}`\r\n}\r\n\r\n// 反向 贝塞尔曲线\r\nconst getAdvancedCubicBezierPath = (from: ICoordinateType, to: ICoordinateType) => {\r\n  const midX = (from[0] + to[0]) / 2\r\n  const midY = (from[1] + to[1]) / 2\r\n\r\n  return `M${from[0]},${from[1]} ${from[0] + 20},${from[1]} C ${from[0] + 100},${from[1]} ${from[0] + 130},${\r\n    (midY + from[1]) / 2\r\n  }  ${midX},${midY} C ${midX},${midY} ${to[0] - 130},${(midY + to[1]) / 2} ${to[0] - 2},${to[1]} M ${to[0] - 2},${\r\n    to[1]\r\n  } ${to[0]},${to[1]}`\r\n}\r\n\r\n/**\r\n * 生成连点之间的贝塞尔曲线\r\n */\r\nconst makeSvgPath = (startPoint?: ICoordinateType, endPoint?: ICoordinateType) => {\r\n  if (!startPoint || !endPoint) return ''\r\n  const roundedStart = roundPoint(startPoint)\r\n  const roundedEnd = roundPoint(endPoint)\r\n\r\n  // const start = `${roundedStart[0]}, ${roundedStart[1]}`\r\n  // const end = `${roundedEnd[0]}, ${roundedEnd[1]}`\r\n\r\n  // 生成 直线\r\n  // return `M ${start}, ${end}`\r\n\r\n  // 生成 曲线\r\n  return makeBezierCurve(roundedStart, roundedEnd)\r\n}\r\n\r\nexport default makeSvgPath\r\n","import React, { useCallback, useMemo, useRef } from 'react'\r\nimport makeSvgPath from '../../utils/makeSvgPath'\r\nimport { ICoordinateType, ILinkType } from '../../types'\r\nimport { isEqual } from 'lodash-es'\r\nimport { computedLinkSvgInfo } from '../../utils'\r\n\r\ninterface LinkProps {\r\n  input: ICoordinateType\r\n  output: ICoordinateType\r\n  link: ILinkType\r\n  onDelete: (link: ILinkType) => void\r\n}\r\n\r\nexport const Link: React.FC<LinkProps> = React.memo(\r\n  (props) => {\r\n    const { input, output, link, onDelete } = props\r\n    const svgRef = useRef<SVGSVGElement>(null)\r\n\r\n    /*\r\n     * 画出 link 的 svg 矩形容器，和位置，并且重新计算在 矩形容器内的起点和终点\r\n     * */\r\n    const { width, height, left, top, start, end } = useMemo(() => computedLinkSvgInfo(input, output), [input, output])\r\n\r\n    /*\r\n     * 根据两点坐标生成 svg path 路径\r\n     * */\r\n    const path = useMemo(() => makeSvgPath(start as ICoordinateType, end as ICoordinateType), [start, end])\r\n\r\n    const handleDelete = useCallback(() => {\r\n      onDelete(link)\r\n    }, [onDelete, link])\r\n\r\n    const handleMouseOver = useCallback(() => {\r\n      svgRef.current?.classList.add('hover')\r\n    }, [])\r\n\r\n    const handleMouseOut = useCallback(() => {\r\n      svgRef.current?.classList.remove('hover')\r\n    }, [])\r\n\r\n    return (\r\n      <svg\r\n        ref={svgRef}\r\n        className={'diagram-link'}\r\n        style={{ left, top }}\r\n        width={width}\r\n        height={height}\r\n        pointerEvents=\"none\"\r\n      >\r\n        <path d={path} className=\"bi-link-path\" />\r\n        <path\r\n          d={path}\r\n          className=\"bi-link-ghost\"\r\n          onDoubleClick={handleDelete}\r\n          onMouseOver={handleMouseOver}\r\n          onMouseOut={handleMouseOut}\r\n        />\r\n      </svg>\r\n    )\r\n  },\r\n  (prev, next) => {\r\n    /*\r\n     *  memo 默认是浅比较 只比较 props 第一层\r\n     *  由于 props 上面 的 input output 等属性在外层每次会重新创建 导致浅层 比较地址 永远等于 false ，使得组件每次都会render 导致memo无效\r\n     * 所以使用 isEqual 进行值的比较 进行优化\r\n     */\r\n    return isEqual(prev, next)\r\n  }\r\n)\r\n\r\nLink.displayName = 'Link'\r\n","import React, { useMemo } from 'react'\r\nimport { Link } from './Link'\r\nimport { ILinkType, INodeType, ICoordinateType, IPortRefs, INodeRefs, IPointType } from '../../types'\r\nimport { useDiagramManager } from '../Context/DiagramManager'\r\n\r\ninterface LinkCanvasProps {\r\n  nodes: INodeType[]\r\n  links: ILinkType[]\r\n  onDelete: (link: ILinkType) => void\r\n}\r\n\r\n/*\r\n * link 起点终点 数据类型\r\n * */\r\nexport interface EntityPutType {\r\n  startCoordinates: ICoordinateType\r\n  endCoordinates: ICoordinateType\r\n  link: ILinkType\r\n}\r\n\r\nexport const LinksCanvas: React.FC<LinkCanvasProps> = React.memo((props) => {\r\n  const { nodes, onDelete, links } = props\r\n\r\n  const { canvasRef, portRefs, nodeRefs, scale } = useDiagramManager()\r\n\r\n  const result = useMemo(() => {\r\n    const res: EntityPutType[] = []\r\n\r\n    links.forEach((link) => {\r\n      const { input, output } = link\r\n      const startCoordinates = computedLinkCoordinate({\r\n        nodes,\r\n        entityId: input,\r\n        nodeRefs,\r\n        portRefs,\r\n        canvasRef,\r\n        scale,\r\n      })\r\n      const endCoordinates = computedLinkCoordinate({\r\n        nodes,\r\n        entityId: output,\r\n        nodeRefs,\r\n        portRefs,\r\n        canvasRef,\r\n        scale,\r\n      })\r\n      if (startCoordinates && endCoordinates) {\r\n        res.push({\r\n          link,\r\n          startCoordinates,\r\n          endCoordinates,\r\n        })\r\n      }\r\n    })\r\n    return res\r\n    //  eslint-disable-next-line\r\n  }, [nodes, links, nodeRefs, portRefs, canvasRef]) // 不要依赖 scale 因为缩放的时候不用重新计算位置\r\n\r\n  return (\r\n    <>\r\n      {result.map((item) => (\r\n        <Link\r\n          link={item.link}\r\n          input={item.startCoordinates}\r\n          output={item.endCoordinates}\r\n          onDelete={onDelete}\r\n          key={`${item.link.input}-${item.link.output}`}\r\n        />\r\n      ))}\r\n    </>\r\n  )\r\n})\r\nLinksCanvas.displayName = 'LinksCanvas'\r\n\r\n/*\r\n * 计算点相对于node左上角的相对值\r\n */\r\nexport const calculatingPortRelativeNode = (nodeDom: Element, portDom: Element, scale: number) => {\r\n  const nodeRect = nodeDom.getBoundingClientRect()\r\n  const portRect = portDom.getBoundingClientRect()\r\n  return {\r\n    offsetLeft: (portRect.left - nodeRect.left) / scale,\r\n    offsetTop: (portRect.top - nodeRect.top) / scale,\r\n  }\r\n}\r\n\r\n/*\r\n * 计算点的坐标\r\n */\r\n\r\ninterface IFindPortCoordinate {\r\n  nodeCoordinates: ICoordinateType\r\n  ports: IPointType[]\r\n  entityId: string\r\n  portRefs: IPortRefs\r\n  nodeDom: HTMLDivElement\r\n  scale: number\r\n}\r\nconst findPortCoordinate = ({\r\n  nodeCoordinates,\r\n  ports,\r\n  entityId,\r\n  portRefs,\r\n  nodeDom,\r\n  scale,\r\n}: IFindPortCoordinate): ICoordinateType | null => {\r\n  for (let j = 0; j < ports.length; j++) {\r\n    const input = ports[j]\r\n\r\n    if (input.id === entityId) {\r\n      const portDom = portRefs[entityId]\r\n\r\n      if (!portDom) return null\r\n\r\n      // const { offsetLeft, offsetTop, offsetWidth, offsetHeight } = portDom\r\n      const { offsetWidth, offsetHeight } = portDom\r\n      // 不依赖 position absolute 定位 可以随意渲染 port 位置\r\n      const { offsetLeft, offsetTop } = calculatingPortRelativeNode(nodeDom, portDom, scale)\r\n\r\n      return [nodeCoordinates[0] + offsetLeft + offsetWidth / 2, nodeCoordinates[1] + offsetTop + offsetHeight / 2]\r\n    }\r\n  }\r\n  return null\r\n}\r\n\r\n/*\r\n * 计算 link 起点终点坐标\r\n * 1. 如果找到 id 是 node 类型线，实际坐标为 x 为该 node 的 left 值，y坐标为该node 的 top + node高度的一半\r\n * 2. 如果找到 id 是 port 类型线，实际坐标为 x 为该 port 的 父元素 node 的 left + 点相对 node 的偏移量 +点的宽度的一半，y 轴坐标同理\r\n * */\r\ninterface IComputedLinkCoordinate {\r\n  nodes: INodeType[]\r\n  entityId: string\r\n  nodeRefs: INodeRefs\r\n  portRefs: IPortRefs\r\n  canvasRef: HTMLDivElement | null\r\n  scale: number\r\n}\r\n\r\nconst computedLinkCoordinate = ({\r\n  nodes,\r\n  entityId,\r\n  nodeRefs,\r\n  portRefs,\r\n  canvasRef,\r\n  scale,\r\n}: IComputedLinkCoordinate): ICoordinateType | null => {\r\n  for (let i = 0; i < nodes.length; i++) {\r\n    const node = nodes[i]\r\n    const nodeEl = nodeRefs[node.id]\r\n\r\n    // 如果 id 是 nodeId\r\n    if (node.id === entityId) {\r\n      if (!nodeEl) return null\r\n      return [node.coordinates[0], node.coordinates[1] + nodeEl.offsetHeight / 2]\r\n    } else {\r\n      const inputRes = findPortCoordinate({\r\n        nodeCoordinates: node.coordinates,\r\n        ports: node.inputs,\r\n        entityId,\r\n        portRefs,\r\n        nodeDom: nodeEl,\r\n        scale,\r\n      })\r\n      if (inputRes) return inputRes\r\n\r\n      const outputRes = findPortCoordinate({\r\n        nodeCoordinates: node.coordinates,\r\n        ports: node.outputs,\r\n        entityId,\r\n        portRefs,\r\n        nodeDom: nodeEl,\r\n        scale,\r\n      })\r\n\r\n      if (outputRes) return outputRes\r\n    }\r\n  }\r\n  return null\r\n}\r\n","import React, { useMemo } from 'react'\r\nimport makeSvgPath from '../../utils/makeSvgPath'\r\nimport { ISegmentType } from '../../types'\r\n\r\nexport interface SegmentProps {\r\n  segment: ISegmentType\r\n}\r\n\r\nexport const Segment: React.FC<SegmentProps> = React.memo(({segment}) => {\r\n  const {from, to, id} = segment\r\n  const path = useMemo(() => makeSvgPath(from, to), [from, to])\r\n\r\n  return (\r\n    <svg className=\"diagram-segment-canvas\">\r\n      <g className=\"diagram-segment-link\" id={id}>\r\n        <path d={path}/>\r\n        <circle r=\"5\" cx={to[0]} cy={to[1]}/>\r\n      </g>\r\n    </svg>\r\n  )\r\n})\r\n\r\nSegment.displayName = 'Segment'\r\n\r\n\r\n","import { useLayoutEffect, useMemo, useRef } from 'react'\r\n\r\ntype Fn<ARGS extends any[], R> = (...args: ARGS) => R\r\nconst useEventCallback = <A extends any[], R>(fn: Fn<A, R>): Fn<A, R> => {\r\n  let ref = useRef(fn)\r\n  useLayoutEffect(() => {\r\n    ref.current = fn\r\n  })\r\n  return useMemo(\r\n    () => (...args) => {\r\n      const { current } = ref\r\n      return current(...args)\r\n    },\r\n    []\r\n  )\r\n}\r\nexport default useEventCallback\r\n","import React from 'react'\r\nimport ReactDOM from 'react-dom'\r\nimport { ICoordinateType, NodeTypeEnum } from '../../types'\r\nimport { nodesList } from '../NodeTypes/config'\r\n\r\nexport interface SelectModelProps {\r\n  position?: ICoordinateType\r\n  onChange: (nodeType?: NodeTypeEnum) => void\r\n}\r\n\r\nexport const SelectModel: React.FC<SelectModelProps> = React.memo((prop) => {\r\n  const { position, onChange } = prop\r\n\r\n  if (!position) {\r\n    return null\r\n  }\r\n\r\n  const handleClose = () => {\r\n    onChange()\r\n  }\r\n\r\n  const handleItemClick = (event: React.MouseEvent<HTMLLIElement, MouseEvent>) => {\r\n    onChange(event.currentTarget.dataset.type as NodeTypeEnum)\r\n  }\r\n  const stopEvent = (event: React.MouseEvent<HTMLUListElement, MouseEvent>) => {\r\n    event.stopPropagation()\r\n  }\r\n\r\n  return ReactDOM.createPortal(\r\n    <div className=\"select-model\" onClick={handleClose}>\r\n      <ul\r\n        className=\"select-model-content\"\r\n        style={{ left: position[0], top: position[1], position: 'absolute' }}\r\n        onClick={stopEvent}\r\n      >\r\n        {nodesList.map((node) => (\r\n          <li key={node.type} className=\"select-model-item\" onClick={handleItemClick} data-type={node.type}>\r\n            {node.icon && React.createElement(node.icon)}\r\n            <div className=\"select-model-text\">{node.label}</div>\r\n          </li>\r\n        ))}\r\n      </ul>\r\n    </div>,\r\n    document.body\r\n  )\r\n})\r\n\r\nSelectModel.displayName = 'SelectModel'\r\n","import { groupBy, isEqual, maxBy, omit } from 'lodash-es'\r\nimport { getNodeStyle } from '.'\r\nimport { IDiagramType, ILinkType, INodeRefs, INodeStyle, INodeType, IPointType } from '../types'\r\n\r\nconst checkPortIsNodeSon = (ports: IPointType[], entityId: string) => {\r\n  for (let j = 0; j < ports.length; j++) {\r\n    const input = ports[j]\r\n    if (input.id === entityId) {\r\n      return true\r\n    }\r\n  }\r\n  return false\r\n}\r\n\r\nconst findPortFatherNodeId = (entityId: string, nodes: INodeType[]) => {\r\n  for (let i = 0; i < nodes.length; i++) {\r\n    const node = nodes[i]\r\n    // 如果 id 是 nodeId\r\n    if (node.id === entityId) {\r\n      return node.id\r\n    } else {\r\n      if (checkPortIsNodeSon(node.inputs, entityId)) return node.id\r\n      if (checkPortIsNodeSon(node.outputs, entityId)) return node.id\r\n    }\r\n  }\r\n  return entityId\r\n}\r\n\r\nconst checkIsStartLink = (linkInput: string, links: ILinkType[], nodes: INodeType[]) =>\r\n  !links.find((link) => link.output === findPortFatherNodeId(linkInput, nodes))\r\n\r\ninterface ExtendActionDto extends INodeType {\r\n  row: number\r\n  column: number\r\n  style: INodeStyle\r\n}\r\n\r\n/*\r\n * 自动排列 需要根据实际的点和线 连接放松排列 这里的自动排列涵盖情况有限 重新排列效果仅供参考\r\n */\r\nexport default function autoLayout(value: IDiagramType, nodeRefs: INodeRefs) {\r\n  const { links = [], nodes = [] } = value\r\n  let row = 1\r\n  const extendNodes = nodes.map((node) => {\r\n    return {\r\n      ...node,\r\n      row: 0,\r\n      column: 0,\r\n      style: getNodeStyle(nodeRefs[node.id]),\r\n    }\r\n  })\r\n\r\n  const recursionLookup = (\r\n    linkEndId: string,\r\n    baseColumn: number,\r\n    extendNodes: ExtendActionDto[],\r\n    links: ILinkType[],\r\n    catchNodeIds: string[]\r\n  ) => {\r\n    if (catchNodeIds.includes(linkEndId)) return\r\n    catchNodeIds.push(linkEndId)\r\n    const currentNode = extendNodes.find((node) => node.id === findPortFatherNodeId(linkEndId, extendNodes))\r\n    if (!currentNode) return\r\n    currentNode.row = currentNode.row || row\r\n    currentNode.column = currentNode.column || baseColumn\r\n    baseColumn++\r\n    let outputHasLinkNum = 0\r\n\r\n    currentNode.outputs.forEach((port) => {\r\n      const findLink = links.find((link) => link.input === port.id)\r\n      if (findLink) {\r\n        outputHasLinkNum++\r\n        if (outputHasLinkNum > 1) {\r\n          row++\r\n        }\r\n        recursionLookup(findLink.output, baseColumn, extendNodes, links, catchNodeIds)\r\n      }\r\n    })\r\n  }\r\n\r\n  links.forEach((link) => {\r\n    if (checkIsStartLink(link.input, links, extendNodes)) {\r\n      const portFatherNodeId = findPortFatherNodeId(link.input, extendNodes)\r\n      const catchNodeIds = [portFatherNodeId]\r\n      const currentNode = extendNodes.find((node) => node.id === portFatherNodeId)\r\n      if (!currentNode) return\r\n      currentNode.row = currentNode.row || row\r\n      currentNode.column = 1\r\n      recursionLookup(link.output, 2, extendNodes, links, catchNodeIds)\r\n      row++\r\n    }\r\n  })\r\n\r\n  // if is init data update row and column\r\n  extendNodes.forEach((node) => {\r\n    if (node.row === 0) {\r\n      node.row = row\r\n      node.column = 1\r\n      row++\r\n    }\r\n  })\r\n\r\n  const extendNodesCopy = [...extendNodes]\r\n  extendNodesCopy.forEach(({ outputs }) => {\r\n    const nextNodeIds: string[] = []\r\n    outputs.forEach((port) => {\r\n      if (port.isLinked) {\r\n        const findLink = links.find((link) => link.input === port.id)\r\n        if (findLink) {\r\n          nextNodeIds.push(findLink.output)\r\n        }\r\n      }\r\n    })\r\n    extendNodes.sort((a, b) => {\r\n      return nextNodeIds.findIndex((nodeId) => a.id === nodeId) - nextNodeIds.findIndex((nodeId) => b.id === nodeId)\r\n    })\r\n  })\r\n\r\n  const SPACING = 50\r\n  const LAYOUT_BASIC_COORDINATE = {\r\n    LEFT: 100,\r\n    TOP: 100,\r\n  }\r\n\r\n  const COLUMN_STEP_WIDTH = 200 + SPACING\r\n  const groupRowMap = groupBy(extendNodes, (item) => item.row)\r\n  const groupRows = Object.values(groupRowMap)\r\n\r\n  // row start top\r\n  let currentTop = LAYOUT_BASIC_COORDINATE.TOP\r\n\r\n  groupRows.forEach((aRow, rowIndex) => {\r\n    // sort by column\r\n    aRow.sort((a, b) => a.column - b.column)\r\n\r\n    aRow.forEach((cell, cellIndex) => {\r\n      if (cellIndex === 0 && rowIndex > 0) {\r\n        const preRow = groupRows[rowIndex - 1]\r\n\r\n        const currentAfterPreRow = preRow.filter((preCell) => preCell.column >= cell.column)\r\n\r\n        const currentAfterPreRowMaxHeightList = currentAfterPreRow.map((cell) => cell.style.height)\r\n\r\n        const rowMaxHeight = maxBy(currentAfterPreRowMaxHeightList) || 0\r\n        currentTop += rowMaxHeight + SPACING\r\n      }\r\n      if (cell.column) {\r\n        cell.coordinates = [(cell.column - 1) * COLUMN_STEP_WIDTH + LAYOUT_BASIC_COORDINATE.LEFT, currentTop]\r\n      }\r\n    })\r\n  })\r\n\r\n  const newNodes = extendNodes.map((node) => {\r\n    return {\r\n      ...omit(node, 'column', 'row', 'style'),\r\n    }\r\n  })\r\n  return { links: links, nodes: newNodes }\r\n}\r\n\r\nexport const diffNodesCoordinates = (oldNodes: INodeType[], newNodes: INodeType[]) => {\r\n  return newNodes.some(({ id, coordinates }) => {\r\n    const find = oldNodes.find((item) => item.id === id)\r\n    if (!find) {\r\n      return true\r\n    } else if (!isEqual(find.coordinates, coordinates)) {\r\n      return true\r\n    } else {\r\n      return false\r\n    }\r\n  })\r\n}\r\n\r\nconst toFixed2 = (num: number) => Number(num.toFixed(2))\r\n\r\nexport const computedAnimationStep = (\r\n  oldNodes: INodeType[],\r\n  newNodes: INodeType[],\r\n  stepCount: number\r\n): INodeTypeWithStep[] => {\r\n  return oldNodes.map((node) => {\r\n    const findNextNode = newNodes.find((item) => item.id === node.id)\r\n    const xStep = findNextNode ? toFixed2((findNextNode.coordinates[0] - node.coordinates[0]) / stepCount) : 0\r\n    const yStep = findNextNode ? toFixed2((findNextNode.coordinates[1] - node.coordinates[1]) / stepCount) : 0\r\n    return {\r\n      ...node,\r\n      xStep,\r\n      yStep,\r\n    }\r\n  })\r\n}\r\n\r\ninterface INodeTypeWithStep extends INodeType {\r\n  xStep: number\r\n  yStep: number\r\n}\r\n\r\ninterface IAutoLayoutAnimation {\r\n  originNodes: INodeType[]\r\n  futureNodes: INodeType[]\r\n  animationFn: (nodes: INodeType[]) => void\r\n  stepCount: number\r\n}\r\n\r\nexport const autoLayoutAnimation = ({ originNodes, futureNodes, animationFn, stepCount }: IAutoLayoutAnimation) => {\r\n  return new Promise((resolve, reject) => {\r\n    try {\r\n      let animationCount = 0\r\n      let nodeWithStep: INodeTypeWithStep[] = computedAnimationStep(originNodes, futureNodes, stepCount)\r\n      const step = () => {\r\n        animationCount = animationCount + 1\r\n        nodeWithStep = nodeWithStep.map((item) => {\r\n          return {\r\n            ...item,\r\n            coordinates: [item.coordinates[0] + item.xStep, item.coordinates[1] + item.yStep],\r\n          }\r\n        })\r\n        const nextNodes: INodeType[] = nodeWithStep.map((item) => ({ ...omit(item, ['xStep', 'yStep']) }))\r\n\r\n        animationFn(nextNodes)\r\n\r\n        if (animationCount < stepCount) {\r\n          requestAnimationFrame(step)\r\n        } else {\r\n          animationFn(futureNodes) // 最后多执行一次保证位置正确\r\n          resolve(futureNodes)\r\n        }\r\n      }\r\n      requestAnimationFrame(step)\r\n    } catch (error) {\r\n      reject(error)\r\n    }\r\n  })\r\n}\r\n","import { useEffect } from 'react'\r\nimport eventBus from '../utils/eventBus'\r\n\r\ninterface UseEventType {\r\n  type: string\r\n  onChange: any\r\n}\r\nconst useEventBus = ({ type, onChange }: UseEventType, dep = []) => {\r\n  useEffect(() => {\r\n    eventBus.on(type, onChange)\r\n    return () => {\r\n      eventBus.off(type, onChange)\r\n    }\r\n  }, [type, onChange, dep])\r\n}\r\nexport default useEventBus\r\n","import { ICoordinateType, IDiagramType, INodeType, IPasteLinkType, ITransform } from '../types'\r\nimport { v4 as uuidv4 } from 'uuid'\r\nimport { cloneDeep, minBy } from 'lodash-es'\r\nimport { getNodeStyle } from '.'\r\n\r\n/*\r\n * 生成copy数据\r\n */\r\nexport const createCopyValue = (value: IDiagramType, activeNodeIds: string[]) => {\r\n  const newNodes = value.nodes.filter((node) => activeNodeIds.includes(node.id))\r\n\r\n  // 1. 找到原始 node 边界\r\n  const minX = minBy(newNodes, 'coordinates[0]')?.coordinates[0] || 0\r\n  const minY = minBy(newNodes, 'coordinates[1]')?.coordinates[1] || 0\r\n\r\n  return {\r\n    nodes: newNodes.map((node) => ({\r\n      ...node,\r\n      coordinates: [node.coordinates[0] - minX, node.coordinates[1] - minY],\r\n    })),\r\n    links: value.links,\r\n  }\r\n}\r\n\r\nconst updatePasteLink = (links: IPasteLinkType[], oldId: string, newId: string) =>\r\n  links.map((link) => {\r\n    const inputUpdated = link.input === oldId\r\n    const outputUpdated = link.output === oldId\r\n    return {\r\n      ...link,\r\n      input: inputUpdated ? newId : link.input,\r\n      output: outputUpdated ? newId : link.output,\r\n      inputUpdated: inputUpdated || link.inputUpdated,\r\n      outputUpdated: outputUpdated || link.outputUpdated,\r\n    }\r\n  })\r\n\r\n/*\r\n * 生成copy数据\r\n */\r\nexport const createPasteValue = (value: IDiagramType, offset: { x: number; y: number }) => {\r\n  let newLinks: IPasteLinkType[] = value.links\r\n\r\n  const newNodes = value.nodes.map((item) => {\r\n    const newNodeId = uuidv4()\r\n    const newCoordinates: ICoordinateType = [item.coordinates[0] + offset.x, item.coordinates[1] + offset.y]\r\n    newLinks = updatePasteLink(newLinks, item.id, newNodeId)\r\n\r\n    return {\r\n      ...item,\r\n      // 重新设置 node 坐标\r\n      coordinates: newCoordinates,\r\n      inputs: item.inputs.map((port) => {\r\n        const newPortId = uuidv4()\r\n        newLinks = updatePasteLink(newLinks, port.id, newPortId)\r\n\r\n        return { ...port, id: newPortId }\r\n      }),\r\n      outputs: item.outputs.map((port) => {\r\n        const newPortId = uuidv4()\r\n        newLinks = updatePasteLink(newLinks, port.id, newPortId)\r\n\r\n        return { ...port, id: newPortId }\r\n      }),\r\n      id: newNodeId,\r\n    }\r\n  })\r\n\r\n  return {\r\n    nodes: newNodes,\r\n    links: newLinks\r\n      .filter((link) => link.inputUpdated && link.outputUpdated)\r\n      .map(({ inputUpdated, outputUpdated, ...link }) => ({ ...link })),\r\n  }\r\n}\r\n\r\n/*\r\n * 计算在屏幕范围的中心位置，在 画布内的坐标\r\n */\r\nexport const calculatePasteOriginCoordination = (transform: ITransform, panelDom: HTMLDivElement) => {\r\n  const { scale, translateX, translateY } = transform\r\n  const { width, height } = getNodeStyle(panelDom)\r\n\r\n  return {\r\n    x: -translateX / scale + width / scale / 3,\r\n    y: -translateY / scale + height / scale / 2,\r\n  }\r\n}\r\n\r\nexport const createSinglePasteValue = (originNode: INodeType): INodeType => {\r\n  const nodeData = cloneDeep(originNode)\r\n\r\n  return {\r\n    ...nodeData,\r\n    id: uuidv4(),\r\n    outputs: nodeData.outputs.map((output) => ({\r\n      id: uuidv4(),\r\n      isLinked: false,\r\n    })),\r\n    inputs: nodeData.outputs.map((input) => ({\r\n      id: uuidv4(),\r\n      isLinked: false,\r\n    })),\r\n    coordinates: [nodeData.coordinates[0] + 20, nodeData.coordinates[1] + 20],\r\n  }\r\n}\r\n","import React, { useCallback, useState, useRef } from 'react'\r\nimport { DiagramCanvas } from './DiagramCanvas'\r\nimport { NodesCanvas } from './NodesCanvas'\r\nimport { LinksCanvas } from './LinksCanvas'\r\nimport { Segment } from './Segment'\r\nimport './style.scss'\r\nimport {\r\n  IDiagramType,\r\n  ILinkType,\r\n  ISegmentType,\r\n  IPortRefs,\r\n  INodeRefs,\r\n  ITransform,\r\n  ICoordinateType,\r\n  NodeTypeEnum,\r\n  INodeType,\r\n} from '../../types'\r\nimport { isEqual } from 'lodash-es'\r\nimport useEventCallback from '../../hooks/useEventCallback'\r\nimport { batchUpdateCoordinates, calculatingCoordinates, findIndexById, oneNodeDelete } from '../../utils'\r\nimport { createNode } from '../NodeTypes/config'\r\n// import { MarkLine } from './MarkLine'\r\nimport { SelectModel } from './SelectModel'\r\nimport autoLayout, { autoLayoutAnimation, diffNodesCoordinates } from '../../utils/autoLayout'\r\nimport { EVENT_AUTO_LAYOUT } from '../../utils/eventBus'\r\nimport useEventBus from '../../hooks/useEventBus'\r\nimport { createSinglePasteValue } from '../../utils/copyPaste'\r\ninterface DiagramProps {\r\n  value: IDiagramType\r\n  onChange: (value: IDiagramType, notAddHistory?: boolean) => void\r\n  onAddHistory: (value: IDiagramType) => void\r\n  transform: ITransform\r\n  activeNodeIds: string[]\r\n  onToggleActiveNodeId: (nodeId: string) => void\r\n}\r\nconst STEP_COUNT = 60 // auto layout 动画执行总次数\r\n\r\nexport const Diagram: React.FC<DiagramProps> = React.memo((props) => {\r\n  const { value, onChange, onAddHistory, transform, activeNodeIds, onToggleActiveNodeId } = props\r\n  const [segment, setSegment] = useState<ISegmentType | undefined>()\r\n  const [selectModelPosition, setSelectModelPosition] = useState<ICoordinateType>()\r\n  const { current: portRefs } = useRef<IPortRefs>({}) // 保存所有 Port 的 Dom 节点\r\n  const { current: nodeRefs } = useRef<INodeRefs>({}) // 保存所有 Node 的 Dom 节点\r\n  const startPortIdRef = useRef<string>() // 保存所有 Node 的 Dom 节点\r\n  const isAutoLayoutRef = useRef<boolean>(false) // 保存所有 Node 的 Dom 节点\r\n\r\n  const handleNodePositionChange = useEventCallback((nodeId: string, nextCoordinates: ICoordinateType) => {\r\n    const nextNodes = batchUpdateCoordinates(nodeId, nextCoordinates, value.nodes, activeNodeIds)\r\n    onChange({ ...value, nodes: nextNodes }, true)\r\n  })\r\n\r\n  const handleNodeValueChange = useEventCallback((nodeId: string, nextNodeValue: any) => {\r\n    const nextNodes = [...value.nodes]\r\n    const index = findIndexById(nodeId, nextNodes)\r\n    nextNodes[index] = { ...nextNodes[index], data: nextNodeValue }\r\n    onChange({ ...value, nodes: nextNodes })\r\n  })\r\n\r\n  const handleAddHistory = useEventCallback((nodeId: string, nextCoordinates: ICoordinateType) => {\r\n    const nextNodes = batchUpdateCoordinates(nodeId, nextCoordinates, value.nodes, activeNodeIds)\r\n    onAddHistory({ ...value, nodes: nextNodes })\r\n  })\r\n\r\n  const handleNodeCopy = useEventCallback((nodeId: string) => {\r\n    const index = findIndexById(nodeId, value.nodes)\r\n    const newNode = createSinglePasteValue(value.nodes[index])\r\n    onChange({ ...value, nodes: [...value.nodes, newNode] })\r\n  })\r\n\r\n  const handleNodeDelete = useEventCallback((nodeId: string) => {\r\n    const nextValue = oneNodeDelete(value, nodeId)\r\n    onChange(nextValue)\r\n  })\r\n\r\n  // when a port is registered, save it to the local reference\r\n  const onPortRegister = useEventCallback((portId: string, portEl: HTMLElement) => {\r\n    portRefs[portId] = portEl\r\n  })\r\n\r\n  // when a node is registered, save it to the local reference\r\n  const onNodeRegister = useEventCallback((nodeId: string, nodeEl: HTMLDivElement) => {\r\n    // const rect = nodeEl.getBoundingClientRect()\r\n    nodeRefs[nodeId] = nodeEl\r\n  })\r\n\r\n  // when a new segment is dragged, save it to the local state\r\n  const onDragNewSegment = useCallback((portId, from, to) => {\r\n    setSegment({ id: `segment-${portId}`, from, to })\r\n  }, [])\r\n\r\n  // when a segment fails to connect, reset the segment state\r\n  const onSegmentFail = useCallback(() => {\r\n    setSegment(undefined)\r\n  }, [])\r\n\r\n  const onShowSelectModel = useEventCallback((event: MouseEvent, input: string) => {\r\n    startPortIdRef.current = input\r\n    setSelectModelPosition([event.clientX, event.clientY])\r\n    setSegment(undefined)\r\n  })\r\n\r\n  // when a segment connects, update the links schema, perform the onChange callback\r\n  // with the new data, then reset the segment state\r\n  const onSegmentConnect = useEventCallback((input: string, output: string) => {\r\n    const linkIsExists = value.links.findIndex((link) => link.input === input && link.output === output) > -1\r\n    if (!linkIsExists) {\r\n      const nextLinks = [...value.links, { input, output }]\r\n\r\n      onChange({ ...value, links: nextLinks })\r\n    }\r\n    setSegment(undefined)\r\n  })\r\n\r\n  // when links change, performs the onChange callback with the new incoming data\r\n  const onLinkDelete = useEventCallback((link: ILinkType) => {\r\n    const nextLinks = value.links.filter((item) => !isEqual(item, link))\r\n    onChange({ ...value, links: nextLinks })\r\n  })\r\n\r\n  const handleSelectModelChange = useEventCallback((nodeType?: NodeTypeEnum) => {\r\n    if (nodeType && selectModelPosition) {\r\n      const coordinates: ICoordinateType = calculatingCoordinates(\r\n        { clientX: selectModelPosition[0], clientY: selectModelPosition[1] } as MouseEvent,\r\n        document.getElementById('diagram-canvas'),\r\n        transform.scale\r\n      )\r\n      const newNode = createNode(nodeType, coordinates)\r\n      onChange({ ...value, nodes: [...value.nodes, newNode] })\r\n      // nodes 更新后 渲染 link\r\n      setTimeout(() => {\r\n        onSegmentConnect(startPortIdRef.current || '', newNode.id)\r\n      }, 20)\r\n    }\r\n    setSelectModelPosition(undefined)\r\n  })\r\n\r\n  const handleAutoLayout = useCallback(() => {\r\n    const nextValue = autoLayout(value, nodeRefs)\r\n    if (diffNodesCoordinates(value.nodes, nextValue.nodes) && !isAutoLayoutRef.current) {\r\n      const params = {\r\n        originNodes: value.nodes,\r\n        futureNodes: nextValue.nodes,\r\n        animationFn: (nodes: INodeType[]) => onChange({ ...nextValue, nodes: nodes }, true),\r\n        stepCount: STEP_COUNT,\r\n      }\r\n      isAutoLayoutRef.current = true\r\n\r\n      autoLayoutAnimation(params)\r\n        .then(() => {\r\n          onAddHistory(value) // 成功后把原始位置追加到历史记录\r\n        })\r\n        .finally(() => (isAutoLayoutRef.current = false))\r\n    }\r\n  }, [value, nodeRefs, onChange, onAddHistory, isAutoLayoutRef])\r\n\r\n  useEventBus({ type: EVENT_AUTO_LAYOUT, onChange: handleAutoLayout })\r\n\r\n  return (\r\n    <DiagramCanvas\r\n      portRefs={portRefs}\r\n      nodeRefs={nodeRefs}\r\n      transform={transform}\r\n      onDragNewSegment={onDragNewSegment}\r\n      onSegmentFail={onSegmentFail}\r\n      onSegmentConnect={onSegmentConnect}\r\n      onShowSelectModel={onShowSelectModel}\r\n      onPortMount={onPortRegister}\r\n    >\r\n      <NodesCanvas\r\n        nodes={value.nodes}\r\n        onNodeMount={onNodeRegister}\r\n        onNodePositionChange={handleNodePositionChange}\r\n        onNodeValueChange={handleNodeValueChange}\r\n        onNodeDelete={handleNodeDelete}\r\n        onNodeCopy={handleNodeCopy}\r\n        onAddHistory={handleAddHistory}\r\n        onToggleActiveNodeId={onToggleActiveNodeId}\r\n        activeNodeIds={activeNodeIds}\r\n      />\r\n      {value.links.length > 0 && <LinksCanvas nodes={value.nodes} links={value.links} onDelete={onLinkDelete} />}\r\n      {segment && <Segment segment={segment} />}\r\n      {/* <MarkLine onNodePositionChange={handleNodePositionChange} /> */}\r\n      <SelectModel position={selectModelPosition} onChange={handleSelectModelChange} />\r\n    </DiagramCanvas>\r\n  )\r\n})\r\n\r\nDiagram.displayName = 'Diagram'\r\n","import { useReducer, useCallback } from 'react'\r\nimport { IDiagramType } from '../types'\r\n\r\n// 初始化useReducer中的state\r\nconst initialState = {\r\n  // 当我们每次添加新state时，用来储存更新前状态的数组\r\n  past: [],\r\n  // 当前的state值\r\n  present: null,\r\n  // 让我们可以用使用重做功能的，future数组\r\n  future: [],\r\n}\r\n\r\n// 根据action处理state的改变\r\nconst reducer = (state: any, action: any) => {\r\n  const { past, present, future } = state\r\n  const { newPresent } = action\r\n\r\n  switch (action.type) {\r\n    case 'UNDO':\r\n      const previous = past[past.length - 1]\r\n      const newPast = past.slice(0, past.length - 1)\r\n\r\n      return {\r\n        past: newPast,\r\n        present: previous,\r\n        future: [present, ...future],\r\n      }\r\n    case 'REDO':\r\n      const next = future[0]\r\n      const newFuture = future.slice(1)\r\n\r\n      return {\r\n        past: [...past, present],\r\n        present: next,\r\n        future: newFuture,\r\n      }\r\n    case 'SET':\r\n      return {\r\n        past: [...past],\r\n        present: newPresent,\r\n        future: [],\r\n      }\r\n\r\n    case 'SET_WIDTH_HISTORY':\r\n      if (newPresent === present) {\r\n        return state\r\n      }\r\n      return {\r\n        past: [...past, present],\r\n        present: newPresent,\r\n        future: [],\r\n      }\r\n\r\n    case 'ADD_A_HISTORY':\r\n      if (newPresent === present) {\r\n        return state\r\n      }\r\n      return {\r\n        past: [...past, newPresent],\r\n        present: present,\r\n        future: [],\r\n      }\r\n\r\n    case 'CLEAR':\r\n      const { initialPresent } = action\r\n\r\n      return {\r\n        ...initialState,\r\n        present: initialPresent,\r\n      }\r\n  }\r\n}\r\n\r\n// Hook\r\nexport const useHistory = (initialPresent: IDiagramType) => {\r\n  const [state, dispatch] = useReducer(reducer, {\r\n    ...initialState,\r\n    present: initialPresent,\r\n  })\r\n\r\n  const canUndo = state.past.length !== 0\r\n  const canRedo = state.future.length !== 0\r\n\r\n  const undo = useCallback(() => {\r\n    if (canUndo) {\r\n      dispatch({ type: 'UNDO' })\r\n    }\r\n  }, [canUndo, dispatch])\r\n\r\n  const redo = useCallback(() => {\r\n    if (canRedo) {\r\n      dispatch({ type: 'REDO' })\r\n    }\r\n  }, [canRedo, dispatch])\r\n\r\n  // 只设置值 不追加历史记录 例如 移动 node的过程不需要记录\r\n  const set = useCallback((newPresent) => dispatch({ type: 'SET', newPresent }), [dispatch])\r\n\r\n  // 设置值 并且追加历史记录 例如 增加删除节点，修改节点data数据等\r\n  const setWithHistory = useCallback((newPresent) => dispatch({ type: 'SET_WIDTH_HISTORY', newPresent }), [dispatch])\r\n\r\n  // 仅追加一条历史记录不设置值 例如 节点移动后，把节点拖拽的起始位置 追加进入历史栈\r\n  const addAHistory = useCallback((newPresent) => dispatch({ type: 'ADD_A_HISTORY', newPresent }), [dispatch])\r\n\r\n  const clear = useCallback(() => dispatch({ type: 'CLEAR', initialPresent }), [dispatch, initialPresent])\r\n\r\n  return { present: state.present, set, setWithHistory, addAHistory, undo, redo, clear, canUndo, canRedo }\r\n}\r\n","import React from 'react'\r\n\r\nimport './style.scss'\r\nimport IconClick from '../../static/icon-click.png'\r\nimport IconMove from '../../static/icon-move.png'\r\nimport IconWheel from '../../static/icon-wheel.png'\r\nimport { isMac } from '../../utils'\r\n\r\nexport interface ShortcutsPanelProps {}\r\n\r\nconst CTRL_OR_CMD = isMac ? 'CMD' : 'Ctrl'\r\n// const ALT_OR_OPT = isMac ? 'OPT' : 'Alt'\r\n\r\nconst hotkeyList = [\r\n  { text: '撤销', hotKeys: [{ key: CTRL_OR_CMD }, { key: 'Z' }] },\r\n  { text: '多选', hotKeys: [{ key: 'Shift' }, { icon: IconClick }] },\r\n  { text: '重做', hotKeys: [{ key: CTRL_OR_CMD }, { key: 'Shift' }, { key: 'Z' }] },\r\n  { text: '全选', hotKeys: [{ key: CTRL_OR_CMD }, { key: 'A' }] },\r\n  { text: '复制', hotKeys: [{ key: CTRL_OR_CMD }, { key: 'C' }] },\r\n  { text: '缩放', hotKeys: [{ key: CTRL_OR_CMD }, { icon: IconWheel }] },\r\n  { text: '粘贴', hotKeys: [{ key: CTRL_OR_CMD }, { key: 'V' }] },\r\n  { text: '移动画布', hotKeys: [{ key: 'Space' }, { icon: IconMove }] },\r\n  { text: '删除', hotKeys: [{ key: 'Del' }] },\r\n  // { text: '自动排列', hotKeys: [{ key: CTRL_OR_CMD }, { key: 'Shift' }, { key: 'A' }] },\r\n]\r\n\r\nexport const ShortcutsPanel: React.FC<ShortcutsPanelProps> = React.memo(() => {\r\n  return (\r\n    <ul className=\"shortcuts-panel\">\r\n      {hotkeyList.map((item, index) => (\r\n        <li key={index} className=\"shortcuts-panel-item\">\r\n          <div className=\"shortcuts-panel-title\">{item.text} :</div>\r\n          <div className=\"shortcuts-panel-list\">\r\n            {item.hotKeys.map((keyItem, keyIndex) => (\r\n              <React.Fragment key={keyIndex}>\r\n                {keyIndex > 0 && <span className=\"shortcuts-panel-plus\">+</span>}\r\n                <div className=\"shortcuts-panel-key\">\r\n                  {keyItem.key}\r\n                  {keyItem.icon && <img className=\"shortcuts-panel-icon\" src={keyItem.icon} alt={item.text} />}\r\n                </div>\r\n              </React.Fragment>\r\n            ))}\r\n          </div>\r\n        </li>\r\n      ))}\r\n    </ul>\r\n  )\r\n})\r\n","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAE8ElEQVRoQ+2ZbWibVRTH/+c+6YugTKjMTVaoTBRBcFBRHCpVvw3FJmkc7sv8IO1sm3RTaZNqWdyHPunswCVrXQu6itjh0jRxU/ZpWFEYsk0niqK2UFDsVrYxcYy+5LlHbmpqDGlznydFWmy/tfe8/H/3nHse7i1hjf9QKfobAqHzyn8kaj5USpxSfIsC+Hw+Ix6PW4WSrHoAd0voGSHYOzd7reXU4ODNfIhVDeALh8v56kwKRBsl0zfzs1fa8iFWNYDa7fo9wRqjjAaIUCUZ56/9ObV3bGhoJluJVQ+QD8GSzonL5W3xeHhOra0JgByIo0S4QzKPjcYiry01Odx7Oh8QLmxj4hoibGCGC8zXSdAkW/SdMf3Lt0sNBSfTqOgUygZ9rvn16jIXH5YkzdHDkXO5ydSkkpu2Pg/gBSK6azkhDFwH4yNhVRyP94dvOBGd66MNoJwKjVR3c/v9hss4AODuQmKYuR+SbzCJGiKuI6KNyo4ZVyRgJmPm56VA2ALIT+RuDT4lBHUT4FpKRBrclIpGLmTX3c0djwlD+ImwdQGE+xOxyHtOIQoCZA9nftDcL25GiEv0Lide+ecDZCspN9/TRsCujA3zoVQsctwJhCMAz97OzWTJYSK6rVjSQgBZH28gtJsAPysGi5pH+7q/LhYvf91RC3kCoR4BPK2TbDkA5e8JdB4Q4B0MnhRTEzvtTijbAO6W0L2GgWEd8Uu10L8mWHP4VmnMnFLVTEvZlTrSc1o3trKzDeBtDQVJoEE3SbEKqDje1mAjCWpk4GIiar6kG9sZQCD0KQF36ibRAfD427cIMlIZQemKOjvfB1sV8DV2bOBKcUZXvE4LLR5ofyhJhGrLgj/ZZ57VzWELwO3veNAg8a5ucDsAnkAoKoDtsBAe6TM/0c1hC6A+EKx1gQZ0g9sCaA3uF4KeZSCWiJrv6+ZYhQA8mIhGBtcBCu1AtoXUR4csGtLZJQs4m+wzrxaz9Sy20H9QAQZfSEQjTcVE2VlfB9DZrZwWWq9A/oatt9D/q4UYE4mYuVMHWtdmsYUkm4kjkYSun60v8d8X+A+YcTMRM5/QTaJj520NDpCgWkjZNWLjTmALwLdv3y1sVX6hBFlz8zuSR3undcTp2Hj9wc/UpcYCvZiMdn+v4+P0PvAhAfcx86GEw4t4vrj6l4O1rjIaYNCsmCp/MvvypwNhqwIq4OLtifGruDTeYPcOW0iUxx/sFUR1EjgzGjU7dIRnbWwDuFtCVcKgkwSuWIkq5N4x0vPclHrnnzckHRDbAJkqBEKvqDcddZilZTUl+w/+qJMs32ZhM/gYQT1H0lcj0e4Wu3EcAajDLNOVw+oKmHkilAgk+8yf7STPiBfoVy90aiMY1q7R2MHf7MRwdIizCRb+d4BjanJkKgG87bo0/rHOmaj3tz9skLE/8zjAsCxLvprs7/nSrviSAJSzeiMSgmNEVKV+Z+AnCXnCNYOx+GDPH7mCfL5weXrT7KPE8AqB7Rn7BfCuUh54HbVQrjDVCobAGyA8nvt3Bi4T6HcQWyxxO4irCVSRtWHGDxbSb6Zib0042XnHU2ipZGqWizLaLRiPgGAsZaeEk8QJmh4/rdNuxeBKrkChycKwtgkyagDekulTommL5aSYMy6ODnZPFRNlZ33FAewkXwnbdYCV2MVSYqxXoJTdWwnfNV+BvwALEYtPTIIeoAAAAABJRU5ErkJggg==\"","export default \"data:image/png;base64,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\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAFiUlEQVRoQ+2Zf2hbVRTHzzkvbVNxWFEclQ4L/kJRLEwGGwjCZLAxMT8WpkNh+8N2tEnbqbRJEFfYTLLZuZH0hwuoFXQiaX6IIuyPgsoUNiwIE8fKKsrAlTFBmbq2y7tH7mtfeE1/vNs0td1o/0pz3zvnfO75nnPfO0G4xf/wFo8flAHcgc6nUDj+zPS+/dtqglYCkMETUAIA/mVBTasJwhbADB4R7pA7zwzXVhPEggDultA9SPAmIm9AwHoDAOAiM/yqOcYPp44fv7HScrLNgAxwV0toJ2jQJT/ngZty8djwSgdu+r/9AKTmWfC9ud6jQyalq6Vjq0bUJv8XSOFsPPKTueb1B73M2g8rVdgzMlDoNiySPKkZAJqj8nqqr+tvq2R8jZ136aAZRY1OfgkYtq1UYRcAiruNGTADJ9PxWNIK4PEHDxLh89bv7LqThE4lj/xV7topAOzyh+JAsKXYgSqA0aEEJ9M9saSnMVyLVbqLATchQD0iritsCMM1QDgvQJxx5KuHirO7WMACgO/AgWqhOxMI0MAAP7Lgy0ZQiF9nE9FvrIbdLZ0vIGKDISHCRxDgUcH8KWh0CnVoQ+TnZm8ETiBw1cys8XUAPEVjVR+lUl2Tiw3e8D9D2yaEDrnB3uiX5ppxHlTgA0ZNTFaOWHfN2xpsZIZ1LPAiEXSYB95cmaQrzoGbd/+zQaukzUC0XYJPH46XWFBnKY1gVhuVmchPOjdke6MjZhALnQOu/cF6qIDNDsTXF9rBuaToag5u0xzYhgDrmfm6QApYO5xKRpZ8DrhbQju16UNusQDyepldIu5GxCeNRqDhvsyJyBWV4GdJqPgm9/437kNnZR3qYgsi7p1ax25BMKLhjQs6V9egzp/NJ5sZep+jm5nrRv3lnQOI8CAzn08nYvvKAmAtbKtBWbCZROyYpzV0hAC2qjibS0LW+zzt4VoUMCgLXdehK2upwYXs20qoGKIQfKCjjlDLqQRvFOoCGTBteP3BRiSUTeFSOhF9UcW2LYA0YkIw8wW58/I7byD0KiI0qThRBXDtba9xrKs+DQiarsMeayOZz48SgAHh66q09mpvIPihLLxyAkhbnkCojxA2scAT6Z7Ix3b2lQGKDXkDoW9Vite8T0VCRmZbg40I2CgAv8rEI28tC4DMBtdOfG9nXLULWa8zzxwGHk7HY7YSLSkD8lmHnPzFcgC4WoMbHYAn1wAW2t3bKgOD8ejTi5GS3bX/u4TWAIpSspYBO40ap6Wlja5JaE1CKpopusb6KIHa+DPlnJHu8nduB6JDy3oSTz10hb+TLx/58fzuXPKd0RL2Yc5bvP7wy0jcLgQMZXqinXZ2S3oWmgIIfSKnCjqIQ9n4kc/tHKmuewLBbkJ8lhn70onIB3b3lQ7gD7ch8SuC4VwmEW22c6Sy7mvuulM4xk8jYFX+Jjfl+u2n4CUDuFvDT2jAAzIw1bcnOwjzLY+Z/6Cx0R2pVEq3u6dkAKuM5CSPrlxqUnE4X0ByAkIVFYPyJckcUdoFL9eXBCAHwhrS+9IQA5xKx6PvqjgtvmZ6rHISER5n4N9Jm9it2tmWBDCdhdcQYI8BwTxAY6P9i8mE1L3umDhBAA3AoOdBD+QSR8+pbsSSAXw+n6avfyhCZM6H8CzfFMfS/bFf7IJwt4Q2k8YhBLzfqCWGSDYRzdjdZ11fMoA0ZkDUPnyQgHdMyynPzGcE8xDm9eHse91XTaeeQEcdI24kRpc51WDACaFzVHWYVXYA06B8IWcN2hGgxuqEjd8G+Sri1E7PWGP4WQg4rDIDmiszZcmA1bDRy2nSBcSF8fksxwy6QDjLDOni3x4WI58ldyE7Z3LyDJp4TNOphpGrkHFCJ3HZ4ZgcUe0ydj7KngE7h+Vev+UB/gN5EApeyCXHVgAAAABJRU5ErkJggg==\"","import React, { useCallback } from 'react'\r\nimport { Button, Popover } from 'antd'\r\n\r\nimport './style.scss'\r\nimport eventBus, { EVENT_AUTO_LAYOUT } from '../../utils/eventBus'\r\nimport { ShortcutsPanel } from './ShortcutsPanel'\r\n\r\nexport interface ToolbarProps {\r\n  undo: () => void\r\n  redo: () => void\r\n  canUndo: boolean\r\n  canRedo: boolean\r\n  scale: number\r\n}\r\n\r\nexport const Toolbar: React.FC<ToolbarProps> = React.memo(({ undo, redo, canUndo, canRedo, scale }) => {\r\n  const handleAutoLayout = useCallback(() => {\r\n    eventBus.emit(EVENT_AUTO_LAYOUT)\r\n  }, [])\r\n\r\n  return (\r\n    <div className=\"toolbar\">\r\n      <Button disabled>{(scale * 100).toFixed(0)}%</Button>\r\n      <Button disabled={!canUndo} onClick={undo}>\r\n        撤销\r\n      </Button>\r\n      <Button disabled={!canRedo} onClick={redo}>\r\n        重做\r\n      </Button>\r\n      <Popover trigger=\"click\" placement=\"right\" content={<ShortcutsPanel />} overlayClassName=\"scale-popover\">\r\n        <Button>快捷键</Button>\r\n      </Popover>\r\n      <Button onClick={handleAutoLayout}>自动排列</Button>\r\n    </div>\r\n  )\r\n})\r\n","import React, { useCallback } from 'react'\r\n\r\nimport './style.scss'\r\n\r\nexport interface NodeListItemProps {\r\n  icon: React.FC\r\n  label: string\r\n  type: string\r\n}\r\n\r\nexport const NodeListItem: React.FC<NodeListItemProps> = React.memo(({ icon, label, type }) => {\r\n  const handleDragStart = useCallback(\r\n    (event: any) => {\r\n      event.dataTransfer?.setData('nodeType', type)\r\n    },\r\n    [type]\r\n  )\r\n  return (\r\n    <div className=\"node-list-item\" draggable onDragStart={handleDragStart}>\r\n      {icon && React.createElement(icon)}\r\n      <div className=\"node-list-text\">{label}</div>\r\n    </div>\r\n  )\r\n})\r\n\r\nNodeListItem.displayName = 'NodeListItem'\r\n","import React, { memo } from 'react'\r\nimport './style.scss'\r\nimport { NodeListItem } from './NodeListItem'\r\nimport { nodesList } from '../NodeTypes/config'\r\n\r\nexport interface NodeListProps {}\r\n\r\nexport const NodeList: React.FC<NodeListProps> = memo(() => {\r\n  return (\r\n    <div className=\"node-list\">\r\n      {nodesList.map((node) => (\r\n        <NodeListItem key={node.type} icon={node.icon} type={node.type} label={node.label} />\r\n      ))}\r\n    </div>\r\n  )\r\n})\r\n\r\nNodeList.displayName = 'NodeList'\r\n","import { useEffect, useRef } from 'react'\r\n\r\nfunction useEventListener(\r\n  eventName: string,\r\n  handler: (event?: any) => void,\r\n  element?: Window | Document | HTMLElement | HTMLDivElement | null,\r\n  options?: any\r\n) {\r\n  // 创建一个储存处理方法的ref\r\n  const savedHandler = useRef<any>()\r\n  const target = element || document\r\n\r\n  // 当处理函数改变的时候更新ref.current的方法\r\n  // 这样可以使我们的总是获取到最新的处理函数\r\n  // 并且不需要在它的effect依赖数组中传递\r\n  // 并且避免有可能每次渲染重新引起effect方法\r\n  useEffect(() => {\r\n    savedHandler.current = handler\r\n  }, [handler])\r\n\r\n  useEffect(\r\n    () => {\r\n      // 确认是否支持addEventListener\r\n      const isSupported = target && target.addEventListener\r\n      if (!isSupported) return\r\n\r\n      // 创建一个调用储存在ref中函数的事件监听\r\n      const eventListener = (event: any) => savedHandler.current(event)\r\n\r\n      // 添加事件监听\r\n      target.addEventListener(eventName, eventListener, options)\r\n\r\n      // 在cleanup的回调中，清除事件监听\r\n      return () => {\r\n        target.removeEventListener(eventName, eventListener)\r\n      }\r\n    },\r\n    [eventName, target, options] // 当元素或者绑定事件改变时，重新运行\r\n  )\r\n}\r\nexport default useEventListener\r\n","export const SCALE_STEP = 0.05\r\n\r\nexport const DRAG_STATE = {\r\n  DEFAULT: 'DEFAULT',\r\n  START: 'START',\r\n  MOVE: 'MOVE',\r\n  END: 'END',\r\n  SELECTION: 'SELECTION',\r\n}\r\n\r\nexport const CURSOR_MAP = {\r\n  [DRAG_STATE.DEFAULT]: 'default',\r\n  [DRAG_STATE.SELECTION]: 'default',\r\n  [DRAG_STATE.START]: 'grab',\r\n  [DRAG_STATE.MOVE]: 'grabbing',\r\n}\r\n","import { IDiagramType } from '../types'\r\n\r\nexport const defaultValue: IDiagramType = {\r\n  links: [\r\n    { input: 'port-1', output: 'node-2' },\r\n    { input: 'port-1', output: 'ebac3f07-598e-4e2f-9e81-e67e542322d8' },\r\n    { input: 'node-5-port-1', output: 'node-2' },\r\n    { input: 'node-1-port-1', output: 'node-5' },\r\n    { input: 'node-5-port-2', output: 'node-4' },\r\n    { input: 'node-4-port-3', output: 'node-3' },\r\n  ],\r\n  nodes: [\r\n    {\r\n      id: 'node-1',\r\n      coordinates: [100, 100],\r\n      inputs: [],\r\n      outputs: [{ id: 'node-1-port-1', isLinked: true }],\r\n      type: 'nodeTypeSingleOutputs',\r\n      data: { inputValue: 'defaultValue' },\r\n    },\r\n    {\r\n      id: 'node-2',\r\n      coordinates: [600, 100],\r\n      type: 'nodeTypeSingleInputs',\r\n      inputs: [{ id: 'node-2-port-1', isLinked: false }],\r\n      outputs: [],\r\n      data: { inputValue: 'test' },\r\n    },\r\n    {\r\n      id: 'node-3',\r\n      coordinates: [850, 297],\r\n      type: 'nodeTypeNoInputOutput',\r\n      inputs: [],\r\n      outputs: [],\r\n      data: { inputValue: 'test' },\r\n    },\r\n    {\r\n      id: 'node-4',\r\n      coordinates: [600, 297],\r\n      type: 'nodeTypeMultipleInputsOutputs',\r\n      inputs: [\r\n        { id: 'node-4-port-1', isLinked: false },\r\n        { id: 'node-4-port-2', isLinked: false },\r\n      ],\r\n      outputs: [\r\n        { id: 'node-4-port-3', isLinked: false },\r\n        { id: 'node-4-port-4', isLinked: false },\r\n        { id: 'node-4-port-5', isLinked: false },\r\n      ],\r\n      data: { inputValue: 'test' },\r\n    },\r\n    {\r\n      id: 'node-5',\r\n      coordinates: [350, 100],\r\n      type: 'nodeTypeCustomRenderPort',\r\n      inputs: [],\r\n      outputs: [\r\n        { id: 'node-5-port-1', isLinked: false },\r\n        { id: 'node-5-port-2', isLinked: false },\r\n      ],\r\n      data: {\r\n        branchList: [\r\n          { text: 'button-1', id: 'd0ce404a' },\r\n          { text: 'button-2', id: '1751249f' },\r\n        ],\r\n      },\r\n    },\r\n  ],\r\n}\r\n\r\nconst manyNode: any = new Array(1000).fill({}).map((item, index) => {\r\n  return {\r\n    id: 'node-' + index,\r\n    coordinates: [index * 40 + 200, index * 50],\r\n    inputs: [],\r\n    outputs: [{ id: 'port-' + index, isLinked: false }],\r\n    type: 'nodeTypeInput',\r\n    data: {\r\n      inputValue: 'defaultValue',\r\n    },\r\n  }\r\n})\r\n\r\nconst manyLink = new Array(999).fill({}).map((item, index) => {\r\n  return { input: 'port-' + index, output: 'node-' + (index + 1) }\r\n})\r\n\r\nexport const bigDataValue = {\r\n  nodes: manyNode,\r\n  links: manyLink,\r\n}\r\n","import React, { useCallback, useMemo, useRef, useState, memo } from 'react'\r\nimport { Diagram } from './components/Diagram'\r\nimport { useHistory } from './hooks/useHistory'\r\nimport { Toolbar } from './components/Toolbar/Toolbar'\r\nimport { NodeList } from './components/NodeList/NodeList'\r\nimport { IDiagramType, ICoordinateType, IMousePosition, ITransform, ISelectionArea } from './types'\r\nimport { createNode } from './components/NodeTypes/config'\r\nimport { throttle } from 'lodash-es'\r\nimport hotkeys from 'hotkeys-js'\r\nimport {\r\n  calculatingCoordinates,\r\n  checkIsFocusInPanel,\r\n  checkMouseDownTargetIsDrawPanel,\r\n  checkWheelDirection,\r\n  collideCheck,\r\n  isCtrlOrCommandPress,\r\n  oneNodeDelete,\r\n} from './utils'\r\nimport { useHotkeys } from 'react-hotkeys-hook'\r\nimport useEventCallback from './hooks/useEventCallback'\r\nimport useEventListener from './hooks/useEventListener'\r\nimport { HOT_KEY_DEL, HOT_KEY_REDO, HOT_KEY_SELECT_ALL, HOT_KEY_SPACE, HOT_KEY_UNDO } from './constant/hotKeys'\r\nimport { CURSOR_MAP, DRAG_STATE, SCALE_STEP } from './constant'\r\nimport { defaultValue } from './utils/creatMockData'\r\nimport { calculatePasteOriginCoordination, createCopyValue, createPasteValue } from './utils/copyPaste'\r\n// import { useThrottleFn } from 'react-use'\r\n\r\nfunction DiagramPanel() {\r\n  const {\r\n    present,\r\n    set,\r\n    setWithHistory,\r\n    addAHistory,\r\n    undo: handleUndo,\r\n    redo: handleRedo,\r\n    canUndo,\r\n    canRedo,\r\n  } = useHistory(defaultValue)\r\n\r\n  const value = present as IDiagramType\r\n  const [transform, setTransform] = useState<ITransform>({\r\n    scale: 1,\r\n    translateX: 0,\r\n    translateY: 0,\r\n  })\r\n  const [selectionArea, setSelectionArea] = useState<ISelectionArea | undefined>()\r\n  const [dragState, setDragState] = useState<string>(DRAG_STATE.DEFAULT)\r\n  const mouseDownStartPosition = useRef<IMousePosition | undefined>()\r\n  const [activeNodeIds, setActiveNodeIds] = useState<string[]>([])\r\n\r\n  const panelRef = useRef<HTMLDivElement>(null)\r\n  const selectionAreaRef = useRef<HTMLDivElement>(null)\r\n\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  const panelRect = useMemo(() => panelRef.current?.getBoundingClientRect() || { x: 0, y: 0 }, [panelRef.current])\r\n\r\n  // eslint-disable-next-line\r\n  const handleThrottleSetTransform = useCallback(\r\n    throttle((transform) => {\r\n      setTransform(transform)\r\n    }, 20),\r\n    [setTransform]\r\n  )\r\n\r\n  const handleChange = useCallback(\r\n    (newValue: IDiagramType, notAddHistory?: boolean) => {\r\n      if (notAddHistory) {\r\n        set(newValue)\r\n      } else {\r\n        setWithHistory(newValue)\r\n      }\r\n    },\r\n    [set, setWithHistory]\r\n  )\r\n\r\n  const handleAddHistory = useCallback(\r\n    (newValue: IDiagramType) => {\r\n      addAHistory(newValue)\r\n    },\r\n    [addAHistory]\r\n  )\r\n\r\n  const handleDrop = useCallback(\r\n    (event: any) => {\r\n      if (event) {\r\n        event = window.event\r\n      }\r\n      const nodeType = event.dataTransfer.getData('nodeType')\r\n\r\n      const coordinates: ICoordinateType = calculatingCoordinates(\r\n        event,\r\n        document.getElementById('diagram-canvas'),\r\n        transform.scale\r\n      )\r\n\r\n      const newNode = createNode(nodeType, coordinates)\r\n      handleChange({ ...value, nodes: [...value.nodes, newNode] })\r\n    },\r\n    [handleChange, transform, value]\r\n  )\r\n\r\n  const handleDrag = useCallback((e: any) => {\r\n    e.preventDefault()\r\n  }, [])\r\n\r\n  // 控制滚轮缩放\r\n  const handlePanelScale = useEventCallback((event: any) => {\r\n    const { wheelDown, wheelUp } = checkWheelDirection(event)\r\n\r\n    let { scale, translateX, translateY } = transform\r\n\r\n    const offsetX = ((event.clientX - panelRect.x - translateX) * SCALE_STEP) / scale\r\n    const offsetY = ((event.clientY - panelRect.y - translateY) * SCALE_STEP) / scale\r\n\r\n    if (wheelDown) {\r\n      scale = scale - SCALE_STEP\r\n      translateX = translateX + offsetX\r\n      translateY = translateY + offsetY\r\n    }\r\n    if (wheelUp) {\r\n      scale = scale + SCALE_STEP\r\n      translateX = translateX - offsetX\r\n      translateY = translateY - offsetY\r\n    }\r\n\r\n    if (scale > 1 || scale < 0.1) return\r\n\r\n    setTransform({\r\n      scale: Number(scale.toFixed(2)),\r\n      translateX,\r\n      translateY,\r\n    })\r\n  })\r\n\r\n  // 控制滚轮移动画布\r\n  const handlePanelTranslate = useEventCallback((event: any) => {\r\n    const { deltaY } = checkWheelDirection(event)\r\n\r\n    let { translateX, translateY } = transform\r\n\r\n    if (hotkeys.shift) {\r\n      translateX = translateX - deltaY / 2\r\n    } else {\r\n      translateY = translateY - deltaY / 2\r\n    }\r\n\r\n    setTransform({\r\n      ...transform,\r\n      translateX,\r\n      translateY,\r\n    })\r\n  })\r\n\r\n  const handleWheel = useEventCallback((event: any) => {\r\n    if (!event) event = window.event\r\n    console.log('鼠标滚轮事件触发')\r\n    if (panelRef.current?.contains(event.target)) {\r\n      event.returnValue = false\r\n      console.log('isCtrlOrCommandPress=>', isCtrlOrCommandPress())\r\n\r\n      if (isCtrlOrCommandPress()) {\r\n        handlePanelScale(event)\r\n      } else {\r\n        handlePanelTranslate(event)\r\n      }\r\n    }\r\n  })\r\n\r\n  const handleMouseDown = useEventCallback((event) => {\r\n    mouseDownStartPosition.current = {\r\n      x: event.clientX,\r\n      y: event.clientY,\r\n      relativeX: event.clientX - transform.translateX,\r\n      relativeY: event.clientY - transform.translateY,\r\n    }\r\n    if (checkMouseDownTargetIsDrawPanel(event, panelRef.current)) {\r\n      if (dragState === DRAG_STATE.START) {\r\n        setDragState(DRAG_STATE.MOVE)\r\n      } else {\r\n        setDragState(DRAG_STATE.SELECTION)\r\n        setActiveNodeIds([])\r\n      }\r\n    }\r\n  })\r\n\r\n  // eslint-disable-next-line\r\n  const handleThrottleSetSelectionArea = useCallback(\r\n    throttle((e) => {\r\n      if (mouseDownStartPosition.current && panelRef.current) {\r\n        // const panelRect = panelRef.current.getBoundingClientRect()\r\n        setSelectionArea({\r\n          left: Math.min(e.clientX, mouseDownStartPosition.current.x) - panelRect.x,\r\n          top: Math.min(e.clientY, mouseDownStartPosition.current.y) - panelRect.y,\r\n          width: Math.abs(e.clientX - mouseDownStartPosition.current.x),\r\n          height: Math.abs(e.clientY - mouseDownStartPosition.current.y),\r\n        })\r\n        const selectAreaDom = selectionAreaRef.current\r\n        const activeNodeIds = value.nodes\r\n          .map((v) => v.id)\r\n          .filter((id) => {\r\n            return collideCheck(selectAreaDom, document.getElementById(id))\r\n          })\r\n\r\n        setActiveNodeIds(activeNodeIds)\r\n      }\r\n    }, 20),\r\n    [transform, value]\r\n  )\r\n\r\n  const handleMouseUp = useEventCallback((event) => {\r\n    if (dragState === DRAG_STATE.MOVE) {\r\n      setDragState(DRAG_STATE.START)\r\n    } else {\r\n      setDragState(DRAG_STATE.DEFAULT)\r\n    }\r\n    setSelectionArea(undefined)\r\n    mouseDownStartPosition.current = undefined\r\n  })\r\n\r\n  const handleMouseMove = useEventCallback((event) => {\r\n    if (dragState === DRAG_STATE.MOVE && mouseDownStartPosition.current) {\r\n      handleThrottleSetTransform({\r\n        ...transform,\r\n        translateX: event.clientX - mouseDownStartPosition.current.relativeX,\r\n        translateY: event.clientY - mouseDownStartPosition.current.relativeY,\r\n      })\r\n    }\r\n\r\n    if (dragState === DRAG_STATE.SELECTION) {\r\n      handleThrottleSetSelectionArea(event)\r\n    }\r\n  })\r\n\r\n  const handleSpaceHotKey = useEventCallback((event: KeyboardEvent) => {\r\n    if (event.type === 'keydown' && dragState === DRAG_STATE.DEFAULT) {\r\n      setDragState(DRAG_STATE.START)\r\n    }\r\n    if (event.type === 'keyup') {\r\n      setDragState(DRAG_STATE.DEFAULT)\r\n    }\r\n  })\r\n\r\n  const handleSelectAll = useEventCallback((event: KeyboardEvent) => {\r\n    if (checkIsFocusInPanel(panelRef.current)) {\r\n      event.preventDefault()\r\n      setActiveNodeIds(value.nodes.map((node) => node.id))\r\n    }\r\n  })\r\n\r\n  const handleBatchDelete = useEventCallback(() => {\r\n    if (checkIsFocusInPanel(panelRef.current) && activeNodeIds.length) {\r\n      let nextValue = { ...value }\r\n      activeNodeIds.forEach((nodeId) => {\r\n        nextValue = oneNodeDelete(nextValue, nodeId)\r\n      })\r\n      handleChange(nextValue)\r\n    }\r\n  })\r\n\r\n  const handleBatchCopy = useEventCallback((event: React.ClipboardEvent) => {\r\n    if (checkIsFocusInPanel(panelRef.current) && activeNodeIds.length) {\r\n      event.preventDefault()\r\n      // activeNodeIds\r\n      const originCopyData = createCopyValue(value, activeNodeIds)\r\n\r\n      event.clipboardData.setData('text/json', JSON.stringify(originCopyData))\r\n    }\r\n  })\r\n\r\n  const handleBatchPaste = useEventCallback((event: React.ClipboardEvent) => {\r\n    if (checkIsFocusInPanel(panelRef.current)) {\r\n      event.preventDefault()\r\n      // 计算 node 粘贴的偏移量\r\n      const pasteOffset = panelRef.current\r\n        ? calculatePasteOriginCoordination(transform, panelRef.current)\r\n        : { x: 20, y: 20 }\r\n\r\n      const pasteString = event.clipboardData.getData('text/json')\r\n      if (pasteString) {\r\n        const newValue = createPasteValue(JSON.parse(pasteString), pasteOffset)\r\n\r\n        handleChange({ links: [...value.links, ...newValue.links], nodes: [...value.nodes, ...newValue.nodes] })\r\n      }\r\n    }\r\n  })\r\n\r\n  const handleToggleActiveNodeId = useEventCallback((nodeId: string) => {\r\n    let nextActiveNodeIds = [...activeNodeIds]\r\n    const findIndex = nextActiveNodeIds.findIndex((activeNodeId) => activeNodeId === nodeId)\r\n    if (findIndex > -1) {\r\n      nextActiveNodeIds.splice(findIndex, 1)\r\n    } else {\r\n      nextActiveNodeIds = [...nextActiveNodeIds, nodeId]\r\n    }\r\n    setActiveNodeIds(nextActiveNodeIds)\r\n  })\r\n\r\n  const cursor = useMemo(() => {\r\n    return CURSOR_MAP[dragState]\r\n  }, [dragState])\r\n\r\n  const hideSelectionArea = useMemo(() => dragState !== DRAG_STATE.SELECTION, [dragState])\r\n\r\n  const selectionAreaStyled = useMemo(\r\n    () => ({\r\n      left: selectionArea?.left,\r\n      top: selectionArea?.top,\r\n      width: selectionArea?.width,\r\n      height: selectionArea?.height,\r\n    }),\r\n    [selectionArea]\r\n  )\r\n\r\n  /*\r\n   * bind some hotkeys\r\n   */\r\n  useHotkeys(HOT_KEY_UNDO, handleUndo, {}, [handleUndo])\r\n  useHotkeys(HOT_KEY_REDO, handleRedo, {}, [handleRedo])\r\n  useHotkeys(HOT_KEY_SELECT_ALL, handleSelectAll, {}, [handleSelectAll])\r\n  useHotkeys(HOT_KEY_DEL, handleBatchDelete, {}, [handleBatchDelete])\r\n  useHotkeys(HOT_KEY_SPACE, handleSpaceHotKey, { keyup: true, keydown: true }, [handleSpaceHotKey])\r\n\r\n  useEventListener('wheel', handleWheel, null, { passive: false })\r\n\r\n  useEventListener('mouseup', handleMouseUp)\r\n  useEventListener('mousemove', handleMouseMove)\r\n  useEventListener('mousedown', handleMouseDown)\r\n\r\n  useEventListener('copy', handleBatchCopy)\r\n  useEventListener('paste', handleBatchPaste)\r\n\r\n  return (\r\n    <>\r\n      <div\r\n        id=\"diagram-panel\"\r\n        ref={panelRef}\r\n        className=\"diagram-panel\"\r\n        onDrop={handleDrop}\r\n        onDragEnter={handleDrag}\r\n        onDragOver={handleDrag}\r\n        tabIndex={1}\r\n        style={{ cursor }}\r\n      >\r\n        <Diagram\r\n          value={value}\r\n          transform={transform}\r\n          onChange={handleChange}\r\n          onAddHistory={handleAddHistory}\r\n          activeNodeIds={activeNodeIds}\r\n          onToggleActiveNodeId={handleToggleActiveNodeId}\r\n        />\r\n        <div\r\n          ref={selectionAreaRef}\r\n          className=\"diagram-selection-area\"\r\n          hidden={hideSelectionArea}\r\n          style={selectionAreaStyled}\r\n        />\r\n      </div>\r\n      <Toolbar undo={handleUndo} redo={handleRedo} canUndo={canUndo} scale={transform.scale} canRedo={canRedo} />\r\n      <NodeList />\r\n    </>\r\n  )\r\n}\r\n\r\nexport default memo(DiagramPanel)\r\n","export const HOT_KEY_UNDO = 'ctrl+z, cmd+z'\r\nexport const HOT_KEY_REDO = 'ctrl+shift+z, cmd+shift+z'\r\nexport const HOT_KEY_SELECT_ALL = 'ctrl+a, cmd+a'\r\nexport const HOT_KEY_DEL = 'del, backspace'\r\nexport const HOT_KEY_AUTO_LAYOUT = 'ctrl+shift+a, cmd+shift+a'\r\nexport const HOT_KEY_SPACE = 'space'\r\n","import { ReportHandler } from 'web-vitals';\r\n\r\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\r\n  if (onPerfEntry && onPerfEntry instanceof Function) {\r\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\r\n      getCLS(onPerfEntry);\r\n      getFID(onPerfEntry);\r\n      getFCP(onPerfEntry);\r\n      getLCP(onPerfEntry);\r\n      getTTFB(onPerfEntry);\r\n    });\r\n  }\r\n};\r\n\r\nexport default reportWebVitals;\r\n","import React from 'react'\r\nimport ReactDOM from 'react-dom'\r\nimport './index.css'\r\nimport DiagramPanel from './DiagramPanel'\r\nimport reportWebVitals from './reportWebVitals'\r\n\r\nReactDOM.render(\r\n  <React.StrictMode>\r\n    <DiagramPanel />\r\n  </React.StrictMode>,\r\n  document.getElementById('root')\r\n)\r\n\r\n// If you want to start measuring performance in your app, pass a function\r\n// to log results (for example: reportWebVitals(console.log))\r\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\r\nreportWebVitals()\r\n"],"sourceRoot":""}